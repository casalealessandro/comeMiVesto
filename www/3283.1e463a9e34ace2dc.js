"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3283],{3283:(Ma,ar,Y)=>{Y.d(ar,{d:()=>Dn});var Ne=Y(467),ht=Y(3953),_e=Y(6354),We=Y(3207),Nt=Y(8079),vt=Y(1445),Cn=Y(4742);let Dn=(()=>{var dt;class cn{constructor(ie,Ae,Ee){this.firestore=ie,this.storage=Ae,this.alertController=Ee,this.batchSize=20,this.lastDocument=null,this.resultsSignal=(0,ht.vPA)([])}getFormFields(ie){return this.firestore.collection("forms").doc(ie).valueChanges().pipe((0,_e.T)(Ae=>JSON.parse(Ae.json)))}getOutfits(ie){this.firestore.collection("outfits").ref.where("tags","array-contains",[{outfitSubCategory:"SNK"}]).get().then(Ee=>{Ee.forEach(ue=>{console.log(ue," => ",ue.data())})})}getUserProfilebyId(ie){return this.firestore.collection("users").doc(ie).valueChanges().pipe((0,_e.T)(Ee=>Ee))}getFilteredCollection(ie,Ae,Ee){var ue=this;return(0,Ne.A)(function*(){let ge=ue.firestore.collection(ie).ref;Ae&&Ae.forEach(ve=>{ge=ge.where(ve.field,ve.operator,ve.value)}),Ee&&Ee.forEach(ve=>{ge=ge.orderBy(ve.field,ve.by)});try{const kt=(yield ge.get()).docs.map(Re=>Re.data());return ue.resultsSignal.set(kt),kt}catch(ve){return console.error("Error getting filtered collection:",ve),[]}})()}getFilteredOutfits(ie){var Ae=this;return(0,Ne.A)(function*(){const Ee=Ae.firestore.collection("outfits").ref;if(0==ie.length)try{const At=(yield Ee.get()).docs.map(O=>O.data());return Ae.resultsSignal.set(At),At}catch(Re){return console.error("Error getting filtered collection:",Re),[]}const ue=[],ge=ie.filter(Re=>"=="===Re.operator),ve=ie.filter(Re=>"array-contains-any"===Re.operator);ge.length>0&&ge.forEach(Re=>{const At=Ee.where(Re.field,Re.operator,Re.value);ue.push(At.get())}),ve.forEach(Re=>{const At=Ee.where(Re.field,Re.operator,Re.value);ue.push(At.get())});try{const Re=yield Promise.all(ue);let At=[];return Re.forEach(Ut=>{Ut.docs.forEach(kn=>{At.push(kn.data())})}),Array.from(new Set(At.map(Ut=>Ut.id))).map(Ut=>At.find(kn=>kn.id===Ut))}catch(Re){return console.error("Error getting filtered collection: ",Re),[]}})()}saveInCollection(ie,Ae,Ee){var ue=this;return(0,Ne.A)(function*(){try{const ge=yield ue.firestore.collection(ie);return Ae?(ue.getFilteredCollection(ie,[]),ge.doc(Ae).set(Ee),!0):(ge.add(Ee),ue.getFilteredCollection(ie,[]),!0)}catch(ge){return yield(yield ue.alertController.create({header:"Attenzione",subHeader:"",message:`Errore durante il salvataggio del documento:, ${ge}`,buttons:["OK"]})).present(),!1}})()}updateInCollection(ie,Ae,Ee){var ue=this;return(0,Ne.A)(function*(){try{return ue.firestore.collection(ie).doc(Ae).update(Ee),ue.getFilteredCollection(ie),!0}catch{return!1}})()}deleteDocuments(ie,Ae){var Ee=this;return(0,Ne.A)(function*(){let ue=Ee.firestore.collection(ie).ref;Ae.forEach(ge=>{ue=ue.where(ge.field,ge.operator,ge.value)});try{const ve=(yield ue.get()).docs.map(kt=>kt.ref.delete());return yield Promise.all(ve),Ee.getFilteredCollection(ie),!0}catch(ge){return console.error("Error deleting documents:",ge),!1}})()}uploadImage(ie,Ae,Ee){var ue=this;return(0,Ne.A)(function*(){const ge=ue.storage.ref(Ae),kt=ue.storage.upload(Ae,ie,{contentType:Ee});try{return yield kt,yield(0,We.s)(ge.getDownloadURL())}catch(Re){throw new Error("Errore durante il caricamento dell'immagine: "+Re)}})()}}return(dt=cn).\u0275fac=function(ie){return new(ie||dt)(ht.KVO(Nt.Qe),ht.KVO(vt.ap),ht.KVO(Cn.hG))},dt.\u0275prov=ht.jDH({token:dt,factory:dt.\u0275fac,providedIn:"root"}),cn})()},3207:(Ma,ar,Y)=>{Y.d(ar,{s:()=>ht});var Ne=Y(9350);function ht(_e,We){const Nt="object"==typeof We;return new Promise((vt,Cn)=>{let dt,Dn=!1;_e.subscribe({next:cn=>{dt=cn,Dn=!0},error:Cn,complete:()=>{Dn?vt(dt):Nt?vt(We.defaultValue):Cn(new Ne.G)}})})}},8079:(Ma,ar,Y)=>{Y.d(ar,{Qe:()=>by});var Ne=Y(9842),ht=Y(177),_e=Y(3953),We=Y(1825),Nt=Y(9253),vt=Y(1182),Cn=Y(3236),Dn=Y(1985),dt=Y(8455),cn=Y(7673),Nn=Y(9172),ie=Y(9974),Ae=Y(4360);function Ee(){return(0,ie.N)((r,e)=>{let t,n=!1;r.subscribe((0,Ae._)(e,i=>{const s=t;t=i,n&&e.next([s,i]),n=!0}))})}var hn,Ks,ue=Y(6354),ge=Y(2816),ve=Y(3294),kt=Y(5964),At=(Y(2438),Y(3345)),O=Y(467),Ut=Y(7852),kn=Y(1362),fe=Y(8041),ee=Y(1076),qr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Gr={};(function(){var r;function n(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function i(R,I,A){A||(A=0);var P=Array(16);if("string"==typeof I)for(var S=0;16>S;++S)P[S]=I.charCodeAt(A++)|I.charCodeAt(A++)<<8|I.charCodeAt(A++)<<16|I.charCodeAt(A++)<<24;else for(S=0;16>S;++S)P[S]=I[A++]|I[A++]<<8|I[A++]<<16|I[A++]<<24;var C=R.g[3],v=(I=R.g[0])+(C^(A=R.g[1])&((S=R.g[2])^C))+P[0]+3614090360&4294967295;v=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=(A=(S=(C=(I=A+(v<<7&4294967295|v>>>25))+((v=C+(S^I&(A^S))+P[1]+3905402710&4294967295)<<12&4294967295|v>>>20))+((v=S+(A^C&(I^A))+P[2]+606105819&4294967295)<<17&4294967295|v>>>15))+((v=A+(I^S&(C^I))+P[3]+3250441966&4294967295)<<22&4294967295|v>>>10))+((v=I+(C^A&(S^C))+P[4]+4118548399&4294967295)<<7&4294967295|v>>>25))+((v=C+(S^I&(A^S))+P[5]+1200080426&4294967295)<<12&4294967295|v>>>20))+((v=S+(A^C&(I^A))+P[6]+2821735955&4294967295)<<17&4294967295|v>>>15))+((v=A+(I^S&(C^I))+P[7]+4249261313&4294967295)<<22&4294967295|v>>>10))+((v=I+(C^A&(S^C))+P[8]+1770035416&4294967295)<<7&4294967295|v>>>25))+((v=C+(S^I&(A^S))+P[9]+2336552879&4294967295)<<12&4294967295|v>>>20))+((v=S+(A^C&(I^A))+P[10]+4294925233&4294967295)<<17&4294967295|v>>>15))+((v=A+(I^S&(C^I))+P[11]+2304563134&4294967295)<<22&4294967295|v>>>10))+((v=I+(C^A&(S^C))+P[12]+1804603682&4294967295)<<7&4294967295|v>>>25))+((v=C+(S^I&(A^S))+P[13]+4254626195&4294967295)<<12&4294967295|v>>>20))+((v=S+(A^C&(I^A))+P[14]+2792965006&4294967295)<<17&4294967295|v>>>15))+((v=A+(I^S&(C^I))+P[15]+1236535329&4294967295)<<22&4294967295|v>>>10))+((v=I+(S^C&(A^S))+P[1]+4129170786&4294967295)<<5&4294967295|v>>>27))+((v=C+(A^S&(I^A))+P[6]+3225465664&4294967295)<<9&4294967295|v>>>23))+((v=S+(I^A&(C^I))+P[11]+643717713&4294967295)<<14&4294967295|v>>>18))+((v=A+(C^I&(S^C))+P[0]+3921069994&4294967295)<<20&4294967295|v>>>12))+((v=I+(S^C&(A^S))+P[5]+3593408605&4294967295)<<5&4294967295|v>>>27))+((v=C+(A^S&(I^A))+P[10]+38016083&4294967295)<<9&4294967295|v>>>23))+((v=S+(I^A&(C^I))+P[15]+3634488961&4294967295)<<14&4294967295|v>>>18))+((v=A+(C^I&(S^C))+P[4]+3889429448&4294967295)<<20&4294967295|v>>>12))+((v=I+(S^C&(A^S))+P[9]+568446438&4294967295)<<5&4294967295|v>>>27))+((v=C+(A^S&(I^A))+P[14]+3275163606&4294967295)<<9&4294967295|v>>>23))+((v=S+(I^A&(C^I))+P[3]+4107603335&4294967295)<<14&4294967295|v>>>18))+((v=A+(C^I&(S^C))+P[8]+1163531501&4294967295)<<20&4294967295|v>>>12))+((v=I+(S^C&(A^S))+P[13]+2850285829&4294967295)<<5&4294967295|v>>>27))+((v=C+(A^S&(I^A))+P[2]+4243563512&4294967295)<<9&4294967295|v>>>23))+((v=S+(I^A&(C^I))+P[7]+1735328473&4294967295)<<14&4294967295|v>>>18))+((v=A+(C^I&(S^C))+P[12]+2368359562&4294967295)<<20&4294967295|v>>>12))+((v=I+(A^S^C)+P[5]+4294588738&4294967295)<<4&4294967295|v>>>28))+((v=C+(I^A^S)+P[8]+2272392833&4294967295)<<11&4294967295|v>>>21))+((v=S+(C^I^A)+P[11]+1839030562&4294967295)<<16&4294967295|v>>>16))+((v=A+(S^C^I)+P[14]+4259657740&4294967295)<<23&4294967295|v>>>9))+((v=I+(A^S^C)+P[1]+2763975236&4294967295)<<4&4294967295|v>>>28))+((v=C+(I^A^S)+P[4]+1272893353&4294967295)<<11&4294967295|v>>>21))+((v=S+(C^I^A)+P[7]+4139469664&4294967295)<<16&4294967295|v>>>16))+((v=A+(S^C^I)+P[10]+3200236656&4294967295)<<23&4294967295|v>>>9))+((v=I+(A^S^C)+P[13]+681279174&4294967295)<<4&4294967295|v>>>28))+((v=C+(I^A^S)+P[0]+3936430074&4294967295)<<11&4294967295|v>>>21))+((v=S+(C^I^A)+P[3]+3572445317&4294967295)<<16&4294967295|v>>>16))+((v=A+(S^C^I)+P[6]+76029189&4294967295)<<23&4294967295|v>>>9))+((v=I+(A^S^C)+P[9]+3654602809&4294967295)<<4&4294967295|v>>>28))+((v=C+(I^A^S)+P[12]+3873151461&4294967295)<<11&4294967295|v>>>21))+((v=S+(C^I^A)+P[15]+530742520&4294967295)<<16&4294967295|v>>>16))+((v=A+(S^C^I)+P[2]+3299628645&4294967295)<<23&4294967295|v>>>9))+((v=I+(S^(A|~C))+P[0]+4096336452&4294967295)<<6&4294967295|v>>>26))+((v=C+(A^(I|~S))+P[7]+1126891415&4294967295)<<10&4294967295|v>>>22))+((v=S+(I^(C|~A))+P[14]+2878612391&4294967295)<<15&4294967295|v>>>17))+((v=A+(C^(S|~I))+P[5]+4237533241&4294967295)<<21&4294967295|v>>>11))+((v=I+(S^(A|~C))+P[12]+1700485571&4294967295)<<6&4294967295|v>>>26))+((v=C+(A^(I|~S))+P[3]+2399980690&4294967295)<<10&4294967295|v>>>22))+((v=S+(I^(C|~A))+P[10]+4293915773&4294967295)<<15&4294967295|v>>>17))+((v=A+(C^(S|~I))+P[1]+2240044497&4294967295)<<21&4294967295|v>>>11))+((v=I+(S^(A|~C))+P[8]+1873313359&4294967295)<<6&4294967295|v>>>26))+((v=C+(A^(I|~S))+P[15]+4264355552&4294967295)<<10&4294967295|v>>>22))+((v=S+(I^(C|~A))+P[6]+2734768916&4294967295)<<15&4294967295|v>>>17))+((v=A+(C^(S|~I))+P[13]+1309151649&4294967295)<<21&4294967295|v>>>11))+((C=(I=A+((v=I+(S^(A|~C))+P[4]+4149444226&4294967295)<<6&4294967295|v>>>26))+((v=C+(A^(I|~S))+P[11]+3174756917&4294967295)<<10&4294967295|v>>>22))^((S=C+((v=S+(I^(C|~A))+P[2]+718787259&4294967295)<<15&4294967295|v>>>17))|~I))+P[9]+3951481745&4294967295,R.g[0]=R.g[0]+I&4294967295,R.g[1]=R.g[1]+(S+(v<<21&4294967295|v>>>11))&4294967295,R.g[2]=R.g[2]+S&4294967295,R.g[3]=R.g[3]+C&4294967295}function a(R,I){this.h=I;for(var A=[],P=!0,S=R.length-1;0<=S;S--){var C=0|R[S];P&&C==I||(A[S]=C,P=!1)}this.g=A}(function e(R,I){function A(){}A.prototype=I.prototype,R.D=I.prototype,R.prototype=new A,R.prototype.constructor=R,R.C=function(P,S,C){for(var v=Array(arguments.length-2),bn=2;bn<arguments.length;bn++)v[bn-2]=arguments[bn];return I.prototype[S].apply(P,v)}})(n,function t(){this.blockSize=-1}),n.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},n.prototype.u=function(R,I){void 0===I&&(I=R.length);for(var A=I-this.blockSize,P=this.B,S=this.h,C=0;C<I;){if(0==S)for(;C<=A;)i(this,R,C),C+=this.blockSize;if("string"==typeof R){for(;C<I;)if(P[S++]=R.charCodeAt(C++),S==this.blockSize){i(this,P),S=0;break}}else for(;C<I;)if(P[S++]=R[C++],S==this.blockSize){i(this,P),S=0;break}}this.h=S,this.o+=I},n.prototype.v=function(){var R=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);R[0]=128;for(var I=1;I<R.length-8;++I)R[I]=0;var A=8*this.o;for(I=R.length-8;I<R.length;++I)R[I]=255&A,A/=256;for(this.u(R),R=Array(16),I=A=0;4>I;++I)for(var P=0;32>P;P+=8)R[A++]=this.g[I]>>>P&255;return R};var u={};function l(R){return-128<=R&&128>R?function s(R,I){var A=u;return Object.prototype.hasOwnProperty.call(A,R)?A[R]:A[R]=I(R)}(R,function(I){return new a([0|I],0>I?-1:0)}):new a([0|R],0>R?-1:0)}function d(R){if(isNaN(R)||!isFinite(R))return y;if(0>R)return U(d(-R));for(var I=[],A=1,P=0;R>=A;P++)I[P]=R/A|0,A*=4294967296;return new a(I,0)}var y=l(0),E=l(1),V=l(16777216);function F(R){if(0!=R.h)return!1;for(var I=0;I<R.g.length;I++)if(0!=R.g[I])return!1;return!0}function q(R){return-1==R.h}function U(R){for(var I=R.g.length,A=[],P=0;P<I;P++)A[P]=~R.g[P];return new a(A,~R.h).add(E)}function H(R,I){return R.add(U(I))}function Z(R,I){for(;(65535&R[I])!=R[I];)R[I+1]+=R[I]>>>16,R[I]&=65535,I++}function J(R,I){this.g=R,this.h=I}function ne(R,I){if(F(I))throw Error("division by zero");if(F(R))return new J(y,y);if(q(R))return I=ne(U(R),I),new J(U(I.g),U(I.h));if(q(I))return I=ne(R,U(I)),new J(U(I.g),I.h);if(30<R.g.length){if(q(R)||q(I))throw Error("slowDivide_ only works with positive integers.");for(var A=E,P=I;0>=P.l(R);)A=de(A),P=de(P);var S=se(A,1),C=se(P,1);for(P=se(P,2),A=se(A,2);!F(P);){var v=C.add(P);0>=v.l(R)&&(S=S.add(A),C=v),P=se(P,1),A=se(A,1)}return I=H(R,S.j(I)),new J(S,I)}for(S=y;0<=R.l(I);){for(A=Math.max(1,Math.floor(R.m()/I.m())),P=48>=(P=Math.ceil(Math.log(A)/Math.LN2))?1:Math.pow(2,P-48),v=(C=d(A)).j(I);q(v)||0<v.l(R);)v=(C=d(A-=P)).j(I);F(C)&&(C=E),S=S.add(C),R=H(R,v)}return new J(S,R)}function de(R){for(var I=R.g.length+1,A=[],P=0;P<I;P++)A[P]=R.i(P)<<1|R.i(P-1)>>>31;return new a(A,R.h)}function se(R,I){var A=I>>5;I%=32;for(var P=R.g.length-A,S=[],C=0;C<P;C++)S[C]=0<I?R.i(C+A)>>>I|R.i(C+A+1)<<32-I:R.i(C+A);return new a(S,R.h)}(r=a.prototype).m=function(){if(q(this))return-U(this).m();for(var R=0,I=1,A=0;A<this.g.length;A++){var P=this.i(A);R+=(0<=P?P:4294967296+P)*I,I*=4294967296}return R},r.toString=function(R){if(2>(R=R||10)||36<R)throw Error("radix out of range: "+R);if(F(this))return"0";if(q(this))return"-"+U(this).toString(R);for(var I=d(Math.pow(R,6)),A=this,P="";;){var S=ne(A,I).g,C=((0<(A=H(A,S.j(I))).g.length?A.g[0]:A.h)>>>0).toString(R);if(F(A=S))return C+P;for(;6>C.length;)C="0"+C;P=C+P}},r.i=function(R){return 0>R?0:R<this.g.length?this.g[R]:this.h},r.l=function(R){return q(R=H(this,R))?-1:F(R)?0:1},r.abs=function(){return q(this)?U(this):this},r.add=function(R){for(var I=Math.max(this.g.length,R.g.length),A=[],P=0,S=0;S<=I;S++){var C=P+(65535&this.i(S))+(65535&R.i(S)),v=(C>>>16)+(this.i(S)>>>16)+(R.i(S)>>>16);P=v>>>16,A[S]=(v&=65535)<<16|(C&=65535)}return new a(A,-2147483648&A[A.length-1]?-1:0)},r.j=function(R){if(F(this)||F(R))return y;if(q(this))return q(R)?U(this).j(U(R)):U(U(this).j(R));if(q(R))return U(this.j(U(R)));if(0>this.l(V)&&0>R.l(V))return d(this.m()*R.m());for(var I=this.g.length+R.g.length,A=[],P=0;P<2*I;P++)A[P]=0;for(P=0;P<this.g.length;P++)for(var S=0;S<R.g.length;S++){var C=this.i(P)>>>16,v=65535&this.i(P),bn=R.i(S)>>>16,ws=65535&R.i(S);A[2*P+2*S]+=v*ws,Z(A,2*P+2*S),A[2*P+2*S+1]+=C*ws,Z(A,2*P+2*S+1),A[2*P+2*S+1]+=v*bn,Z(A,2*P+2*S+1),A[2*P+2*S+2]+=C*bn,Z(A,2*P+2*S+2)}for(P=0;P<I;P++)A[P]=A[2*P+1]<<16|A[2*P];for(P=I;P<2*I;P++)A[P]=0;return new a(A,0)},r.A=function(R){return ne(this,R).h},r.and=function(R){for(var I=Math.max(this.g.length,R.g.length),A=[],P=0;P<I;P++)A[P]=this.i(P)&R.i(P);return new a(A,this.h&R.h)},r.or=function(R){for(var I=Math.max(this.g.length,R.g.length),A=[],P=0;P<I;P++)A[P]=this.i(P)|R.i(P);return new a(A,this.h|R.h)},r.xor=function(R){for(var I=Math.max(this.g.length,R.g.length),A=[],P=0;P<I;P++)A[P]=this.i(P)^R.i(P);return new a(A,this.h^R.h)},n.prototype.digest=n.prototype.v,n.prototype.reset=n.prototype.s,n.prototype.update=n.prototype.u,Ks=Gr.Md5=n,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=d,a.fromString=function g(R,I){if(0==R.length)throw Error("number format error: empty string");if(2>(I=I||10)||36<I)throw Error("radix out of range: "+I);if("-"==R.charAt(0))return U(g(R.substring(1),I));if(0<=R.indexOf("-"))throw Error('number format error: interior "-" character');for(var A=d(Math.pow(I,8)),P=y,S=0;S<R.length;S+=8){var C=Math.min(8,R.length-S),v=parseInt(R.substring(S,S+C),I);8>C?(C=d(Math.pow(I,C)),P=P.j(C).add(d(v))):P=(P=P.j(A)).add(d(v))}return P},hn=Gr.Integer=a}).apply(typeof qr<"u"?qr:typeof self<"u"?self:typeof window<"u"?window:{});var zs,xi,On,js,zr,Ci,Di,$s,Qs,Kr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Wt={};(function(){var r,e="function"==typeof Object.defineProperties?Object.defineProperty:function(o,c,m){return o==Array.prototype||o==Object.prototype||(o[c]=m.value),o},n=function t(o){o=["object"==typeof globalThis&&globalThis,o,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof Kr&&Kr];for(var c=0;c<o.length;++c){var m=o[c];if(m&&m.Math==Math)return m}throw Error("Cannot find global object")}(this);!function i(o,c){if(c)e:{var m=n;o=o.split(".");for(var p=0;p<o.length-1;p++){var x=o[p];if(!(x in m))break e;m=m[x]}(c=c(p=m[o=o[o.length-1]]))!=p&&null!=c&&e(m,o,{configurable:!0,writable:!0,value:c})}}("Array.prototype.values",function(o){return o||function(){return function s(o,c){o instanceof String&&(o+="");var m=0,p=!1,x={next:function(){if(!p&&m<o.length){var k=m++;return{value:c(k,o[k]),done:!1}}return p=!0,{done:!0,value:void 0}}};return x[Symbol.iterator]=function(){return x},x}(this,function(c,m){return m})}});var a=a||{},u=this||self;function l(o){var c=typeof o;return"array"==(c="object"!=c?c:o?Array.isArray(o)?"array":c:"null")||"object"==c&&"number"==typeof o.length}function d(o){var c=typeof o;return"object"==c&&null!=o||"function"==c}function g(o,c,m){return o.call.apply(o.bind,arguments)}function y(o,c,m){if(!o)throw Error();if(2<arguments.length){var p=Array.prototype.slice.call(arguments,2);return function(){var x=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(x,p),o.apply(c,x)}}return function(){return o.apply(c,arguments)}}function E(o,c,m){return(E=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?g:y).apply(null,arguments)}function V(o,c){var m=Array.prototype.slice.call(arguments,1);return function(){var p=m.slice();return p.push.apply(p,arguments),o.apply(this,p)}}function F(o,c){function m(){}m.prototype=c.prototype,o.aa=c.prototype,o.prototype=new m,o.prototype.constructor=o,o.Qb=function(p,x,k){for(var z=Array(arguments.length-2),be=2;be<arguments.length;be++)z[be-2]=arguments[be];return c.prototype[x].apply(p,z)}}function q(o){const c=o.length;if(0<c){const m=Array(c);for(let p=0;p<c;p++)m[p]=o[p];return m}return[]}function U(o,c){for(let m=1;m<arguments.length;m++){const p=arguments[m];if(l(p)){const x=o.length||0,k=p.length||0;o.length=x+k;for(let z=0;z<k;z++)o[x+z]=p[z]}else o.push(p)}}function Z(o){return/^[\s\xa0]*$/.test(o)}function J(){var o=u.navigator;return o&&(o=o.userAgent)?o:""}function ne(o){return ne[" "](o),o}ne[" "]=function(){};var de=!(-1==J().indexOf("Gecko")||-1!=J().toLowerCase().indexOf("webkit")&&-1==J().indexOf("Edge")||-1!=J().indexOf("Trident")||-1!=J().indexOf("MSIE")||-1!=J().indexOf("Edge"));function se(o,c,m){for(const p in o)c.call(m,o[p],p,o)}function I(o){const c={};for(const m in o)c[m]=o[m];return c}const A="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function P(o,c){let m,p;for(let x=1;x<arguments.length;x++){for(m in p=arguments[x],p)o[m]=p[m];for(let k=0;k<A.length;k++)m=A[k],Object.prototype.hasOwnProperty.call(p,m)&&(o[m]=p[m])}}function S(o){var c=1;o=o.split(":");const m=[];for(;0<c&&o.length;)m.push(o.shift()),c--;return o.length&&m.push(o.join(":")),m}function C(o){u.setTimeout(()=>{throw o},0)}function v(){var o=pc;let c=null;return o.g&&(c=o.g,o.g=o.g.next,o.g||(o.h=null),c.next=null),c}var ws=new class H{constructor(c,m){this.i=c,this.j=m,this.h=0,this.g=null}get(){let c;return 0<this.h?(this.h--,c=this.g,this.g=c.next,c.next=null):c=this.i(),c}}(()=>new Vy,o=>o.reset());class Vy{constructor(){this.next=this.g=this.h=null}set(c,m){this.h=c,this.g=m,this.next=null}reset(){this.next=this.g=this.h=null}}let Rs,Ps=!1,pc=new class bn{constructor(){this.h=this.g=null}add(c,m){const p=ws.get();p.set(c,m),this.h?this.h.next=p:this.g=p,this.h=p}},$f=()=>{const o=u.Promise.resolve(void 0);Rs=()=>{o.then(xy)}};var xy=()=>{for(var o;o=v();){try{o.h.call(o.g)}catch(m){C(m)}var c=ws;c.j(o),100>c.h&&(c.h++,o.next=c.g,c.g=o)}Ps=!1};function rr(){this.s=this.s,this.C=this.C}function yt(o,c){this.type=o,this.g=this.target=c,this.defaultPrevented=!1}rr.prototype.s=!1,rr.prototype.ma=function(){this.s||(this.s=!0,this.N())},rr.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},yt.prototype.h=function(){this.defaultPrevented=!0};var Cy=function(){if(!u.addEventListener||!Object.defineProperty)return!1;var o=!1,c=Object.defineProperty({},"passive",{get:function(){o=!0}});try{const m=()=>{};u.addEventListener("test",m,c),u.removeEventListener("test",m,c)}catch{}return o}();function Ss(o,c){if(yt.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var m=this.type=o.type,p=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=c,c=o.relatedTarget){if(de){e:{try{ne(c.nodeName);var x=!0;break e}catch{}x=!1}x||(c=null)}}else"mouseover"==m?c=o.fromElement:"mouseout"==m&&(c=o.toElement);this.relatedTarget=c,p?(this.clientX=void 0!==p.clientX?p.clientX:p.pageX,this.clientY=void 0!==p.clientY?p.clientY:p.pageY,this.screenX=p.screenX||0,this.screenY=p.screenY||0):(this.clientX=void 0!==o.clientX?o.clientX:o.pageX,this.clientY=void 0!==o.clientY?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType="string"==typeof o.pointerType?o.pointerType:Dy[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&Ss.aa.h.call(this)}}F(Ss,yt);var Dy={2:"touch",3:"pen",4:"mouse"};Ss.prototype.h=function(){Ss.aa.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var bs="closure_listenable_"+(1e6*Math.random()|0),Ny=0;function ky(o,c,m,p,x){this.listener=o,this.proxy=null,this.src=c,this.type=m,this.capture=!!p,this.ha=x,this.key=++Ny,this.da=this.fa=!1}function Ta(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function Ia(o){this.src=o,this.g={},this.h=0}function _c(o,c){var m=c.type;if(m in o.g){var k,p=o.g[m],x=Array.prototype.indexOf.call(p,c,void 0);(k=0<=x)&&Array.prototype.splice.call(p,x,1),k&&(Ta(c),0==o.g[m].length&&(delete o.g[m],o.h--))}}function yc(o,c,m,p){for(var x=0;x<o.length;++x){var k=o[x];if(!k.da&&k.listener==c&&k.capture==!!m&&k.ha==p)return x}return-1}Ia.prototype.add=function(o,c,m,p,x){var k=o.toString();(o=this.g[k])||(o=this.g[k]=[],this.h++);var z=yc(o,c,p,x);return-1<z?(c=o[z],m||(c.fa=!1)):((c=new ky(c,this.src,k,!!p,x)).fa=m,o.push(c)),c};var Tc="closure_lm_"+(1e6*Math.random()|0),Ic={};function Qf(o,c,m,p,x){if(p&&p.once)return Hf(o,c,m,p,x);if(Array.isArray(c)){for(var k=0;k<c.length;k++)Qf(o,c[k],m,p,x);return null}return m=wc(m),o&&o[bs]?o.K(c,m,d(p)?!!p.capture:!!p,x):Wf(o,c,m,!1,p,x)}function Wf(o,c,m,p,x,k){if(!c)throw Error("Invalid event type");var z=d(x)?!!x.capture:!!x,be=vc(o);if(be||(o[Tc]=be=new Ia(o)),(m=be.add(c,m,p,z,k)).proxy)return m;if(p=function Oy(){const c=My;return function o(m){return c.call(o.src,o.listener,m)}}(),m.proxy=p,p.src=o,p.listener=m,o.addEventListener)Cy||(x=z),void 0===x&&(x=!1),o.addEventListener(c.toString(),p,x);else if(o.attachEvent)o.attachEvent(Jf(c.toString()),p);else{if(!o.addListener||!o.removeListener)throw Error("addEventListener and attachEvent are unavailable.");o.addListener(p)}return m}function Hf(o,c,m,p,x){if(Array.isArray(c)){for(var k=0;k<c.length;k++)Hf(o,c[k],m,p,x);return null}return m=wc(m),o&&o[bs]?o.L(c,m,d(p)?!!p.capture:!!p,x):Wf(o,c,m,!0,p,x)}function Xf(o,c,m,p,x){if(Array.isArray(c))for(var k=0;k<c.length;k++)Xf(o,c[k],m,p,x);else p=d(p)?!!p.capture:!!p,m=wc(m),o&&o[bs]?(o=o.i,(c=String(c).toString())in o.g&&-1<(m=yc(k=o.g[c],m,p,x))&&(Ta(k[m]),Array.prototype.splice.call(k,m,1),0==k.length&&(delete o.g[c],o.h--))):o&&(o=vc(o))&&(c=o.g[c.toString()],o=-1,c&&(o=yc(c,m,p,x)),(m=-1<o?c[o]:null)&&Ec(m))}function Ec(o){if("number"!=typeof o&&o&&!o.da){var c=o.src;if(c&&c[bs])_c(c.i,o);else{var m=o.type,p=o.proxy;c.removeEventListener?c.removeEventListener(m,p,o.capture):c.detachEvent?c.detachEvent(Jf(m),p):c.addListener&&c.removeListener&&c.removeListener(p),(m=vc(c))?(_c(m,o),0==m.h&&(m.src=null,c[Tc]=null)):Ta(o)}}}function Jf(o){return o in Ic?Ic[o]:Ic[o]="on"+o}function My(o,c){if(o.da)o=!0;else{c=new Ss(c,this);var m=o.listener,p=o.ha||o.src;o.fa&&Ec(o),o=m.call(p,c)}return o}function vc(o){return(o=o[Tc])instanceof Ia?o:null}var Ac="__closure_events_fn_"+(1e9*Math.random()>>>0);function wc(o){return"function"==typeof o?o:(o[Ac]||(o[Ac]=function(c){return o.handleEvent(c)}),o[Ac])}function Tt(){rr.call(this),this.i=new Ia(this),this.M=this,this.F=null}function St(o,c){var m,p=o.F;if(p)for(m=[];p;p=p.F)m.push(p);if(o=o.M,p=c.type||c,"string"==typeof c)c=new yt(c,o);else if(c instanceof yt)c.target=c.target||o;else{var x=c;P(c=new yt(p,o),x)}if(x=!0,m)for(var k=m.length-1;0<=k;k--){var z=c.g=m[k];x=Ea(z,p,!0,c)&&x}if(x=Ea(z=c.g=o,p,!0,c)&&x,x=Ea(z,p,!1,c)&&x,m)for(k=0;k<m.length;k++)x=Ea(z=c.g=m[k],p,!1,c)&&x}function Ea(o,c,m,p){if(!(c=o.i.g[String(c)]))return!0;c=c.concat();for(var x=!0,k=0;k<c.length;++k){var z=c[k];if(z&&!z.da&&z.capture==m){var be=z.listener,ct=z.ha||z.src;z.fa&&_c(o.i,z),x=!1!==be.call(ct,p)&&x}}return x&&!p.defaultPrevented}function Yf(o,c,m){if("function"==typeof o)m&&(o=E(o,m));else{if(!o||"function"!=typeof o.handleEvent)throw Error("Invalid listener argument");o=E(o.handleEvent,o)}return 2147483647<Number(c)?-1:u.setTimeout(o,c||0)}function Zf(o){o.g=Yf(()=>{o.g=null,o.i&&(o.i=!1,Zf(o))},o.l);const c=o.h;o.h=null,o.m.apply(null,c)}F(Tt,rr),Tt.prototype[bs]=!0,Tt.prototype.removeEventListener=function(o,c,m,p){Xf(this,o,c,m,p)},Tt.prototype.N=function(){if(Tt.aa.N.call(this),this.i){var c,o=this.i;for(c in o.g){for(var m=o.g[c],p=0;p<m.length;p++)Ta(m[p]);delete o.g[c],o.h--}}this.F=null},Tt.prototype.K=function(o,c,m,p){return this.i.add(String(o),c,!1,m,p)},Tt.prototype.L=function(o,c,m,p){return this.i.add(String(o),c,!0,m,p)};class Fy extends rr{constructor(c,m){super(),this.m=c,this.l=m,this.h=null,this.i=!1,this.g=null}j(c){this.h=arguments,this.g?this.i=!0:Zf(this)}N(){super.N(),this.g&&(u.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Vs(o){rr.call(this),this.h=o,this.g={}}F(Vs,rr);var em=[];function tm(o){se(o.g,function(c,m){this.g.hasOwnProperty(m)&&Ec(c)},o),o.g={}}Vs.prototype.N=function(){Vs.aa.N.call(this),tm(this)},Vs.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Rc=u.JSON.stringify,Ly=u.JSON.parse,Uy=class{stringify(o){return u.JSON.stringify(o,void 0)}parse(o){return u.JSON.parse(o,void 0)}};function Pc(){}function rm(){}Pc.prototype.h=null;var xs={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Sc(){yt.call(this,"d")}function bc(){yt.call(this,"c")}F(Sc,yt),F(bc,yt);var Fr={},im=null;function va(){return im=im||new Tt}function sm(o){yt.call(this,Fr.La,o)}function Cs(o){const c=va();St(c,new sm(c))}function om(o,c){yt.call(this,Fr.STAT_EVENT,o),this.stat=c}function bt(o){const c=va();St(c,new om(c,o))}function am(o,c){yt.call(this,Fr.Ma,o),this.size=c}function Ds(o,c){if("function"!=typeof o)throw Error("Fn must not be null and must be a function");return u.setTimeout(function(){o()},c)}function Ns(){this.g=!0}function Pi(o,c,m,p){o.info(function(){return"XMLHTTP TEXT ("+c+"): "+function Ky(o,c){if(!o.g)return c;if(!c)return null;try{var m=JSON.parse(c);if(m)for(o=0;o<m.length;o++)if(Array.isArray(m[o])){var p=m[o];if(!(2>p.length)){var x=p[1];if(Array.isArray(x)&&!(1>x.length)){var k=x[0];if("noop"!=k&&"stop"!=k&&"close"!=k)for(var z=1;z<x.length;z++)x[z]=""}}}return Rc(m)}catch{return c}}(o,m)+(p?" "+p:"")})}Fr.La="serverreachability",F(sm,yt),Fr.STAT_EVENT="statevent",F(om,yt),Fr.Ma="timingevent",F(am,yt),Ns.prototype.xa=function(){this.g=!1},Ns.prototype.info=function(){};var Vc,Aa={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},um={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function wa(){}function ir(o,c,m,p){this.j=o,this.i=c,this.l=m,this.R=p||1,this.U=new Vs(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new lm}function lm(){this.i=null,this.g="",this.h=!1}F(wa,Pc),wa.prototype.g=function(){return new XMLHttpRequest},wa.prototype.i=function(){return{}},Vc=new wa;var cm={},xc={};function Cc(o,c,m){o.L=1,o.v=ba(Vn(c)),o.m=m,o.P=!0,hm(o,null)}function hm(o,c){o.F=Date.now(),Ra(o),o.A=Vn(o.v);var m=o.A,p=o.R;Array.isArray(p)||(p=[String(p)]),Rm(m.i,"t",p),o.C=0,m=o.j.J,o.h=new lm,o.g=Km(o.j,m?c:null,!o.m),0<o.O&&(o.M=new Fy(E(o.Y,o,o.g),o.O)),c=o.U,m=o.g,p=o.ca;var x="readystatechange";Array.isArray(x)||(x&&(em[0]=x.toString()),x=em);for(var k=0;k<x.length;k++){var z=Qf(m,x[k],p||c.handleEvent,!1,c.h||c);if(!z)break;c.g[z.key]=z}c=o.H?I(o.H):{},o.m?(o.u||(o.u="POST"),c["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.m,c)):(o.u="GET",o.g.ea(o.A,o.u,null,c)),Cs(),function By(o,c,m,p,x,k){o.info(function(){if(o.g)if(k)for(var z="",be=k.split("&"),ct=0;ct<be.length;ct++){var pe=be[ct].split("=");if(1<pe.length){var It=pe[0];pe=pe[1];var Et=It.split("_");z=2<=Et.length&&"type"==Et[1]?z+(It+"=")+pe+"&":z+(It+"=redacted&")}}else z=null;else z=k;return"XMLHTTP REQ ("+p+") [attempt "+x+"]: "+c+"\n"+m+"\n"+z})}(o.i,o.u,o.A,o.l,o.R,o.m)}function dm(o){return!!o.g&&"GET"==o.u&&2!=o.L&&o.j.Ca}function zy(o,c){var m=o.C,p=c.indexOf("\n",m);return-1==p?xc:(m=Number(c.substring(m,p)),isNaN(m)?cm:(p+=1)+m>c.length?xc:(c=c.slice(p,p+m),o.C=p+m,c))}function Ra(o){o.S=Date.now()+o.I,fm(o,o.I)}function fm(o,c){if(null!=o.B)throw Error("WatchDog timer not null");o.B=Ds(E(o.ba,o),c)}function Dc(o){o.B&&(u.clearTimeout(o.B),o.B=null)}function ks(o){0==o.j.G||o.J||Um(o.j,o)}function Lr(o){Dc(o);var c=o.M;c&&"function"==typeof c.ma&&c.ma(),o.M=null,tm(o.U),o.g&&(c=o.g,o.g=null,c.abort(),c.ma())}function Nc(o,c){try{var m=o.j;if(0!=m.G&&(m.g==o||kc(m.h,o)))if(!o.K&&kc(m.h,o)&&3==m.G){try{var p=m.Da.g.parse(c)}catch{p=null}if(Array.isArray(p)&&3==p.length){var x=p;if(0==x[0]){e:if(!m.u){if(m.g){if(!(m.g.F+3e3<o.F))break e;Na(m),Ca(m)}Lc(m),bt(18)}}else m.za=x[1],0<m.za-m.T&&37500>x[2]&&m.F&&0==m.v&&!m.C&&(m.C=Ds(E(m.Za,m),6e3));if(1>=pm(m.h)&&m.ca){try{m.ca()}catch{}m.ca=void 0}}else Br(m,11)}else if((o.K||m.g==o)&&Na(m),!Z(c))for(x=m.Da.g.parse(c),c=0;c<x.length;c++){let pe=x[c];if(m.T=pe[0],pe=pe[1],2==m.G)if("c"==pe[0]){m.K=pe[1],m.ia=pe[2];const It=pe[3];null!=It&&(m.la=It,m.j.info("VER="+m.la));const Et=pe[4];null!=Et&&(m.Aa=Et,m.j.info("SVER="+m.Aa));const Vi=pe[5];null!=Vi&&"number"==typeof Vi&&0<Vi&&(m.L=p=1.5*Vi,m.j.info("backChannelRequestTimeoutMs_="+p)),p=m;const Jt=o.g;if(Jt){const Oa=Jt.g?Jt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Oa){var k=p.h;k.g||-1==Oa.indexOf("spdy")&&-1==Oa.indexOf("quic")&&-1==Oa.indexOf("h2")||(k.j=k.l,k.g=new Set,k.h&&(Oc(k,k.h),k.h=null))}if(p.D){const Bc=Jt.g?Jt.g.getResponseHeader("X-HTTP-Session-Id"):null;Bc&&(p.ya=Bc,Fe(p.I,p.D,Bc))}}m.G=3,m.l&&m.l.ua(),m.ba&&(m.R=Date.now()-o.F,m.j.info("Handshake RTT: "+m.R+"ms"));var z=o;if((p=m).qa=Gm(p,p.J?p.ia:null,p.W),z.K){_m(p.h,z);var be=z,ct=p.L;ct&&(be.I=ct),be.B&&(Dc(be),Ra(be)),p.g=z}else Fm(p);0<m.i.length&&Da(m)}else"stop"!=pe[0]&&"close"!=pe[0]||Br(m,7);else 3==m.G&&("stop"==pe[0]||"close"==pe[0]?"stop"==pe[0]?Br(m,7):Fc(m):"noop"!=pe[0]&&m.l&&m.l.ta(pe),m.v=0)}Cs()}catch{}}ir.prototype.ca=function(o){o=o.target;const c=this.M;c&&3==xn(o)?c.j():this.Y(o)},ir.prototype.Y=function(o){try{if(o==this.g)e:{const Et=xn(this.g);var c=this.g.Ba();if(this.g.Z(),!(3>Et)&&(3!=Et||this.g&&(this.h.h||this.g.oa()||Dm(this.g)))){this.J||4!=Et||7==c||Cs(),Dc(this);var m=this.g.Z();this.X=m;t:if(dm(this)){var p=Dm(this.g);o="";var x=p.length,k=4==xn(this.g);if(!this.h.i){if(typeof TextDecoder>"u"){Lr(this),ks(this);var z="";break t}this.h.i=new u.TextDecoder}for(c=0;c<x;c++)this.h.h=!0,o+=this.h.i.decode(p[c],{stream:!(k&&c==x-1)});p.length=0,this.h.g+=o,this.C=0,z=this.h.g}else z=this.g.oa();if(this.o=200==m,function qy(o,c,m,p,x,k,z){o.info(function(){return"XMLHTTP RESP ("+p+") [ attempt "+x+"]: "+c+"\n"+m+"\n"+k+" "+z})}(this.i,this.u,this.A,this.l,this.R,Et,m),this.o){if(this.T&&!this.K){t:{if(this.g){var be,ct=this.g;if((be=ct.g?ct.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!Z(be)){var pe=be;break t}}pe=null}if(!(m=pe)){this.o=!1,this.s=3,bt(12),Lr(this),ks(this);break e}Pi(this.i,this.l,m,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Nc(this,m)}if(this.P){let Jt;for(m=!0;!this.J&&this.C<z.length;){if(Jt=zy(this,z),Jt==xc){4==Et&&(this.s=4,bt(14),m=!1),Pi(this.i,this.l,null,"[Incomplete Response]");break}if(Jt==cm){this.s=4,bt(15),Pi(this.i,this.l,z,"[Invalid Chunk]"),m=!1;break}Pi(this.i,this.l,Jt,null),Nc(this,Jt)}if(dm(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=Et||0!=z.length||this.h.h||(this.s=1,bt(16),m=!1),this.o=this.o&&m,m){if(0<z.length&&!this.W){this.W=!0;var It=this.j;It.g==this&&It.ba&&!It.M&&(It.j.info("Great, no buffering proxy detected. Bytes received: "+z.length),Uc(It),It.M=!0,bt(11))}}else Pi(this.i,this.l,z,"[Invalid Chunked Response]"),Lr(this),ks(this)}else Pi(this.i,this.l,z,null),Nc(this,z);4==Et&&Lr(this),this.o&&!this.J&&(4==Et?Um(this.j,this):(this.o=!1,Ra(this)))}else(function aT(o){const c={};o=(o.g&&2<=xn(o)&&o.g.getAllResponseHeaders()||"").split("\r\n");for(let p=0;p<o.length;p++){if(Z(o[p]))continue;var m=S(o[p]);const x=m[0];if("string"!=typeof(m=m[1]))continue;m=m.trim();const k=c[x]||[];c[x]=k,k.push(m)}!function R(o,c){for(const m in o)c.call(void 0,o[m],m,o)}(c,function(p){return p.join(", ")})})(this.g),400==m&&0<z.indexOf("Unknown SID")?(this.s=3,bt(12)):(this.s=0,bt(13)),Lr(this),ks(this)}}}catch{}},ir.prototype.cancel=function(){this.J=!0,Lr(this)},ir.prototype.ba=function(){this.B=null;const o=Date.now();0<=o-this.S?(function Gy(o,c){o.info(function(){return"TIMEOUT: "+c})}(this.i,this.A),2!=this.L&&(Cs(),bt(17)),Lr(this),this.s=2,ks(this)):fm(this,this.S-o)};var jy=class{constructor(o,c){this.g=o,this.map=c}};function mm(o){this.l=o||10,o=u.PerformanceNavigationTiming?0<(o=u.performance.getEntriesByType("navigation")).length&&("hq"==o[0].nextHopProtocol||"h2"==o[0].nextHopProtocol):!!(u.chrome&&u.chrome.loadTimes&&u.chrome.loadTimes()&&u.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function gm(o){return!!o.h||!!o.g&&o.g.size>=o.j}function pm(o){return o.h?1:o.g?o.g.size:0}function kc(o,c){return o.h?o.h==c:!!o.g&&o.g.has(c)}function Oc(o,c){o.g?o.g.add(c):o.h=c}function _m(o,c){o.h&&o.h==c?o.h=null:o.g&&o.g.has(c)&&o.g.delete(c)}function ym(o){if(null!=o.h)return o.i.concat(o.h.D);if(null!=o.g&&0!==o.g.size){let c=o.i;for(const m of o.g.values())c=c.concat(m.D);return c}return q(o.i)}function Tm(o,c){if(o.forEach&&"function"==typeof o.forEach)o.forEach(c,void 0);else if(l(o)||"string"==typeof o)Array.prototype.forEach.call(o,c,void 0);else for(var m=function Qy(o){if(o.na&&"function"==typeof o.na)return o.na();if(!o.V||"function"!=typeof o.V){if(typeof Map<"u"&&o instanceof Map)return Array.from(o.keys());if(!(typeof Set<"u"&&o instanceof Set)){if(l(o)||"string"==typeof o){var c=[];o=o.length;for(var m=0;m<o;m++)c.push(m);return c}c=[],m=0;for(const p in o)c[m++]=p;return c}}}(o),p=function $y(o){if(o.V&&"function"==typeof o.V)return o.V();if(typeof Map<"u"&&o instanceof Map||typeof Set<"u"&&o instanceof Set)return Array.from(o.values());if("string"==typeof o)return o.split("");if(l(o)){for(var c=[],m=o.length,p=0;p<m;p++)c.push(o[p]);return c}for(p in c=[],m=0,o)c[m++]=o[p];return c}(o),x=p.length,k=0;k<x;k++)c.call(void 0,p[k],m&&m[k],o)}mm.prototype.cancel=function(){if(this.i=ym(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const o of this.g.values())o.cancel();this.g.clear()}};var Im=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Ur(o){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,o instanceof Ur){this.h=o.h,Pa(this,o.j),this.o=o.o,this.g=o.g,Sa(this,o.s),this.l=o.l;var c=o.i,m=new Fs;m.i=c.i,c.g&&(m.g=new Map(c.g),m.h=c.h),Em(this,m),this.m=o.m}else o&&(c=String(o).match(Im))?(this.h=!1,Pa(this,c[1]||"",!0),this.o=Os(c[2]||""),this.g=Os(c[3]||"",!0),Sa(this,c[4]),this.l=Os(c[5]||"",!0),Em(this,c[6]||"",!0),this.m=Os(c[7]||"")):(this.h=!1,this.i=new Fs(null,this.h))}function Vn(o){return new Ur(o)}function Pa(o,c,m){o.j=m?Os(c,!0):c,o.j&&(o.j=o.j.replace(/:$/,""))}function Sa(o,c){if(c){if(c=Number(c),isNaN(c)||0>c)throw Error("Bad port number "+c);o.s=c}else o.s=null}function Em(o,c,m){c instanceof Fs?(o.i=c,function eT(o,c){c&&!o.j&&(sr(o),o.i=null,o.g.forEach(function(m,p){var x=p.toLowerCase();p!=x&&(Am(this,p),Rm(this,x,m))},o)),o.j=c}(o.i,o.h)):(m||(c=Ms(c,Yy)),o.i=new Fs(c,o.h))}function Fe(o,c,m){o.i.set(c,m)}function ba(o){return Fe(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function Os(o,c){return o?c?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function Ms(o,c,m){return"string"==typeof o?(o=encodeURI(o).replace(c,Hy),m&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function Hy(o){return"%"+((o=o.charCodeAt(0))>>4&15).toString(16)+(15&o).toString(16)}Ur.prototype.toString=function(){var o=[],c=this.j;c&&o.push(Ms(c,vm,!0),":");var m=this.g;return(m||"file"==c)&&(o.push("//"),(c=this.o)&&o.push(Ms(c,vm,!0),"@"),o.push(encodeURIComponent(String(m)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(m=this.s)&&o.push(":",String(m))),(m=this.l)&&(this.g&&"/"!=m.charAt(0)&&o.push("/"),o.push(Ms(m,"/"==m.charAt(0)?Jy:Xy,!0))),(m=this.i.toString())&&o.push("?",m),(m=this.m)&&o.push("#",Ms(m,Zy)),o.join("")};var vm=/[#\/\?@]/g,Xy=/[#\?:]/g,Jy=/[#\?]/g,Yy=/[#\?@]/g,Zy=/#/g;function Fs(o,c){this.h=this.g=null,this.i=o||null,this.j=!!c}function sr(o){o.g||(o.g=new Map,o.h=0,o.i&&function Wy(o,c){if(o){o=o.split("&");for(var m=0;m<o.length;m++){var p=o[m].indexOf("="),x=null;if(0<=p){var k=o[m].substring(0,p);x=o[m].substring(p+1)}else k=o[m];c(k,x?decodeURIComponent(x.replace(/\+/g," ")):"")}}}(o.i,function(c,m){o.add(decodeURIComponent(c.replace(/\+/g," ")),m)}))}function Am(o,c){sr(o),c=Si(o,c),o.g.has(c)&&(o.i=null,o.h-=o.g.get(c).length,o.g.delete(c))}function wm(o,c){return sr(o),c=Si(o,c),o.g.has(c)}function Rm(o,c,m){Am(o,c),0<m.length&&(o.i=null,o.g.set(Si(o,c),q(m)),o.h+=m.length)}function Si(o,c){return c=String(c),o.j&&(c=c.toLowerCase()),c}function or(o,c,m,p,x){try{x&&(x.onload=null,x.onerror=null,x.onabort=null,x.ontimeout=null),p(m)}catch{}}function rT(){this.g=new Uy}function iT(o,c,m){const p=m||"";try{Tm(o,function(x,k){let z=x;d(x)&&(z=Rc(x)),c.push(p+k+"="+encodeURIComponent(z))})}catch(x){throw c.push(p+"type="+encodeURIComponent("_badmap")),x}}function Ls(o){this.l=o.Ub||null,this.j=o.eb||!1}function Va(o,c){Tt.call(this),this.D=o,this.o=c,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function Pm(o){o.j.read().then(o.Pa.bind(o)).catch(o.ga.bind(o))}function Us(o){o.readyState=4,o.l=null,o.j=null,o.v=null,Bs(o)}function Bs(o){o.onreadystatechange&&o.onreadystatechange.call(o)}function Sm(o){let c="";return se(o,function(m,p){c+=p,c+=":",c+=m,c+="\r\n"}),c}function Mc(o,c,m){e:{for(p in m){var p=!1;break e}p=!0}p||(m=Sm(m),"string"==typeof o?null!=m&&encodeURIComponent(String(m)):Fe(o,c,m))}function Qe(o){Tt.call(this),this.headers=new Map,this.o=o||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(r=Fs.prototype).add=function(o,c){sr(this),this.i=null,o=Si(this,o);var m=this.g.get(o);return m||this.g.set(o,m=[]),m.push(c),this.h+=1,this},r.forEach=function(o,c){sr(this),this.g.forEach(function(m,p){m.forEach(function(x){o.call(c,x,p,this)},this)},this)},r.na=function(){sr(this);const o=Array.from(this.g.values()),c=Array.from(this.g.keys()),m=[];for(let p=0;p<c.length;p++){const x=o[p];for(let k=0;k<x.length;k++)m.push(c[p])}return m},r.V=function(o){sr(this);let c=[];if("string"==typeof o)wm(this,o)&&(c=c.concat(this.g.get(Si(this,o))));else{o=Array.from(this.g.values());for(let m=0;m<o.length;m++)c=c.concat(o[m])}return c},r.set=function(o,c){return sr(this),this.i=null,wm(this,o=Si(this,o))&&(this.h-=this.g.get(o).length),this.g.set(o,[c]),this.h+=1,this},r.get=function(o,c){return o&&0<(o=this.V(o)).length?String(o[0]):c},r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const o=[],c=Array.from(this.g.keys());for(var m=0;m<c.length;m++){var p=c[m];const k=encodeURIComponent(String(p)),z=this.V(p);for(p=0;p<z.length;p++){var x=k;""!==z[p]&&(x+="="+encodeURIComponent(String(z[p]))),o.push(x)}}return this.i=o.join("&")},F(Ls,Pc),Ls.prototype.g=function(){return new Va(this.l,this.j)},Ls.prototype.i=function(o){return function(){return o}}({}),F(Va,Tt),(r=Va.prototype).open=function(o,c){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=o,this.A=c,this.readyState=1,Bs(this)},r.send=function(o){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const c={headers:this.u,method:this.B,credentials:this.m,cache:void 0};o&&(c.body=o),(this.D||u).fetch(new Request(this.A,c)).then(this.Sa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Us(this)),this.readyState=0},r.Sa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,Bs(this)),this.g&&(this.readyState=3,Bs(this),this.g)))if("arraybuffer"===this.responseType)o.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof u.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Pm(this)}else o.text().then(this.Ra.bind(this),this.ga.bind(this))},r.Pa=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var c=o.value?o.value:new Uint8Array(0);(c=this.v.decode(c,{stream:!o.done}))&&(this.response=this.responseText+=c)}o.done?Us(this):Bs(this),3==this.readyState&&Pm(this)}},r.Ra=function(o){this.g&&(this.response=this.responseText=o,Us(this))},r.Qa=function(o){this.g&&(this.response=o,Us(this))},r.ga=function(){this.g&&Us(this)},r.setRequestHeader=function(o,c){this.u.append(o,c)},r.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const o=[],c=this.h.entries();for(var m=c.next();!m.done;)o.push((m=m.value)[0]+": "+m[1]),m=c.next();return o.join("\r\n")},Object.defineProperty(Va.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(o){this.m=o?"include":"same-origin"}}),F(Qe,Tt);var sT=/^https?$/i,oT=["POST","PUT"];function bm(o,c){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=c,o.m=5,Vm(o),xa(o)}function Vm(o){o.A||(o.A=!0,St(o,"complete"),St(o,"error"))}function xm(o){if(o.h&&typeof a<"u"&&(!o.v[1]||4!=xn(o)||2!=o.Z()))if(o.u&&4==xn(o))Yf(o.Ea,0,o);else if(St(o,"readystatechange"),4==xn(o)){o.h=!1;try{const z=o.Z();e:switch(z){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break e;default:c=!1}var m;if(!(m=c)){var p;if(p=0===z){var x=String(o.D).match(Im)[1]||null;!x&&u.self&&u.self.location&&(x=u.self.location.protocol.slice(0,-1)),p=!sT.test(x?x.toLowerCase():"")}m=p}if(m)St(o,"complete"),St(o,"success");else{o.m=6;try{var k=2<xn(o)?o.g.statusText:""}catch{k=""}o.l=k+" ["+o.Z()+"]",Vm(o)}}finally{xa(o)}}}function xa(o,c){if(o.g){Cm(o);const m=o.g,p=o.v[0]?()=>{}:null;o.g=null,o.v=null,c||St(o,"ready");try{m.onreadystatechange=p}catch{}}}function Cm(o){o.I&&(u.clearTimeout(o.I),o.I=null)}function xn(o){return o.g?o.g.readyState:0}function Dm(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.H){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function qs(o,c,m){return m&&m.internalChannelParams&&m.internalChannelParams[o]||c}function Nm(o){this.Aa=0,this.i=[],this.j=new Ns,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=qs("failFast",!1,o),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=qs("baseRetryDelayMs",5e3,o),this.cb=qs("retryDelaySeedMs",1e4,o),this.Wa=qs("forwardChannelMaxRetries",2,o),this.wa=qs("forwardChannelRequestTimeoutMs",2e4,o),this.pa=o&&o.xmlHttpFactory||void 0,this.Xa=o&&o.Tb||void 0,this.Ca=o&&o.useFetchStreams||!1,this.L=void 0,this.J=o&&o.supportsCrossDomainXhr||!1,this.K="",this.h=new mm(o&&o.concurrentRequestLimit),this.Da=new rT,this.P=o&&o.fastHandshake||!1,this.O=o&&o.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=o&&o.Rb||!1,o&&o.xa&&this.j.xa(),o&&o.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&o&&o.detectBufferingProxy||!1,this.ja=void 0,o&&o.longPollingTimeout&&0<o.longPollingTimeout&&(this.ja=o.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function Fc(o){if(km(o),3==o.G){var c=o.U++,m=Vn(o.I);if(Fe(m,"SID",o.K),Fe(m,"RID",c),Fe(m,"TYPE","terminate"),Gs(o,m),(c=new ir(o,o.j,c)).L=2,c.v=ba(Vn(m)),m=!1,u.navigator&&u.navigator.sendBeacon)try{m=u.navigator.sendBeacon(c.v.toString(),"")}catch{}!m&&u.Image&&((new Image).src=c.v,m=!0),m||(c.g=Km(c.j,null),c.g.ea(c.v)),c.F=Date.now(),Ra(c)}qm(o)}function Ca(o){o.g&&(Uc(o),o.g.cancel(),o.g=null)}function km(o){Ca(o),o.u&&(u.clearTimeout(o.u),o.u=null),Na(o),o.h.cancel(),o.s&&("number"==typeof o.s&&u.clearTimeout(o.s),o.s=null)}function Da(o){if(!gm(o.h)&&!o.s){o.s=!0;var c=o.Ga;Rs||$f(),Ps||(Rs(),Ps=!0),pc.add(c,o),o.B=0}}function Om(o,c){var m;m=c?c.l:o.U++;const p=Vn(o.I);Fe(p,"SID",o.K),Fe(p,"RID",m),Fe(p,"AID",o.T),Gs(o,p),o.m&&o.o&&Mc(p,o.m,o.o),m=new ir(o,o.j,m,o.B+1),null===o.m&&(m.H=o.o),c&&(o.i=c.D.concat(o.i)),c=Mm(o,m,1e3),m.I=Math.round(.5*o.wa)+Math.round(.5*o.wa*Math.random()),Oc(o.h,m),Cc(m,p,c)}function Gs(o,c){o.H&&se(o.H,function(m,p){Fe(c,p,m)}),o.l&&Tm({},function(m,p){Fe(c,p,m)})}function Mm(o,c,m){m=Math.min(o.i.length,m);var p=o.l?E(o.l.Na,o.l,o):null;e:{var x=o.i;let k=-1;for(;;){const z=["count="+m];-1==k?0<m?(k=x[0].g,z.push("ofs="+k)):k=0:z.push("ofs="+k);let be=!0;for(let ct=0;ct<m;ct++){let pe=x[ct].g;const It=x[ct].map;if(pe-=k,0>pe)k=Math.max(0,x[ct].g-100),be=!1;else try{iT(It,z,"req"+pe+"_")}catch{p&&p(It)}}if(be){p=z.join("&");break e}}}return o=o.i.splice(0,m),c.D=o,p}function Fm(o){if(!o.g&&!o.u){o.Y=1;var c=o.Fa;Rs||$f(),Ps||(Rs(),Ps=!0),pc.add(c,o),o.v=0}}function Lc(o){return!(o.g||o.u||3<=o.v||(o.Y++,o.u=Ds(E(o.Fa,o),Bm(o,o.v)),o.v++,0))}function Uc(o){null!=o.A&&(u.clearTimeout(o.A),o.A=null)}function Lm(o){o.g=new ir(o,o.j,"rpc",o.Y),null===o.m&&(o.g.H=o.o),o.g.O=0;var c=Vn(o.qa);Fe(c,"RID","rpc"),Fe(c,"SID",o.K),Fe(c,"AID",o.T),Fe(c,"CI",o.F?"0":"1"),!o.F&&o.ja&&Fe(c,"TO",o.ja),Fe(c,"TYPE","xmlhttp"),Gs(o,c),o.m&&o.o&&Mc(c,o.m,o.o),o.L&&(o.g.I=o.L);var m=o.g;o=o.ia,m.L=1,m.v=ba(Vn(c)),m.m=null,m.P=!0,hm(m,o)}function Na(o){null!=o.C&&(u.clearTimeout(o.C),o.C=null)}function Um(o,c){var m=null;if(o.g==c){Na(o),Uc(o),o.g=null;var p=2}else{if(!kc(o.h,c))return;m=c.D,_m(o.h,c),p=1}if(0!=o.G)if(c.o)if(1==p){m=c.m?c.m.length:0,c=Date.now()-c.F;var x=o.B;St(p=va(),new am(p,m)),Da(o)}else Fm(o);else if(3==(x=c.s)||0==x&&0<c.X||!(1==p&&function uT(o,c){return!(pm(o.h)>=o.h.j-(o.s?1:0)||(o.s?(o.i=c.D.concat(o.i),0):1==o.G||2==o.G||o.B>=(o.Va?0:o.Wa)||(o.s=Ds(E(o.Ga,o,c),Bm(o,o.B)),o.B++,0)))}(o,c)||2==p&&Lc(o)))switch(m&&0<m.length&&(c=o.h,c.i=c.i.concat(m)),x){case 1:Br(o,5);break;case 4:Br(o,10);break;case 3:Br(o,6);break;default:Br(o,2)}}function Bm(o,c){let m=o.Ta+Math.floor(Math.random()*o.cb);return o.isActive()||(m*=2),m*c}function Br(o,c){if(o.j.info("Error code "+c),2==c){var m=E(o.fb,o),p=o.Xa;const x=!p;p=new Ur(p||"//www.google.com/images/cleardot.gif"),u.location&&"http"==u.location.protocol||Pa(p,"https"),ba(p),x?function tT(o,c){const m=new Ns;if(u.Image){const p=new Image;p.onload=V(or,m,"TestLoadImage: loaded",!0,c,p),p.onerror=V(or,m,"TestLoadImage: error",!1,c,p),p.onabort=V(or,m,"TestLoadImage: abort",!1,c,p),p.ontimeout=V(or,m,"TestLoadImage: timeout",!1,c,p),u.setTimeout(function(){p.ontimeout&&p.ontimeout()},1e4),p.src=o}else c(!1)}(p.toString(),m):function nT(o,c){new Ns;const p=new AbortController,x=setTimeout(()=>{p.abort(),or(0,0,!1,c)},1e4);fetch(o,{signal:p.signal}).then(k=>{clearTimeout(x),or(0,0,!!k.ok,c)}).catch(()=>{clearTimeout(x),or(0,0,!1,c)})}(p.toString(),m)}else bt(2);o.G=0,o.l&&o.l.sa(c),qm(o),km(o)}function qm(o){if(o.G=0,o.ka=[],o.l){const c=ym(o.h);(0!=c.length||0!=o.i.length)&&(U(o.ka,c),U(o.ka,o.i),o.h.i.length=0,q(o.i),o.i.length=0),o.l.ra()}}function Gm(o,c,m){var p=m instanceof Ur?Vn(m):new Ur(m);if(""!=p.g)c&&(p.g=c+"."+p.g),Sa(p,p.s);else{var x=u.location;p=x.protocol,c=c?c+"."+x.hostname:x.hostname,x=+x.port;var k=new Ur(null);p&&Pa(k,p),c&&(k.g=c),x&&Sa(k,x),m&&(k.l=m),p=k}return c=o.ya,(m=o.D)&&c&&Fe(p,m,c),Fe(p,"VER",o.la),Gs(o,p),p}function Km(o,c,m){if(c&&!o.J)throw Error("Can't create secondary domain capable XhrIo object.");return(c=new Qe(o.Ca&&!o.pa?new Ls({eb:m}):o.pa)).Ha(o.J),c}function zm(){}function ka(){}function Lt(o,c){Tt.call(this),this.g=new Nm(c),this.l=o,this.h=c&&c.messageUrlParams||null,o=c&&c.messageHeaders||null,c&&c.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=c&&c.initMessageHeaders||null,c&&c.messageContentType&&(o?o["X-WebChannel-Content-Type"]=c.messageContentType:o={"X-WebChannel-Content-Type":c.messageContentType}),c&&c.va&&(o?o["X-WebChannel-Client-Profile"]=c.va:o={"X-WebChannel-Client-Profile":c.va}),this.g.S=o,(o=c&&c.Sb)&&!Z(o)&&(this.g.m=o),this.v=c&&c.supportsCrossDomainXhr||!1,this.u=c&&c.sendRawJson||!1,(c=c&&c.httpSessionIdParam)&&!Z(c)&&(this.g.D=c,null!==(o=this.h)&&c in o&&c in(o=this.h)&&delete o[c]),this.j=new bi(this)}function jm(o){Sc.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var c=o.__sm__;if(c){e:{for(const m in c){o=m;break e}o=void 0}(this.i=o)&&(o=this.i,c=null!==c&&o in c?c[o]:void 0),this.data=c}else this.data=o}function $m(){bc.call(this),this.status=1}function bi(o){this.g=o}(r=Qe.prototype).Ha=function(o){this.J=o},r.ea=function(o,c,m,p){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);c=c?c.toUpperCase():"GET",this.D=o,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Vc.g(),this.v=function nm(o){return o.h||(o.h=o.i())}(this.o?this.o:Vc),this.g.onreadystatechange=E(this.Ea,this);try{this.B=!0,this.g.open(c,String(o),!0),this.B=!1}catch(k){return void bm(this,k)}if(o=m||"",m=new Map(this.headers),p)if(Object.getPrototypeOf(p)===Object.prototype)for(var x in p)m.set(x,p[x]);else{if("function"!=typeof p.keys||"function"!=typeof p.get)throw Error("Unknown input type for opt_headers: "+String(p));for(const k of p.keys())m.set(k,p.get(k))}p=Array.from(m.keys()).find(k=>"content-type"==k.toLowerCase()),x=u.FormData&&o instanceof u.FormData,!(0<=Array.prototype.indexOf.call(oT,c,void 0))||p||x||m.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[k,z]of m)this.g.setRequestHeader(k,z);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Cm(this),this.u=!0,this.g.send(o),this.u=!1}catch(k){bm(this,k)}},r.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=o||7,St(this,"complete"),St(this,"abort"),xa(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),xa(this,!0)),Qe.aa.N.call(this)},r.Ea=function(){this.s||(this.B||this.u||this.j?xm(this):this.bb())},r.bb=function(){xm(this)},r.isActive=function(){return!!this.g},r.Z=function(){try{return 2<xn(this)?this.g.status:-1}catch{return-1}},r.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},r.Oa=function(o){if(this.g){var c=this.g.responseText;return o&&0==c.indexOf(o)&&(c=c.substring(o.length)),Ly(c)}},r.Ba=function(){return this.m},r.Ka=function(){return"string"==typeof this.l?this.l:String(this.l)},(r=Nm.prototype).la=8,r.G=1,r.connect=function(o,c,m,p){bt(0),this.W=o,this.H=c||{},m&&void 0!==p&&(this.H.OSID=m,this.H.OAID=p),this.F=this.X,this.I=Gm(this,null,this.W),Da(this)},r.Ga=function(o){if(this.s)if(this.s=null,1==this.G){if(!o){this.U=Math.floor(1e5*Math.random()),o=this.U++;const x=new ir(this,this.j,o);let k=this.o;if(this.S&&(k?(k=I(k),P(k,this.S)):k=this.S),null!==this.m||this.O||(x.H=k,k=null),this.P)e:{for(var c=0,m=0;m<this.i.length;m++){var p=this.i[m];if(void 0===(p="__data__"in p.map&&"string"==typeof(p=p.map.__data__)?p.length:void 0))break;if(4096<(c+=p)){c=m;break e}if(4096===c||m===this.i.length-1){c=m+1;break e}}c=1e3}else c=1e3;c=Mm(this,x,c),Fe(m=Vn(this.I),"RID",o),Fe(m,"CVER",22),this.D&&Fe(m,"X-HTTP-Session-Id",this.D),Gs(this,m),k&&(this.O?c="headers="+encodeURIComponent(String(Sm(k)))+"&"+c:this.m&&Mc(m,this.m,k)),Oc(this.h,x),this.Ua&&Fe(m,"TYPE","init"),this.P?(Fe(m,"$req",c),Fe(m,"SID","null"),x.T=!0,Cc(x,m,null)):Cc(x,m,c),this.G=2}}else 3==this.G&&(o?Om(this,o):0==this.i.length||gm(this.h)||Om(this))},r.Fa=function(){if(this.u=null,Lm(this),this.ba&&!(this.M||null==this.g||0>=this.R)){var o=2*this.R;this.j.info("BP detection timer enabled: "+o),this.A=Ds(E(this.ab,this),o)}},r.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,bt(10),Ca(this),Lm(this))},r.Za=function(){null!=this.C&&(this.C=null,Ca(this),Lc(this),bt(19))},r.fb=function(o){o?(this.j.info("Successfully pinged google.com"),bt(2)):(this.j.info("Failed to ping google.com"),bt(1))},r.isActive=function(){return!!this.l&&this.l.isActive(this)},(r=zm.prototype).ua=function(){},r.ta=function(){},r.sa=function(){},r.ra=function(){},r.isActive=function(){return!0},r.Na=function(){},ka.prototype.g=function(o,c){return new Lt(o,c)},F(Lt,Tt),Lt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Lt.prototype.close=function(){Fc(this.g)},Lt.prototype.o=function(o){var c=this.g;if("string"==typeof o){var m={};m.__data__=o,o=m}else this.u&&((m={}).__data__=Rc(o),o=m);c.i.push(new jy(c.Ya++,o)),3==c.G&&Da(c)},Lt.prototype.N=function(){this.g.l=null,delete this.j,Fc(this.g),delete this.g,Lt.aa.N.call(this)},F(jm,Sc),F($m,bc),F(bi,zm),bi.prototype.ua=function(){St(this.g,"a")},bi.prototype.ta=function(o){St(this.g,new jm(o))},bi.prototype.sa=function(o){St(this.g,new $m)},bi.prototype.ra=function(){St(this.g,"b")},ka.prototype.createWebChannel=ka.prototype.g,Lt.prototype.send=Lt.prototype.o,Lt.prototype.open=Lt.prototype.m,Lt.prototype.close=Lt.prototype.close,Qs=Wt.createWebChannelTransport=function(){return new ka},$s=Wt.getStatEventTarget=function(){return va()},Di=Wt.Event=Fr,Ci=Wt.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Aa.NO_ERROR=0,Aa.TIMEOUT=8,Aa.HTTP_ERROR=6,zr=Wt.ErrorCode=Aa,um.COMPLETE="complete",js=Wt.EventType=um,rm.EventType=xs,xs.OPEN="a",xs.CLOSE="b",xs.ERROR="c",xs.MESSAGE="d",Tt.prototype.listen=Tt.prototype.K,On=Wt.WebChannel=rm,xi=Wt.FetchXmlHttpFactory=Ls,Qe.prototype.listenOnce=Qe.prototype.L,Qe.prototype.getLastError=Qe.prototype.Ka,Qe.prototype.getLastErrorCode=Qe.prototype.Ba,Qe.prototype.getStatus=Qe.prototype.Z,Qe.prototype.getResponseJson=Qe.prototype.Oa,Qe.prototype.getResponseText=Qe.prototype.oa,Qe.prototype.send=Qe.prototype.ea,Qe.prototype.setWithCredentials=Qe.prototype.Ha,zs=Wt.XhrIo=Qe}).apply(typeof Kr<"u"?Kr:typeof self<"u"?self:typeof window<"u"?window:{});const Ws="@firebase/firestore";class ke{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}ke.UNAUTHENTICATED=new ke(null),ke.GOOGLE_CREDENTIALS=new ke("google-credentials-uid"),ke.FIRST_PARTY=new ke("first-party-uid"),ke.MOCK_USER=new ke("mock-user");let dn="10.13.1";const Ht=new fe.Vy("@firebase/firestore");function Bt(){return Ht.logLevel}function M(r,...e){if(Ht.logLevel<=fe.$b.DEBUG){const t=e.map(Ni);Ht.debug(`Firestore (${dn}): ${r}`,...t)}}function Ge(r,...e){if(Ht.logLevel<=fe.$b.ERROR){const t=e.map(Ni);Ht.error(`Firestore (${dn}): ${r}`,...t)}}function ft(r,...e){if(Ht.logLevel<=fe.$b.WARN){const t=e.map(Ni);Ht.warn(`Firestore (${dn}): ${r}`,...t)}}function Ni(r){if("string"==typeof r)return r;try{return JSON.stringify(r)}catch{return r}}function $(r="Unexpected state"){const e=`FIRESTORE (${dn}) INTERNAL ASSERTION FAILED: `+r;throw Ge(e),new Error(e)}function X(r,e){r||$()}function G(r,e){return r}const D={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class L extends ee.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ke{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class qt{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Hs{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(ke.UNAUTHENTICATED))}shutdown(){}}class Mn{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Xs{constructor(e){this.t=e,this.currentUser=ke.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){var n=this;let i=this.i;const s=d=>this.i!==i?(i=this.i,t(d)):Promise.resolve();let a=new Ke;this.o=()=>{this.i++,this.currentUser=this.u(),a.resolve(),a=new Ke,e.enqueueRetryable(()=>s(this.currentUser))};const u=()=>{const d=a;e.enqueueRetryable((0,O.A)(function*(){yield d.promise,yield s(n.currentUser)}))},l=d=>{M("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=d,this.auth.addAuthTokenListener(this.o),u()};this.t.onInit(d=>l(d)),setTimeout(()=>{if(!this.auth){const d=this.t.getImmediate({optional:!0});d?l(d):(M("FirebaseAuthCredentialsProvider","Auth not yet detected"),a.resolve(),a=new Ke)}},0),u()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(n=>this.i!==e?(M("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):n?(X("string"==typeof n.accessToken),new qt(n.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return X(null===e||"string"==typeof e),new ke(e)}}class La{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=ke.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class jr{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new La(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(ke.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Js{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Ua{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=s=>{null!=s.error&&M("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);const a=s.token!==this.R;return this.R=s.token,M("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>n(s))};const i=s=>{M("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){const s=this.A.getImmediate({optional:!0});s?i(s):M("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(X("string"==typeof t.token),this.R=t.token,new Js(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function Ba(r){const e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(r);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let n=0;n<r;n++)t[n]=Math.floor(256*Math.random());return t}class Ys{static newId(){const t=62*Math.floor(256/62);let n="";for(;n.length<20;){const i=Ba(40);for(let s=0;s<i.length;++s)n.length<20&&i[s]<t&&(n+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(i[s]%62))}return n}}function re(r,e){return r<e?-1:r>e?1:0}function Fn(r,e,t){return r.length===e.length&&r.every((n,i)=>t(n,e[i]))}function Zs(r){return r+"\0"}class Ve{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new L(D.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new L(D.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new L(D.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new L(D.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Ve.fromMillis(Date.now())}static fromDate(e){return Ve.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Ve(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?re(this.nanoseconds,e.nanoseconds):re(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -62135596800).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class j{constructor(e){this.timestamp=e}static fromTimestamp(e){return new j(e)}static min(){return new j(new Ve(0,0))}static max(){return new j(new Ve(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class fn{constructor(e,t,n){void 0===t?t=0:t>e.length&&$(),void 0===n?n=e.length-t:n>e.length-t&&$(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===fn.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof fn?e.forEach(n=>{t.push(n)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let i=0;i<n;i++){const s=e.get(i),a=t.get(i);if(s<a)return-1;if(s>a)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class le extends fn{construct(e,t,n){return new le(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new L(D.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(i=>i.length>0))}return new le(t)}static emptyPath(){return new le([])}}const eo=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Pe extends fn{construct(e,t,n){return new Pe(e,t,n)}static isValidIdentifier(e){return eo.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Pe.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Pe(["__name__"])}static fromServerFormat(e){const t=[];let n="",i=0;const s=()=>{if(0===n.length)throw new L(D.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let a=!1;for(;i<e.length;){const u=e[i];if("\\"===u){if(i+1===e.length)throw new L(D.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const l=e[i+1];if("\\"!==l&&"."!==l&&"`"!==l)throw new L(D.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=l,i+=2}else"`"===u?(a=!a,i++):"."!==u||a?(n+=u,i++):(s(),i++)}if(s(),a)throw new L(D.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Pe(t)}static emptyPath(){return new Pe([])}}class K{constructor(e){this.path=e}static fromPath(e){return new K(le.fromString(e))}static fromName(e){return new K(le.fromString(e).popFirst(5))}static empty(){return new K(le.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===le.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return le.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new K(new le(e.slice()))}}class mn{constructor(e,t,n,i){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=i}}function ki(r){return r.fields.find(e=>2===e.kind)}function gn(r){return r.fields.filter(e=>2!==e.kind)}mn.UNKNOWN_ID=-1;class it{constructor(e,t){this.fieldPath=e,this.kind=t}}class Ln{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Ln(0,wt.min())}}function to(r,e){const t=r.toTimestamp().seconds,n=r.toTimestamp().nanoseconds+1,i=j.fromTimestamp(1e9===n?new Ve(t+1,0):new Ve(t,n));return new wt(i,K.empty(),e)}function Mi(r){return new wt(r.readTime,r.key,-1)}class wt{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new wt(j.min(),K.empty(),-1)}static max(){return new wt(j.max(),K.empty(),-1)}}function Ze(r,e){let t=r.readTime.compareTo(e.readTime);return 0!==t?t:(t=K.comparator(r.documentKey,e.documentKey),0!==t?t:re(r.largestBatchId,e.largestBatchId))}const lr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class no{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}function Vt(r){return Fi.apply(this,arguments)}function Fi(){return(Fi=(0,O.A)(function*(r){if(r.code!==D.FAILED_PRECONDITION||r.message!==lr)throw r;M("LocalStore","Unexpectedly lost primary lease")})).apply(this,arguments)}class b{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&$(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new b((n,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(n,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(n,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof b?t:b.resolve(t)}catch(t){return b.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):b.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):b.reject(t)}static resolve(e){return new b((t,n)=>{t(e)})}static reject(e){return new b((t,n)=>{n(e)})}static waitFor(e){return new b((t,n)=>{let i=0,s=0,a=!1;e.forEach(u=>{++i,u.next(()=>{++s,a&&s===i&&t()},l=>n(l))}),a=!0,s===i&&t()})}static or(e){let t=b.resolve(!1);for(const n of e)t=t.next(i=>i?b.resolve(i):n());return t}static forEach(e,t){const n=[];return e.forEach((i,s)=>{n.push(t.call(this,i,s))}),this.waitFor(n)}static mapArray(e,t){return new b((n,i)=>{const s=e.length,a=new Array(s);let u=0;for(let l=0;l<s;l++){const d=l;t(e[d]).next(g=>{a[d]=g,++u,u===s&&n(a)},g=>i(g))}})}static doWhile(e,t){return new b((n,i)=>{const s=()=>{!0===e()?t().next(()=>{s()},i):n()};s()})}}class cr{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new Ke,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new Un(e,t.error)):this.V.resolve()},this.transaction.onerror=n=>{const i=Bn(n.target.error);this.V.reject(new Un(e,i))}}static open(e,t,n,i){try{return new cr(t,e.transaction(i,n))}catch(s){throw new Un(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(M("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new Ga(t)}}class Gt{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===Gt.S((0,ee.ZQ)())&&Ge("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return M("SimpleDb","Removing database:",e),st(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,ee.zW)())return!1;if(Gt.v())return!0;const e=(0,ee.ZQ)(),t=Gt.S(e),n=0<t&&t<10,i=$r(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static v(){var e;return typeof process<"u"&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.C)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}M(e){var t=this;return(0,O.A)(function*(){return t.db||(M("SimpleDb","Opening database:",t.name),t.db=yield new Promise((n,i)=>{const s=indexedDB.open(t.name,t.version);s.onsuccess=a=>{n(a.target.result)},s.onblocked=()=>{i(new Un(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=a=>{const u=a.target.error;i("VersionError"===u.name?new L(D.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh."):"InvalidStateError"===u.name?new L(D.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+u):new Un(e,u))},s.onupgradeneeded=a=>{M("SimpleDb",'Database "'+t.name+'" requires upgrade from version:',a.oldVersion),t.p.O(a.target.result,s.transaction,a.oldVersion,t.version).next(()=>{M("SimpleDb","Database upgrade to version "+t.version+" complete")})}})),t.N&&(t.db.onversionchange=n=>t.N(n)),t.db})()}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,n,i){var s=this;return(0,O.A)(function*(){const a="readonly"===t;let u=0;for(;;){++u;try{s.db=yield s.M(e);const l=cr.open(s.db,e,a?"readonly":"readwrite",n),d=i(l).next(g=>(l.g(),g)).catch(g=>(l.abort(g),b.reject(g))).toPromise();return d.catch(()=>{}),yield l.m,d}catch(l){const d=l,g="FirebaseError"!==d.name&&u<3;if(M("SimpleDb","Transaction failed with error:",d.message,"Retrying:",g),s.close(),!g)return Promise.reject(d)}}})()}close(){this.db&&this.db.close(),this.db=void 0}}function $r(r){const e=r.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}class ro{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return st(this.B.delete())}}class Un extends L{constructor(e,t){super(D.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Yt(r){return"IndexedDbTransactionError"===r.name}class Ga{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(M("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(M("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),st(n)}add(e){return M("SimpleDb","ADD",this.store.name,e,e),st(this.store.add(e))}get(e){return st(this.store.get(e)).next(t=>(void 0===t&&(t=null),M("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return M("SimpleDb","DELETE",this.store.name,e),st(this.store.delete(e))}count(){return M("SimpleDb","COUNT",this.store.name),st(this.store.count())}U(e,t){const n=this.options(e,t),i=n.index?this.store.index(n.index):this.store;if("function"==typeof i.getAll){const s=i.getAll(n.range);return new b((a,u)=>{s.onerror=l=>{u(l.target.error)},s.onsuccess=l=>{a(l.target.result)}})}{const s=this.cursor(n),a=[];return this.W(s,(u,l)=>{a.push(l)}).next(()=>a)}}G(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new b((i,s)=>{n.onerror=a=>{s(a.target.error)},n.onsuccess=a=>{i(a.target.result)}})}j(e,t){M("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const i=this.cursor(n);return this.W(i,(s,a,u)=>u.delete())}J(e,t){let n;t?n=e:(n={},t=e);const i=this.cursor(n);return this.W(i,t)}Y(e){const t=this.cursor({});return new b((n,i)=>{t.onerror=s=>{const a=Bn(s.target.error);i(a)},t.onsuccess=s=>{const a=s.target.result;a?e(a.primaryKey,a.value).next(u=>{u?a.continue():n()}):n()}})}W(e,t){const n=[];return new b((i,s)=>{e.onerror=a=>{s(a.target.error)},e.onsuccess=a=>{const u=a.target.result;if(!u)return void i();const l=new ro(u),d=t(u.primaryKey,u.value,l);if(d instanceof b){const g=d.catch(y=>(l.done(),b.reject(y)));n.push(g)}l.isDone?i():null===l.K?u.continue():u.continue(l.K)}}).next(()=>b.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function st(r){return new b((e,t)=>{r.onsuccess=n=>{e(n.target.result)},r.onerror=n=>{const i=Bn(n.target.error);t(i)}})}let Ot=!1;function Bn(r){const e=Gt.S((0,ee.ZQ)());if(e>=12.2&&e<13){const t="An internal error was encountered in the Indexed Database server";if(r.message.indexOf(t)>=0){const n=new L("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ot||(Ot=!0,setTimeout(()=>{throw n},0)),n}}return r}class Ka{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){var t=this;M("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(0,O.A)(function*(){t.task=null;try{M("IndexBackfiller",`Documents written: ${yield t.Z.ee()}`)}catch(n){Yt(n)?M("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",n):yield Vt(n)}yield t.X(6e4)}))}}class za{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){var t=this;return(0,O.A)(function*(){return t.persistence.runTransaction("Backfill Indexes","readwrite-primary",n=>t.te(n,e))})()}te(e,t){const n=new Set;let i=t,s=!0;return b.doWhile(()=>!0===s&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(a=>{if(null!==a&&!n.has(a))return M("IndexBackfiller",`Processing collection: ${a}`),this.ne(e,a,i).next(u=>{i-=u,n.add(a)});s=!1})).next(()=>t-i)}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,n).next(s=>{const a=s.changes;return this.localStore.indexManager.updateIndexEntries(e,a).next(()=>this.re(i,s)).next(u=>(M("IndexBackfiller",`Updating offset: ${u}`),this.localStore.indexManager.updateCollectionGroup(e,t,u))).next(()=>a.size)}))}re(e,t){let n=e;return t.changes.forEach((i,s)=>{const a=Mi(s);Ze(a,n)>0&&(n=a)}),new wt(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}let Xe=(()=>{class r{constructor(t,n){this.previousValue=t,n&&(n.sequenceNumberHandler=i=>this.ie(i),this.se=i=>n.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.se&&this.se(t),t}}return r.oe=-1,r})();function Xt(r){return null==r}function qn(r){return 0===r&&1/r==-1/0}function io(r){return"number"==typeof r&&Number.isInteger(r)&&!qn(r)&&r<=Number.MAX_SAFE_INTEGER&&r>=Number.MIN_SAFE_INTEGER}function et(r){let e="";for(let t=0;t<r.length;t++)e.length>0&&(e=so(e)),e=ja(r.get(t),e);return so(e)}function ja(r,e){let t=e;const n=r.length;for(let i=0;i<n;i++){const s=r.charAt(i);switch(s){case"\0":t+="\x01\x10";break;case"\x01":t+="\x01\x11";break;default:t+=s}}return t}function so(r){return r+"\x01\x01"}function Kt(r){const e=r.length;if(X(e>=2),2===e)return X("\x01"===r.charAt(0)&&"\x01"===r.charAt(1)),le.emptyPath();const t=e-2,n=[];let i="";for(let s=0;s<e;){const a=r.indexOf("\x01",s);switch((a<0||a>t)&&$(),r.charAt(a+1)){case"\x01":const u=r.substring(s,a);let l;0===i.length?l=u:(i+=u,l=i,i=""),n.push(l);break;case"\x10":i+=r.substring(s,a),i+="\0";break;case"\x11":i+=r.substring(s,a+1);break;default:$()}s=a+2}return new le(n)}const oo=["userId","batchId"];function hr(r,e){return[r,et(e)]}function Li(r,e,t){return[r,et(e),t]}const Qr={},Ui=["prefixPath","collectionGroup","readTime","documentId"],$a=["prefixPath","collectionGroup","documentId"],Qa=["collectionGroup","readTime","prefixPath","documentId"],ao=["canonicalId","targetId"],Wa=["targetId","path"],Ha=["path","targetId"],at=["collectionId","parent"],Bi=["indexId","uid"],Xa=["uid","sequenceNumber"],Gn=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],uo=["indexId","uid","orderedDocumentKey"],Ja=["userId","collectionPath","documentId"],Ya=["userId","collectionPath","largestBatchId"],Mt=["userId","collectionGroup","largestBatchId"],lo=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Za=[...lo,"documentOverlays"],co=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ho=co,Wr=[...ho,"indexConfiguration","indexState","indexEntries"],pn=Wr,eu=[...Wr,"globals"];class qi extends no{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function je(r,e){const t=G(r);return Gt.F(t._e,e)}function fo(r){let e=0;for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e++;return e}function Zt(r,e){for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e(t,r[t])}function Gi(r){for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e))return!1;return!0}class Te{constructor(e,t){this.comparator=e,this.root=t||tt.EMPTY}insert(e,t){return new Te(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tt.BLACK,null,null))}remove(e){return new Te(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const i=this.comparator(e,n.key);if(0===i)return t+n.left.size;i<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){const e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new dr(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new dr(this.root,e,this.comparator,!1)}getReverseIterator(){return new dr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new dr(this.root,e,this.comparator,!0)}}class dr{constructor(e,t,n,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tt{constructor(e,t,n,i,s){this.key=e,this.value=t,this.color=null!=n?n:tt.RED,this.left=null!=i?i:tt.EMPTY,this.right=null!=s?s:tt.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,i,s){return new tt(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=i?i:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let i=this;const s=n(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,n),null):0===s?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return tt.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===t(e,i.key)){if(i.right.isEmpty())return tt.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,tt.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,tt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw $();const e=this.left.check();if(e!==this.right.check())throw $();return e+(this.isRed()?0:1)}}tt.EMPTY=null,tt.RED=!0,tt.BLACK=!1,tt.EMPTY=new class{constructor(){this.size=0}get key(){throw $()}get value(){throw $()}get color(){throw $()}get left(){throw $()}get right(){throw $()}copy(e,t,n,i,s){return this}insert(e,t,n){return new tt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ie{constructor(e){this.comparator=e,this.data=new Te(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const i=n.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new go(this.data.getIterator())}getIteratorFrom(e){return new go(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(n=>{t=t.add(n)}),t}isEqual(e){if(!(e instanceof Ie)||this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const i=t.getNext().key,s=n.getNext().key;if(0!==this.comparator(i,s))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new Ie(this.comparator);return t.data=e,t}}class go{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Kn(r){return r.hasNext()?r.getNext():void 0}class ut{constructor(e){this.fields=e,e.sort(Pe.comparator)}static empty(){return new ut([])}unionWith(e){let t=new Ie(Pe.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new ut(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Fn(this.fields,e.fields,(t,n)=>t.isEqual(n))}}class po extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class Oe{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new po("Invalid base64 string: "+s):s}}(e);return new Oe(t)}static fromUint8Array(e){const t=function(i){let s="";for(let a=0;a<i.length;++a)s+=String.fromCharCode(i[a]);return s}(e);return new Oe(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(t){const n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return re(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Oe.EMPTY_BYTE_STRING=new Oe("");const nu=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function zt(r){if(X(!!r),"string"==typeof r){let e=0;const t=nu.exec(r);if(X(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}const n=new Date(r);return{seconds:Math.floor(n.getTime()/1e3),nanos:e}}return{seconds:xe(r.seconds),nanos:xe(r.nanos)}}function xe(r){return"number"==typeof r?r:"string"==typeof r?Number(r):0}function Ft(r){return"string"==typeof r?Oe.fromBase64String(r):Oe.fromUint8Array(r)}function fr(r){var e,t;return"server_timestamp"===(null===(t=((null===(e=null==r?void 0:r.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function mr(r){const e=r.mapValue.fields.__previous_value__;return fr(e)?mr(e):e}function zn(r){const e=zt(r.mapValue.fields.__local_write_time__.timestampValue);return new Ve(e.seconds,e.nanos)}class Gc{constructor(e,t,n,i,s,a,u,l,d){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=i,this.ssl=s,this.forceLongPolling=a,this.autoDetectLongPolling=u,this.longPollingOptions=l,this.useFetchStreams=d}}class _n{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new _n("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof _n&&e.projectId===this.projectId&&e.database===this.database}}const yn={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Hr={nullValue:"NULL_VALUE"};function en(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?fr(r)?4:$t(r)?9007199254740991:pr(r)?10:11:$()}function jt(r,e){if(r===e)return!0;const t=en(r);if(t!==en(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===e.booleanValue;case 4:return zn(r).isEqual(zn(e));case 3:return function(i,s){if("string"==typeof i.timestampValue&&"string"==typeof s.timestampValue&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;const a=zt(i.timestampValue),u=zt(s.timestampValue);return a.seconds===u.seconds&&a.nanos===u.nanos}(r,e);case 5:return r.stringValue===e.stringValue;case 6:return s=e,Ft(r.bytesValue).isEqual(Ft(s.bytesValue));case 7:return r.referenceValue===e.referenceValue;case 8:return function(i,s){return xe(i.geoPointValue.latitude)===xe(s.geoPointValue.latitude)&&xe(i.geoPointValue.longitude)===xe(s.geoPointValue.longitude)}(r,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return xe(i.integerValue)===xe(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){const a=xe(i.doubleValue),u=xe(s.doubleValue);return a===u?qn(a)===qn(u):isNaN(a)&&isNaN(u)}return!1}(r,e);case 9:return Fn(r.arrayValue.values||[],e.arrayValue.values||[],jt);case 10:case 11:return function(i,s){const a=i.mapValue.fields||{},u=s.mapValue.fields||{};if(fo(a)!==fo(u))return!1;for(const l in a)if(a.hasOwnProperty(l)&&(void 0===u[l]||!jt(a[l],u[l])))return!1;return!0}(r,e);default:return $()}var s}function gr(r,e){return void 0!==(r.values||[]).find(t=>jt(t,e))}function tn(r,e){if(r===e)return 0;const t=en(r),n=en(e);if(t!==n)return re(t,n);switch(t){case 0:case 9007199254740991:return 0;case 1:return re(r.booleanValue,e.booleanValue);case 2:return function(s,a){const u=xe(s.integerValue||s.doubleValue),l=xe(a.integerValue||a.doubleValue);return u<l?-1:u>l?1:u===l?0:isNaN(u)?isNaN(l)?0:-1:1}(r,e);case 3:return _o(r.timestampValue,e.timestampValue);case 4:return _o(zn(r),zn(e));case 5:return re(r.stringValue,e.stringValue);case 6:return function(s,a){const u=Ft(s),l=Ft(a);return u.compareTo(l)}(r.bytesValue,e.bytesValue);case 7:return function(s,a){const u=s.split("/"),l=a.split("/");for(let d=0;d<u.length&&d<l.length;d++){const g=re(u[d],l[d]);if(0!==g)return g}return re(u.length,l.length)}(r.referenceValue,e.referenceValue);case 8:return function(s,a){const u=re(xe(s.latitude),xe(a.latitude));return 0!==u?u:re(xe(s.longitude),xe(a.longitude))}(r.geoPointValue,e.geoPointValue);case 9:return yo(r.arrayValue,e.arrayValue);case 10:return function(s,a){var u,l,d,g;const V=null===(u=(s.fields||{}).value)||void 0===u?void 0:u.arrayValue,F=null===(l=(a.fields||{}).value)||void 0===l?void 0:l.arrayValue,q=re((null===(d=null==V?void 0:V.values)||void 0===d?void 0:d.length)||0,(null===(g=null==F?void 0:F.values)||void 0===g?void 0:g.length)||0);return 0!==q?q:yo(V,F)}(r.mapValue,e.mapValue);case 11:return function(s,a){if(s===yn.mapValue&&a===yn.mapValue)return 0;if(s===yn.mapValue)return 1;if(a===yn.mapValue)return-1;const u=s.fields||{},l=Object.keys(u),d=a.fields||{},g=Object.keys(d);l.sort(),g.sort();for(let y=0;y<l.length&&y<g.length;++y){const E=re(l[y],g[y]);if(0!==E)return E;const V=tn(u[l[y]],d[g[y]]);if(0!==V)return V}return re(l.length,g.length)}(r.mapValue,e.mapValue);default:throw $()}}function _o(r,e){if("string"==typeof r&&"string"==typeof e&&r.length===e.length)return re(r,e);const t=zt(r),n=zt(e),i=re(t.seconds,n.seconds);return 0!==i?i:re(t.nanos,n.nanos)}function yo(r,e){const t=r.values||[],n=e.values||[];for(let i=0;i<t.length&&i<n.length;++i){const s=tn(t[i],n[i]);if(s)return s}return re(t.length,n.length)}function Tn(r){return Ki(r)}function Ki(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(t){const n=zt(t);return`time(${n.seconds},${n.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?Ft(r.bytesValue).toBase64():"referenceValue"in r?K.fromName(r.referenceValue).toString():"geoPointValue"in r?function(t){return`geo(${t.latitude},${t.longitude})`}(r.geoPointValue):"arrayValue"in r?function(t){let n="[",i=!0;for(const s of t.values||[])i?i=!1:n+=",",n+=Ki(s);return n+"]"}(r.arrayValue):"mapValue"in r?function(t){const n=Object.keys(t.fields||{}).sort();let i="{",s=!0;for(const a of n)s?s=!1:i+=",",i+=`${a}:${Ki(t.fields[a])}`;return i+"}"}(r.mapValue):$()}function nn(r,e){return{referenceValue:`projects/${r.projectId}/databases/${r.database}/documents/${e.path.canonicalString()}`}}function To(r){return!!r&&"integerValue"in r}function Xr(r){return!!r&&"arrayValue"in r}function Io(r){return!!r&&"nullValue"in r}function Eo(r){return!!r&&"doubleValue"in r&&isNaN(Number(r.doubleValue))}function In(r){return!!r&&"mapValue"in r}function pr(r){var e,t;return"__vector__"===(null===(t=((null===(e=null==r?void 0:r.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function jn(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&"object"==typeof r.timestampValue)return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){const e={mapValue:{fields:{}}};return Zt(r.mapValue.fields,(t,n)=>e.mapValue.fields[t]=jn(n)),e}if(r.arrayValue){const e={arrayValue:{values:[]}};for(let t=0;t<(r.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=jn(r.arrayValue.values[t]);return e}return Object.assign({},r)}function $t(r){return"__max__"===(((r.mapValue||{}).fields||{}).__type__||{}).stringValue}const ji={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function vo(r){return"nullValue"in r?Hr:"booleanValue"in r?{booleanValue:!1}:"integerValue"in r||"doubleValue"in r?{doubleValue:NaN}:"timestampValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in r?{stringValue:""}:"bytesValue"in r?{bytesValue:""}:"referenceValue"in r?nn(_n.empty(),K.empty()):"geoPointValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in r?{arrayValue:{}}:"mapValue"in r?pr(r)?ji:{mapValue:{}}:$()}function ru(r){return"nullValue"in r?{booleanValue:!1}:"booleanValue"in r?{doubleValue:NaN}:"integerValue"in r||"doubleValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in r?{stringValue:""}:"stringValue"in r?{bytesValue:""}:"bytesValue"in r?nn(_n.empty(),K.empty()):"referenceValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in r?{arrayValue:{}}:"arrayValue"in r?ji:"mapValue"in r?pr(r)?{mapValue:{}}:yn:$()}function Ao(r,e){const t=tn(r.value,e.value);return 0!==t?t:r.inclusive&&!e.inclusive?-1:!r.inclusive&&e.inclusive?1:0}function wo(r,e){const t=tn(r.value,e.value);return 0!==t?t:r.inclusive&&!e.inclusive?1:!r.inclusive&&e.inclusive?-1:0}class nt{constructor(e){this.value=e}static empty(){return new nt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!In(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=jn(t)}setAll(e){let t=Pe.emptyPath(),n={},i=[];e.forEach((a,u)=>{if(!t.isImmediateParentOf(u)){const l=this.getFieldsMap(t);this.applyChanges(l,n,i),n={},i=[],t=u.popLast()}a?n[u.lastSegment()]=jn(a):i.push(u.lastSegment())});const s=this.getFieldsMap(t);this.applyChanges(s,n,i)}delete(e){const t=this.field(e.popLast());In(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return jt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let i=t.mapValue.fields[e.get(n)];In(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,n){Zt(t,(i,s)=>e[i]=s);for(const i of n)delete e[i]}clone(){return new nt(jn(this.value))}}function Ro(r){const e=[];return Zt(r.fields,(t,n)=>{const i=new Pe([t]);if(In(n)){const s=Ro(n.mapValue).fields;if(0===s.length)e.push(i);else for(const a of s)e.push(i.child(a))}else e.push(i)}),new ut(e)}class Ce{constructor(e,t,n,i,s,a,u){this.key=e,this.documentType=t,this.version=n,this.readTime=i,this.createTime=s,this.data=a,this.documentState=u}static newInvalidDocument(e){return new Ce(e,0,j.min(),j.min(),j.min(),nt.empty(),0)}static newFoundDocument(e,t,n,i){return new Ce(e,1,t,j.min(),n,i,0)}static newNoDocument(e,t){return new Ce(e,2,t,j.min(),j.min(),nt.empty(),0)}static newUnknownDocument(e,t){return new Ce(e,3,t,j.min(),j.min(),nt.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(j.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=j.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ce&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ce(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class rn{constructor(e,t){this.position=e,this.inclusive=t}}function $i(r,e,t){let n=0;for(let i=0;i<r.position.length;i++){const s=e[i],a=r.position[i];if(n=s.field.isKeyField()?K.comparator(K.fromName(a.referenceValue),t.key):tn(a,t.data.field(s.field)),"desc"===s.dir&&(n*=-1),0!==n)break}return n}function _r(r,e){if(null===r)return null===e;if(null===e||r.inclusive!==e.inclusive||r.position.length!==e.position.length)return!1;for(let t=0;t<r.position.length;t++)if(!jt(r.position[t],e.position[t]))return!1;return!0}class yr{constructor(e,t="asc"){this.field=e,this.dir=t}}function iu(r,e){return r.dir===e.dir&&r.field.isEqual(e.field)}class Po{}class he extends Po{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new N(e,t,n):"array-contains"===t?new te(e,n):"in"===t?new oe(e,n):"not-in"===t?new Le(e,n):"array-contains-any"===t?new $e(e,n):new he(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new B(e,n):new Q(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(tn(t,this.value)):null!==t&&en(this.value)===en(t)&&this.matchesComparison(tn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return $()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class ye extends Po{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new ye(e,t)}matches(e){return Tr(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function Tr(r){return"and"===r.op}function So(r){return"or"===r.op}function bo(r){return f(r)&&Tr(r)}function f(r){for(const e of r.filters)if(e instanceof ye)return!1;return!0}function h(r){if(r instanceof he)return r.field.canonicalString()+r.op.toString()+Tn(r.value);if(bo(r))return r.filters.map(e=>h(e)).join(",");{const e=r.filters.map(t=>h(t)).join(",");return`${r.op}(${e})`}}function _(r,e){return r instanceof he?(n=r,(i=e)instanceof he&&n.op===i.op&&n.field.isEqual(i.field)&&jt(n.value,i.value)):r instanceof ye?function(n,i){return i instanceof ye&&n.op===i.op&&n.filters.length===i.filters.length&&n.filters.reduce((s,a,u)=>s&&_(a,i.filters[u]),!0)}(r,e):void $();var n,i}function T(r,e){const t=r.filters.concat(e);return ye.create(t,r.op)}function w(r){return r instanceof he?`${(t=r).field.canonicalString()} ${t.op} ${Tn(t.value)}`:r instanceof ye?function(t){return t.op.toString()+" {"+t.getFilters().map(w).join(" ,")+"}"}(r):"Filter";var t}class N extends he{constructor(e,t,n){super(e,t,n),this.key=K.fromName(n.referenceValue)}matches(e){const t=K.comparator(e.key,this.key);return this.matchesComparison(t)}}class B extends he{constructor(e,t){super(e,"in",t),this.keys=W(0,t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class Q extends he{constructor(e,t){super(e,"not-in",t),this.keys=W(0,t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function W(r,e){var t;return((null===(t=e.arrayValue)||void 0===t?void 0:t.values)||[]).map(n=>K.fromName(n.referenceValue))}class te extends he{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Xr(t)&&gr(t.arrayValue,this.value)}}class oe extends he{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&gr(this.value.arrayValue,t)}}class Le extends he{constructor(e,t){super(e,"not-in",t)}matches(e){if(gr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!gr(this.value.arrayValue,t)}}class $e extends he{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Xr(t)||!t.arrayValue.values)&&t.arrayValue.values.some(n=>gr(this.value.arrayValue,n))}}class Ue{constructor(e,t=null,n=[],i=[],s=null,a=null,u=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=i,this.limit=s,this.startAt=a,this.endAt=u,this.ue=null}}function Se(r,e=null,t=[],n=[],i=null,s=null,a=null){return new Ue(r,e,t,n,i,s,a)}function ze(r){const e=G(r);if(null===e.ue){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(n=>h(n)).join(","),t+="|ob:",t+=e.orderBy.map(n=>{return(s=n).field.canonicalString()+s.dir;var s}).join(","),Xt(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(n=>Tn(n)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(n=>Tn(n)).join(",")),e.ue=t}return e.ue}function De(r,e){if(r.limit!==e.limit||r.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<r.orderBy.length;t++)if(!iu(r.orderBy[t],e.orderBy[t]))return!1;if(r.filters.length!==e.filters.length)return!1;for(let t=0;t<r.filters.length;t++)if(!_(r.filters[t],e.filters[t]))return!1;return r.collectionGroup===e.collectionGroup&&!!r.path.isEqual(e.path)&&!!_r(r.startAt,e.startAt)&&_r(r.endAt,e.endAt)}function xt(r){return K.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length}function Ct(r,e){return r.filters.filter(t=>t instanceof he&&t.field.isEqual(e))}function rt(r,e,t){let n=Hr,i=!0;for(const s of Ct(r,e)){let a=Hr,u=!0;switch(s.op){case"<":case"<=":a=vo(s.value);break;case"==":case"in":case">=":a=s.value;break;case">":a=s.value,u=!1;break;case"!=":case"not-in":a=Hr}Ao({value:n,inclusive:i},{value:a,inclusive:u})<0&&(n=a,i=u)}if(null!==t)for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(e)){const a=t.position[s];Ao({value:n,inclusive:i},{value:a,inclusive:t.inclusive})<0&&(n=a,i=t.inclusive);break}return{value:n,inclusive:i}}function Je(r,e,t){let n=yn,i=!0;for(const s of Ct(r,e)){let a=yn,u=!0;switch(s.op){case">=":case">":a=ru(s.value),u=!1;break;case"==":case"in":case"<=":a=s.value;break;case"<":a=s.value,u=!1;break;case"!=":case"not-in":a=yn}wo({value:n,inclusive:i},{value:a,inclusive:u})>0&&(n=a,i=u)}if(null!==t)for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(e)){const a=t.position[s];wo({value:n,inclusive:i},{value:a,inclusive:t.inclusive})>0&&(n=a,i=t.inclusive);break}return{value:n,inclusive:i}}class mt{constructor(e,t=null,n=[],i=[],s=null,a="F",u=null,l=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=i,this.limit=s,this.limitType=a,this.startAt=u,this.endAt=l,this.ce=null,this.le=null,this.he=null}}function En(r,e,t,n,i,s,a,u){return new mt(r,e,t,n,i,s,a,u)}function sn(r){return new mt(r)}function $n(r){return 0===r.filters.length&&null===r.limit&&null==r.startAt&&null==r.endAt&&(0===r.explicitOrderBy.length||1===r.explicitOrderBy.length&&r.explicitOrderBy[0].field.isKeyField())}function Ir(r){return null!==r.collectionGroup}function Jr(r){const e=G(r);if(null===e.ce){e.ce=[];const t=new Set;for(const s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(a){let u=new Ie(Pe.comparator);return a.filters.forEach(l=>{l.getFlattenedFilters().forEach(d=>{d.isInequality()&&(u=u.add(d.field))})}),u})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new yr(s,n))}),t.has(Pe.keyField().canonicalString())||e.ce.push(new yr(Pe.keyField(),n))}return e.ce}function gt(r){const e=G(r);return e.le||(e.le=function zc(r,e){if("F"===r.limitType)return Se(r.path,r.collectionGroup,e,r.filters,r.limit,r.startAt,r.endAt);{e=e.map(i=>new yr(i.field,"desc"===i.dir?"asc":"desc"));const t=r.endAt?new rn(r.endAt.position,r.endAt.inclusive):null,n=r.startAt?new rn(r.startAt.position,r.startAt.inclusive):null;return Se(r.path,r.collectionGroup,e,r.filters,r.limit,t,n)}}(e,Jr(r))),e.le}function su(r,e){const t=r.filters.concat([e]);return new mt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),t,r.limit,r.limitType,r.startAt,r.endAt)}function Vo(r,e,t){return new mt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),e,t,r.startAt,r.endAt)}function Qi(r,e){return De(gt(r),gt(e))&&r.limitType===e.limitType}function jc(r){return`${ze(gt(r))}|lt:${r.limitType}`}function Yr(r){return`Query(target=${function(t){let n=t.path.canonicalString();return null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(i=>w(i)).join(", ")}]`),Xt(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(i=>{return`${(a=i).field.canonicalString()} (${a.dir})`;var a}).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(i=>Tn(i)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(i=>Tn(i)).join(",")),`Target(${n})`}(gt(r))}; limitType=${r.limitType})`}function Wi(r,e){return e.isFoundDocument()&&function(n,i){const s=i.key.path;return null!==n.collectionGroup?i.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(s):K.isDocumentKey(n.path)?n.path.isEqual(s):n.path.isImmediateParentOf(s)}(r,e)&&function(n,i){for(const s of Jr(n))if(!s.field.isKeyField()&&null===i.data.field(s.field))return!1;return!0}(r,e)&&function(n,i){for(const s of n.filters)if(!s.matches(i))return!1;return!0}(r,e)&&(i=e,!((n=r).startAt&&!function(a,u,l){const d=$i(a,u,l);return a.inclusive?d<=0:d<0}(n.startAt,Jr(n),i)||n.endAt&&!function(a,u,l){const d=$i(a,u,l);return a.inclusive?d>=0:d>0}(n.endAt,Jr(n),i)));var n,i}function $c(r){return r.collectionGroup||(r.path.length%2==1?r.path.lastSegment():r.path.get(r.path.length-2))}function Qc(r){return(e,t)=>{let n=!1;for(const i of Jr(r)){const s=Qm(i,e,t);if(0!==s)return s;n=n||i.field.isKeyField()}return 0}}function Qm(r,e,t){const n=r.field.isKeyField()?K.comparator(e.key,t.key):function(s,a,u){const l=a.data.field(s),d=u.data.field(s);return null!==l&&null!==d?tn(l,d):$()}(r.field,e,t);switch(r.dir){case"asc":return n;case"desc":return-1*n;default:return $()}}class vn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[i,s]of n)if(this.equalsFn(i,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),i=this.inner[n];if(void 0===i)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],e))return 1===n.length?delete this.inner[t]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(e){Zt(this.inner,(t,n)=>{for(const[i,s]of n)e(i,s)})}isEmpty(){return Gi(this.inner)}size(){return this.innerSize}}const Wm=new Te(K.comparator);function Dt(){return Wm}const Wc=new Te(K.comparator);function Hi(...r){let e=Wc;for(const t of r)e=e.insert(t.key,t);return e}function Hc(r){let e=Wc;return r.forEach((t,n)=>e=e.insert(t,n.overlayedDocument)),e}function on(){return Xi()}function Xc(){return Xi()}function Xi(){return new vn(r=>r.toString(),(r,e)=>r.isEqual(e))}const Hm=new Te(K.comparator),Xm=new Ie(K.comparator);function ae(...r){let e=Xm;for(const t of r)e=e.add(t);return e}const Jm=new Ie(re);function ou(){return Jm}function au(r,e){if(r.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:qn(e)?"-0":e}}function Jc(r){return{integerValue:""+r}}function Yc(r,e){return io(e)?Jc(e):au(r,e)}class xo{constructor(){this._=void 0}}function Ym(r,e,t){return r instanceof Zr?function(i,s){const a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&fr(s)&&(s=mr(s)),s&&(a.fields.__previous_value__=s),{mapValue:a}}(t,e):r instanceof Er?eh(r,e):r instanceof vr?th(r,e):function(i,s){const a=Zc(i,s),u=nh(a)+nh(i.Pe);return To(a)&&To(i.Pe)?Jc(u):au(i.serializer,u)}(r,e)}function Zm(r,e,t){return r instanceof Er?eh(r,e):r instanceof vr?th(r,e):t}function Zc(r,e){return r instanceof ei?To(n=e)||(s=n)&&"doubleValue"in s?e:{integerValue:0}:null;var n,s}class Zr extends xo{}class Er extends xo{constructor(e){super(),this.elements=e}}function eh(r,e){const t=rh(e);for(const n of r.elements)t.some(i=>jt(i,n))||t.push(n);return{arrayValue:{values:t}}}class vr extends xo{constructor(e){super(),this.elements=e}}function th(r,e){let t=rh(e);for(const n of r.elements)t=t.filter(i=>!jt(i,n));return{arrayValue:{values:t}}}class ei extends xo{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function nh(r){return xe(r.integerValue||r.doubleValue)}function rh(r){return Xr(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}class Ji{constructor(e,t){this.field=e,this.transform=t}}class tg{constructor(e,t){this.version=e,this.transformResults=t}}class Be{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Be}static exists(e){return new Be(void 0,e)}static updateTime(e){return new Be(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Co(r,e){return void 0!==r.updateTime?e.isFoundDocument()&&e.version.isEqual(r.updateTime):void 0===r.exists||r.exists===e.isFoundDocument()}class Do{}function ih(r,e){if(!r.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return r.isNoDocument()?new ni(r.key,Be.none()):new ti(r.key,r.data,Be.none());{const t=r.data,n=nt.empty();let i=new Ie(Pe.comparator);for(let s of e.fields)if(!i.has(s)){let a=t.field(s);null===a&&s.length>1&&(s=s.popLast(),a=t.field(s)),null===a?n.delete(s):n.set(s,a),i=i.add(s)}return new An(r.key,n,new ut(i.toArray()),Be.none())}}function ng(r,e,t){r instanceof ti?function(i,s,a){const u=i.value.clone(),l=ah(i.fieldTransforms,s,a.transformResults);u.setAll(l),s.convertToFoundDocument(a.version,u).setHasCommittedMutations()}(r,e,t):r instanceof An?function(i,s,a){if(!Co(i.precondition,s))return void s.convertToUnknownDocument(a.version);const u=ah(i.fieldTransforms,s,a.transformResults),l=s.data;l.setAll(oh(i)),l.setAll(u),s.convertToFoundDocument(a.version,l).setHasCommittedMutations()}(r,e,t):e.convertToNoDocument(t.version).setHasCommittedMutations()}function Yi(r,e,t,n){return r instanceof ti?function(s,a,u,l){if(!Co(s.precondition,a))return u;const d=s.value.clone(),g=uh(s.fieldTransforms,l,a);return d.setAll(g),a.convertToFoundDocument(a.version,d).setHasLocalMutations(),null}(r,e,t,n):r instanceof An?function(s,a,u,l){if(!Co(s.precondition,a))return u;const d=uh(s.fieldTransforms,l,a),g=a.data;return g.setAll(oh(s)),g.setAll(d),a.convertToFoundDocument(a.version,g).setHasLocalMutations(),null===u?null:u.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(y=>y.field))}(r,e,t,n):(u=t,Co(r.precondition,a=e)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):u);var a,u}function rg(r,e){let t=null;for(const n of r.fieldTransforms){const i=e.data.field(n.field),s=Zc(n.transform,i||null);null!=s&&(null===t&&(t=nt.empty()),t.set(n.field,s))}return t||null}function sh(r,e){return r.type===e.type&&!!r.key.isEqual(e.key)&&!!r.precondition.isEqual(e.precondition)&&(i=e.fieldTransforms,!!(void 0===(n=r.fieldTransforms)&&void 0===i||n&&i&&Fn(n,i,(s,a)=>function eg(r,e){return r.field.isEqual(e.field)&&(i=e.transform,(n=r.transform)instanceof Er&&i instanceof Er||n instanceof vr&&i instanceof vr?Fn(n.elements,i.elements,jt):n instanceof ei&&i instanceof ei?jt(n.Pe,i.Pe):n instanceof Zr&&i instanceof Zr);var n,i}(s,a))))&&(0===r.type?r.value.isEqual(e.value):1!==r.type||r.data.isEqual(e.data)&&r.fieldMask.isEqual(e.fieldMask));var n,i}class ti extends Do{constructor(e,t,n,i=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class An extends Do{constructor(e,t,n,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function oh(r){const e=new Map;return r.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){const n=r.data.field(t);e.set(t,n)}}),e}function ah(r,e,t){const n=new Map;X(r.length===t.length);for(let i=0;i<t.length;i++){const s=r[i],a=s.transform,u=e.data.field(s.field);n.set(s.field,Zm(a,u,t[i]))}return n}function uh(r,e,t){const n=new Map;for(const i of r){const s=i.transform,a=t.data.field(i.field);n.set(i.field,Ym(s,a,e))}return n}class ni extends Do{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class uu extends Do{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class lu{constructor(e,t,n,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let i=0;i<this.mutations.length;i++){const s=this.mutations[i];s.key.isEqual(e.key)&&ng(s,e,n[i])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Yi(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Yi(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Xc();return this.mutations.forEach(i=>{const s=e.get(i.key),a=s.overlayedDocument;let u=this.applyToLocalView(a,s.mutatedFields);u=t.has(i.key)?null:u;const l=ih(a,u);null!==l&&n.set(i.key,l),a.isValidDocument()||a.convertToNoDocument(j.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),ae())}isEqual(e){return this.batchId===e.batchId&&Fn(this.mutations,e.mutations,(t,n)=>sh(t,n))&&Fn(this.baseMutations,e.baseMutations,(t,n)=>sh(t,n))}}class cu{constructor(e,t,n,i){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=i}static from(e,t,n){X(e.mutations.length===n.length);let i=function(){return Hm}();const s=e.mutations;for(let a=0;a<s.length;a++)i=i.insert(s[a].key,n[a].version);return new cu(e,t,n,i)}}class hu{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class ig{constructor(e,t){this.count=e,this.unchangedNames=t}}var Ye,me;function ch(r){switch(r){default:return $();case D.CANCELLED:case D.UNKNOWN:case D.DEADLINE_EXCEEDED:case D.RESOURCE_EXHAUSTED:case D.INTERNAL:case D.UNAVAILABLE:case D.UNAUTHENTICATED:return!1;case D.INVALID_ARGUMENT:case D.NOT_FOUND:case D.ALREADY_EXISTS:case D.PERMISSION_DENIED:case D.FAILED_PRECONDITION:case D.ABORTED:case D.OUT_OF_RANGE:case D.UNIMPLEMENTED:case D.DATA_LOSS:return!0}}function hh(r){if(void 0===r)return Ge("GRPC error has no .code"),D.UNKNOWN;switch(r){case Ye.OK:return D.OK;case Ye.CANCELLED:return D.CANCELLED;case Ye.UNKNOWN:return D.UNKNOWN;case Ye.DEADLINE_EXCEEDED:return D.DEADLINE_EXCEEDED;case Ye.RESOURCE_EXHAUSTED:return D.RESOURCE_EXHAUSTED;case Ye.INTERNAL:return D.INTERNAL;case Ye.UNAVAILABLE:return D.UNAVAILABLE;case Ye.UNAUTHENTICATED:return D.UNAUTHENTICATED;case Ye.INVALID_ARGUMENT:return D.INVALID_ARGUMENT;case Ye.NOT_FOUND:return D.NOT_FOUND;case Ye.ALREADY_EXISTS:return D.ALREADY_EXISTS;case Ye.PERMISSION_DENIED:return D.PERMISSION_DENIED;case Ye.FAILED_PRECONDITION:return D.FAILED_PRECONDITION;case Ye.ABORTED:return D.ABORTED;case Ye.OUT_OF_RANGE:return D.OUT_OF_RANGE;case Ye.UNIMPLEMENTED:return D.UNIMPLEMENTED;case Ye.DATA_LOSS:return D.DATA_LOSS;default:return $()}}(me=Ye||(Ye={}))[me.OK=0]="OK",me[me.CANCELLED=1]="CANCELLED",me[me.UNKNOWN=2]="UNKNOWN",me[me.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",me[me.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",me[me.NOT_FOUND=5]="NOT_FOUND",me[me.ALREADY_EXISTS=6]="ALREADY_EXISTS",me[me.PERMISSION_DENIED=7]="PERMISSION_DENIED",me[me.UNAUTHENTICATED=16]="UNAUTHENTICATED",me[me.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",me[me.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",me[me.ABORTED=10]="ABORTED",me[me.OUT_OF_RANGE=11]="OUT_OF_RANGE",me[me.UNIMPLEMENTED=12]="UNIMPLEMENTED",me[me.INTERNAL=13]="INTERNAL",me[me.UNAVAILABLE=14]="UNAVAILABLE",me[me.DATA_LOSS=15]="DATA_LOSS";function dh(){return new TextEncoder}const sg=new hn([4294967295,4294967295],0);function fh(r){const e=dh().encode(r),t=new Ks;return t.update(e),new Uint8Array(t.digest())}function mh(r){const e=new DataView(r.buffer),t=e.getUint32(0,!0),n=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new hn([t,n],0),new hn([i,s],0)]}class du{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Zi(`Invalid padding: ${t}`);if(n<0)throw new Zi(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Zi(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Zi(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=hn.fromNumber(this.Ie)}Ee(e,t,n){let i=e.add(t.multiply(hn.fromNumber(n)));return 1===i.compare(sg)&&(i=new hn([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=fh(e),[n,i]=mh(t);for(let s=0;s<this.hashCount;s++){const a=this.Ee(n,i,s);if(!this.de(a))return!1}return!0}static create(e,t,n){const i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),a=new du(s,i,t);return n.forEach(u=>a.insert(u)),a}insert(e){if(0===this.Ie)return;const t=fh(e),[n,i]=mh(t);for(let s=0;s<this.hashCount;s++){const a=this.Ee(n,i,s);this.Ae(a)}}Ae(e){const t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Zi extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class es{constructor(e,t,n,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const i=new Map;return i.set(e,ts.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new es(j.min(),i,new Te(re),Dt(),ae())}}class ts{constructor(e,t,n,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new ts(n,t,ae(),ae(),ae())}}class ko{constructor(e,t,n,i){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=i}}class gh{constructor(e,t){this.targetId=e,this.me=t}}class ph{constructor(e,t,n=Oe.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=i}}class _h{constructor(){this.fe=0,this.ge=Th(),this.pe=Oe.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=ae(),t=ae(),n=ae();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:n=n.add(i);break;default:$()}}),new ts(this.pe,this.ye,e,t,n)}Ce(){this.we=!1,this.ge=Th()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,X(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class og{constructor(e){this.Le=e,this.Be=new Map,this.ke=Dt(),this.qe=yh(),this.Qe=new Te(re)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:$()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((n,i)=>{this.ze(i)&&t(i)})}He(e){const t=e.targetId,n=e.me.count,i=this.Je(t);if(i){const s=i.target;if(xt(s))if(0===n){const a=new K(s.path);this.Ue(t,a,Ce.newNoDocument(a,j.min()))}else X(1===n);else{const a=this.Ye(t);if(a!==n){const u=this.Ze(e),l=u?this.Xe(u,e,a):1;0!==l&&(this.je(t),this.Qe=this.Qe.insert(t,2===l?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:i=0},hashCount:s=0}=t;let a,u;try{a=Ft(n).toUint8Array()}catch(l){if(l instanceof po)return ft("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{u=new du(a,i,s)}catch(l){return ft(l instanceof Zi?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return 0===u.Ie?null:u}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let i=0;return n.forEach(s=>{const a=this.Le.tt(),u=`projects/${a.projectId}/databases/${a.database}/documents/${s.path.canonicalString()}`;e.mightContain(u)||(this.Ue(t,s,null),i++)}),i}rt(e){const t=new Map;this.Be.forEach((s,a)=>{const u=this.Je(a);if(u){if(s.current&&xt(u.target)){const l=new K(u.target.path);null!==this.ke.get(l)||this.it(a,l)||this.Ue(a,l,Ce.newNoDocument(l,e))}s.be&&(t.set(a,s.ve()),s.Ce())}});let n=ae();this.qe.forEach((s,a)=>{let u=!0;a.forEachWhile(l=>{const d=this.Je(l);return!d||"TargetPurposeLimboResolution"===d.purpose||(u=!1,!1)}),u&&(n=n.add(s))}),this.ke.forEach((s,a)=>a.setReadTime(e));const i=new es(e,t,this.Qe,this.ke,n);return this.ke=Dt(),this.qe=yh(),this.Qe=new Te(re),i}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new _h,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new Ie(re),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||M("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new _h),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function yh(){return new Te(K.comparator)}function Th(){return new Te(K.comparator)}const ag={asc:"ASCENDING",desc:"DESCENDING"},ug={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},lg={and:"AND",or:"OR"};class cg{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function fu(r,e){return r.useProto3Json||Xt(e)?e:{value:e}}function ri(r,e){return r.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Ih(r,e){return r.useProto3Json?e.toBase64():e.toUint8Array()}function hg(r,e){return ri(r,e.toTimestamp())}function He(r){return X(!!r),j.fromTimestamp(function(t){const n=zt(t);return new Ve(n.seconds,n.nanos)}(r))}function mu(r,e){return gu(r,e).canonicalString()}function gu(r,e){const t=(i=r,new le(["projects",i.projectId,"databases",i.database])).child("documents");var i;return void 0===e?t:t.child(e)}function Eh(r){const e=le.fromString(r);return X(Dh(e)),e}function ns(r,e){return mu(r.databaseId,e.path)}function an(r,e){const t=Eh(e);if(t.get(1)!==r.databaseId.projectId)throw new L(D.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+r.databaseId.projectId);if(t.get(3)!==r.databaseId.database)throw new L(D.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+r.databaseId.database);return new K(wh(t))}function vh(r,e){return mu(r.databaseId,e)}function Ah(r){const e=Eh(r);return 4===e.length?le.emptyPath():wh(e)}function pu(r){return new le(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function wh(r){return X(r.length>4&&"documents"===r.get(4)),r.popFirst(5)}function Rh(r,e,t){return{name:ns(r,e),fields:t.value.mapValue.fields}}function Ph(r,e,t){const n=an(r,e.name),i=He(e.updateTime),s=e.createTime?He(e.createTime):j.min(),a=new nt({mapValue:{fields:e.fields}}),u=Ce.newFoundDocument(n,i,s,a);return t&&u.setHasCommittedMutations(),t?u.setHasCommittedMutations():u}function rs(r,e){let t;if(e instanceof ti)t={update:Rh(r,e.key,e.value)};else if(e instanceof ni)t={delete:ns(r,e.key)};else if(e instanceof An)t={update:Rh(r,e.key,e.data),updateMask:Tg(e.fieldMask)};else{if(!(e instanceof uu))return $();t={verify:ns(r,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(n=>function(s,a){const u=a.transform;if(u instanceof Zr)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(u instanceof Er)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:u.elements}};if(u instanceof vr)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:u.elements}};if(u instanceof ei)return{fieldPath:a.field.canonicalString(),increment:u.Pe};throw $()}(0,n))),e.precondition.isNone||(t.currentDocument=void 0!==(s=e.precondition).updateTime?{updateTime:hg(r,s.updateTime)}:void 0!==s.exists?{exists:s.exists}:$()),t;var s}function _u(r,e){const t=e.currentDocument?void 0!==(s=e.currentDocument).updateTime?Be.updateTime(He(s.updateTime)):void 0!==s.exists?Be.exists(s.exists):Be.none():Be.none(),n=e.updateTransforms?e.updateTransforms.map(i=>function(a,u){let l=null;"setToServerValue"in u?(X("REQUEST_TIME"===u.setToServerValue),l=new Zr):"appendMissingElements"in u?l=new Er(u.appendMissingElements.values||[]):"removeAllFromArray"in u?l=new vr(u.removeAllFromArray.values||[]):"increment"in u?l=new ei(a,u.increment):$();const d=Pe.fromServerFormat(u.fieldPath);return new Ji(d,l)}(r,i)):[];var s;if(e.update){const i=an(r,e.update.name),s=new nt({mapValue:{fields:e.update.fields}});if(e.updateMask){const a=new ut((e.updateMask.fieldPaths||[]).map(g=>Pe.fromServerFormat(g)));return new An(i,s,a,t,n)}return new ti(i,s,t,n)}if(e.delete){const i=an(r,e.delete);return new ni(i,t)}if(e.verify){const i=an(r,e.verify);return new uu(i,t)}return $()}function Sh(r,e){return{documents:[vh(r,e.path)]}}function Oo(r,e){const t={structuredQuery:{}},n=e.path;let i;null!==e.collectionGroup?(i=n,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=n.popLast(),t.structuredQuery.from=[{collectionId:n.lastSegment()}]),t.parent=vh(r,i);const s=function(d){if(0!==d.length)return Ch(ye.create(d,"and"))}(e.filters);s&&(t.structuredQuery.where=s);const a=function(d){if(0!==d.length)return d.map(g=>{return{field:Qn((E=g).field),direction:pg(E.dir)};var E})}(e.orderBy);a&&(t.structuredQuery.orderBy=a);const u=fu(r,e.limit);return null!==u&&(t.structuredQuery.limit=u),e.startAt&&(t.structuredQuery.startAt={before:(d=e.startAt).inclusive,values:d.position}),e.endAt&&(t.structuredQuery.endAt=function(d){return{before:!d.inclusive,values:d.position}}(e.endAt)),{_t:t,parent:i};var d}function Vh(r){let e=Ah(r.parent);const t=r.structuredQuery,n=t.from?t.from.length:0;let i=null;if(n>0){X(1===n);const g=t.from[0];g.allDescendants?i=g.collectionId:e=e.child(g.collectionId)}let s=[];t.where&&(s=function(y){const E=xh(y);return E instanceof ye&&bo(E)?E.getFilters():[E]}(t.where));let a=[];t.orderBy&&(a=t.orderBy.map(E=>{return new yr(ii((F=E).field),function(U){switch(U){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(F.direction));var F}));let u=null;t.limit&&(u=function(y){let E;return E="object"==typeof y?y.value:y,Xt(E)?null:E}(t.limit));let l=null;var y;t.startAt&&(l=new rn((y=t.startAt).values||[],!!y.before));let d=null;return t.endAt&&(d=function(y){return new rn(y.values||[],!y.before)}(t.endAt)),En(e,i,a,s,u,"F",l,d)}function xh(r){return void 0!==r.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const n=ii(t.unaryFilter.field);return he.create(n,"==",{doubleValue:NaN});case"IS_NULL":const i=ii(t.unaryFilter.field);return he.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=ii(t.unaryFilter.field);return he.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const a=ii(t.unaryFilter.field);return he.create(a,"!=",{nullValue:"NULL_VALUE"});default:return $()}}(r):void 0!==r.fieldFilter?he.create(ii((t=r).fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return $()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==r.compositeFilter?function(t){return ye.create(t.compositeFilter.filters.map(n=>xh(n)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return $()}}(t.compositeFilter.op))}(r):$();var t}function pg(r){return ag[r]}function _g(r){return ug[r]}function yg(r){return lg[r]}function Qn(r){return{fieldPath:r.canonicalString()}}function ii(r){return Pe.fromServerFormat(r.fieldPath)}function Ch(r){return r instanceof he?function(t){if("=="===t.op){if(Eo(t.value))return{unaryFilter:{field:Qn(t.field),op:"IS_NAN"}};if(Io(t.value))return{unaryFilter:{field:Qn(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Eo(t.value))return{unaryFilter:{field:Qn(t.field),op:"IS_NOT_NAN"}};if(Io(t.value))return{unaryFilter:{field:Qn(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Qn(t.field),op:_g(t.op),value:t.value}}}(r):r instanceof ye?function(t){const n=t.getFilters().map(i=>Ch(i));return 1===n.length?n[0]:{compositeFilter:{op:yg(t.op),filters:n}}}(r):$()}function Tg(r){const e=[];return r.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function Dh(r){return r.length>=4&&"projects"===r.get(0)&&"databases"===r.get(2)}class wn{constructor(e,t,n,i,s=j.min(),a=j.min(),u=Oe.EMPTY_BYTE_STRING,l=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=u,this.expectedCount=l}withSequenceNumber(e){return new wn(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new wn(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new wn(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new wn(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Nh{constructor(e){this.ct=e}}function kh(r,e){const t=e.key,n={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:Mo(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())n.document={name:ns(s=r.ct,(a=e).key),fields:a.data.value.mapValue.fields,updateTime:ri(s,a.version.toTimestamp()),createTime:ri(s,a.createTime.toTimestamp())};else if(e.isNoDocument())n.noDocument={path:t.path.toArray(),readTime:Ar(e.version)};else{if(!e.isUnknownDocument())return $();n.unknownDocument={path:t.path.toArray(),version:Ar(e.version)}}var s,a;return n}function Mo(r){const e=r.toTimestamp();return[e.seconds,e.nanoseconds]}function Ar(r){const e=r.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function wr(r){const e=new Ve(r.seconds,r.nanoseconds);return j.fromTimestamp(e)}function Rr(r,e){const t=(e.baseMutations||[]).map(s=>_u(r.ct,s));for(let s=0;s<e.mutations.length-1;++s)s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform&&(e.mutations[s].updateTransforms=e.mutations[s+1].transform.fieldTransforms,e.mutations.splice(s+1,1),++s);const n=e.mutations.map(s=>_u(r.ct,s)),i=Ve.fromMillis(e.localWriteTimeMs);return new lu(e.batchId,i,t,n)}function is(r){const e=wr(r.readTime),t=void 0!==r.lastLimboFreeSnapshotVersion?wr(r.lastLimboFreeSnapshotVersion):j.min();let n;return n=void 0!==r.query.documents?(X(1===(s=r.query).documents.length),gt(sn(Ah(s.documents[0])))):function(s){return gt(Vh(s))}(r.query),new wn(n,r.targetId,"TargetPurposeListen",r.lastListenSequenceNumber,e,t,Oe.fromBase64String(r.resumeToken));var s}function Oh(r,e){const t=Ar(e.snapshotVersion),n=Ar(e.lastLimboFreeSnapshotVersion);let i;i=xt(e.target)?Sh(r.ct,e.target):Oo(r.ct,e.target)._t;const s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:ze(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:n,query:i}}function yu(r){const e=Vh({parent:r.parent,structuredQuery:r.structuredQuery});return"LAST"===r.limitType?Vo(e,e.limit,"L"):e}function Tu(r,e){return new hu(e.largestBatchId,_u(r.ct,e.overlayMutation))}function Mh(r,e){const t=e.path.lastSegment();return[r,et(e.path.popLast()),t]}function Fh(r,e,t,n){return{indexId:r,uid:e,sequenceNumber:t,readTime:Ar(n.readTime),documentKey:et(n.documentKey.path),largestBatchId:n.largestBatchId}}class Eg{getBundleMetadata(e,t){return Lh(e).get(t).next(n=>{if(n)return{id:(s=n).bundleId,createTime:wr(s.createTime),version:s.version};var s})}saveBundleMetadata(e,t){return Lh(e).put({bundleId:(i=t).id,createTime:Ar(He(i.createTime)),version:i.version});var i}getNamedQuery(e,t){return Uh(e).get(t).next(n=>{if(n)return{name:(s=n).name,query:yu(s.bundledQuery),readTime:wr(s.readTime)};var s})}saveNamedQuery(e,t){return Uh(e).put({name:(i=t).name,readTime:Ar(He(i.readTime)),bundledQuery:i.bundledQuery});var i}}function Lh(r){return je(r,"bundles")}function Uh(r){return je(r,"namedQueries")}class Fo{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){return new Fo(e,t.uid||"")}getOverlay(e,t){return ss(e).get(Mh(this.userId,t)).next(n=>n?Tu(this.serializer,n):null)}getOverlays(e,t){const n=on();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{null!==s&&n.set(i,s)})).next(()=>n)}saveOverlays(e,t,n){const i=[];return n.forEach((s,a)=>{const u=new hu(t,a);i.push(this.ht(e,u))}),b.waitFor(i)}removeOverlaysForBatchId(e,t,n){const i=new Set;t.forEach(a=>i.add(et(a.getCollectionPath())));const s=[];return i.forEach(a=>{const u=IDBKeyRange.bound([this.userId,a,n],[this.userId,a,n+1],!1,!0);s.push(ss(e).j("collectionPathOverlayIndex",u))}),b.waitFor(s)}getOverlaysForCollection(e,t,n){const i=on(),s=et(t),a=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return ss(e).U("collectionPathOverlayIndex",a).next(u=>{for(const l of u){const d=Tu(this.serializer,l);i.set(d.getKey(),d)}return i})}getOverlaysForCollectionGroup(e,t,n,i){const s=on();let a;const u=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return ss(e).J({index:"collectionGroupOverlayIndex",range:u},(l,d,g)=>{const y=Tu(this.serializer,d);s.size()<i||y.largestBatchId===a?(s.set(y.getKey(),y),a=y.largestBatchId):g.done()}).next(()=>s)}ht(e,t){return ss(e).put(function(i,s,a){const[u,l,d]=Mh(s,a.mutation.key);return{userId:s,collectionPath:l,documentId:d,collectionGroup:a.mutation.key.getCollectionGroup(),largestBatchId:a.largestBatchId,overlayMutation:rs(i.ct,a.mutation)}}(this.serializer,this.userId,t))}}function ss(r){return je(r,"documentOverlays")}class vg{Pt(e){return je(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(t=>{const n=null==t?void 0:t.value;return n?Oe.fromUint8Array(n):Oe.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class Pr{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(xe(e.integerValue));else if("doubleValue"in e){const n=xe(e.doubleValue);isNaN(n)?this.dt(t,13):(this.dt(t,15),qn(n)?t.At(0):t.At(n))}else if("timestampValue"in e){let n=e.timestampValue;this.dt(t,20),"string"==typeof n&&(n=zt(n)),t.Rt(`${n.seconds||""}`),t.At(n.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(Ft(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.dt(t,45),t.At(n.latitude||0),t.At(n.longitude||0)}else"mapValue"in e?$t(e)?this.dt(t,Number.MAX_SAFE_INTEGER):pr(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):$()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){const n=e.fields||{};this.dt(t,55);for(const i of Object.keys(n))this.Vt(i,t),this.Tt(n[i],t)}wt(e,t){var n,i;const s=e.fields||{};this.dt(t,53);const a="value",u=(null===(i=null===(n=s[a].arrayValue)||void 0===n?void 0:n.values)||void 0===i?void 0:i.length)||0;this.dt(t,15),t.At(xe(u)),this.Vt(a,t),this.Tt(s[a],t)}bt(e,t){const n=e.values||[];this.dt(t,50);for(const i of n)this.Tt(i,t)}yt(e,t){this.dt(t,37),K.fromName(e).path.forEach(n=>{this.dt(t,60),this.Dt(n,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}}function Ag(r){if(0===r)return 8;let e=0;return!(r>>4)&&(e+=4,r<<=4),!(r>>6)&&(e+=2,r<<=2),!(r>>7)&&(e+=1),e}function Bh(r){const e=64-function(n){let i=0;for(let s=0;s<8;++s){const a=Ag(255&n[s]);if(i+=a,8!==a)break}return i}(r);return Math.ceil(e/8)}Pr.vt=new Pr;class wg{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Lt(e){for(const t of e){const n=t.charCodeAt(0);if(n<128)this.Ft(n);else if(n<2048)this.Ft(960|n>>>6),this.Ft(128|63&n);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|n>>>12),this.Ft(128|63&n>>>6),this.Ft(128|63&n);else{const i=t.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(e){for(const t of e){const n=t.charCodeAt(0);if(n<128)this.Ot(n);else if(n<2048)this.Ot(960|n>>>6),this.Ot(128|63&n);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|n>>>12),this.Ot(128|63&n>>>6),this.Ot(128|63&n);else{const i=t.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(e){const t=this.qt(e),n=Bh(t);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let i=t.length-n;i<t.length;++i)this.buffer[this.position++]=255&t[i]}Kt(e){const t=this.qt(e),n=Bh(t);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let i=t.length-n;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){const t=function(s){const a=new DataView(new ArrayBuffer(8));return a.setFloat64(0,s,!1),new Uint8Array(a.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let i=1;i<t.length;++i)t[i]^=n?255:0;return t}Ft(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){const t=255&e;0===t?(this.Gt(0),this.Gt(255)):255===t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const i=new Uint8Array(n);i.set(this.buffer),this.buffer=i}}class Rg{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}}class Pg{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class os{constructor(){this.jt=new wg,this.Ht=new Rg(this.jt),this.Jt=new Pg(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class Sr{constructor(e,t,n,i){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=i}Zt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Sr(this.indexId,this.documentKey,this.arrayValue,n)}}function Wn(r,e){let t=r.indexId-e.indexId;return 0!==t?t:(t=qh(r.arrayValue,e.arrayValue),0!==t?t:(t=qh(r.directionalValue,e.directionalValue),0!==t?t:K.comparator(r.documentKey,e.documentKey)))}function qh(r,e){for(let t=0;t<r.length&&t<e.length;++t){const n=r[t]-e[t];if(0!==n)return n}return r.length-e.length}class Gh{constructor(e){this.Xt=new Ie((t,n)=>Pe.comparator(t.field,n.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(const t of e.filters){const n=t;n.isInequality()?this.Xt=this.Xt.add(n):this.tn.push(n)}}get nn(){return this.Xt.size>1}rn(e){if(X(e.collectionGroup===this.collectionId),this.nn)return!1;const t=ki(e);if(void 0!==t&&!this.sn(t))return!1;const n=gn(e);let i=new Set,s=0,a=0;for(;s<n.length&&this.sn(n[s]);++s)i=i.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Xt.size>0){const u=this.Xt.getIterator().getNext();if(!i.has(u.field.canonicalString())){const l=n[s];if(!this.on(u,l)||!this._n(this.en[a++],l))return!1}++s}for(;s<n.length;++s)if(a>=this.en.length||!this._n(this.en[a++],n[s]))return!1;return!0}an(){if(this.nn)return null;let e=new Ie(Pe.comparator);const t=[];for(const n of this.tn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new it(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new it(n.field,0))}for(const n of this.en)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new it(n.field,"asc"===n.dir?0:1)));return new mn(mn.UNKNOWN_ID,this.collectionId,t,Ln.empty())}sn(e){for(const t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){return!(void 0===e||!e.field.isEqual(t.fieldPath))&&2===t.kind==("array-contains"===e.op||"array-contains-any"===e.op)}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Kh(r){var e,t;if(X(r instanceof he||r instanceof ye),r instanceof he){if(r instanceof oe){const i=(null===(t=null===(e=r.value.arrayValue)||void 0===e?void 0:e.values)||void 0===t?void 0:t.map(s=>he.create(r.field,"==",s)))||[];return ye.create(i,"or")}return r}const n=r.filters.map(i=>Kh(i));return ye.create(n,r.op)}function Sg(r){if(0===r.getFilters().length)return[];const e=vu(Kh(r));return X(zh(e)),Iu(e)||Eu(e)?[e]:e.getFilters()}function Iu(r){return r instanceof he}function Eu(r){return r instanceof ye&&bo(r)}function zh(r){return Iu(r)||Eu(r)||function(t){if(t instanceof ye&&So(t)){for(const n of t.getFilters())if(!Iu(n)&&!Eu(n))return!1;return!0}return!1}(r)}function vu(r){if(X(r instanceof he||r instanceof ye),r instanceof he)return r;if(1===r.filters.length)return vu(r.filters[0]);const e=r.filters.map(n=>vu(n));let t=ye.create(e,r.op);return t=Lo(t),zh(t)?t:(X(t instanceof ye),X(Tr(t)),X(t.filters.length>1),t.filters.reduce((n,i)=>Au(n,i)))}function Au(r,e){let t;return X(r instanceof he||r instanceof ye),X(e instanceof he||e instanceof ye),t=r instanceof he?e instanceof he?ye.create([r,e],"and"):jh(r,e):e instanceof he?jh(e,r):function(i,s){if(X(i.filters.length>0&&s.filters.length>0),Tr(i)&&Tr(s))return T(i,s.getFilters());const a=So(i)?i:s,u=So(i)?s:i,l=a.filters.map(d=>Au(d,u));return ye.create(l,"or")}(r,e),Lo(t)}function jh(r,e){if(Tr(e))return T(e,r.getFilters());{const t=e.filters.map(n=>Au(r,n));return ye.create(t,"or")}}function Lo(r){if(X(r instanceof he||r instanceof ye),r instanceof he)return r;const e=r.getFilters();if(1===e.length)return Lo(e[0]);if(f(r))return r;const t=e.map(i=>Lo(i)),n=[];return t.forEach(i=>{i instanceof he?n.push(i):i instanceof ye&&(i.op===r.op?n.push(...i.filters):n.push(i))}),1===n.length?n[0]:ye.create(n,r.op)}class bg{constructor(){this.un=new wu}addToCollectionParentIndex(e,t){return this.un.add(t),b.resolve()}getCollectionParents(e,t){return b.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return b.resolve()}deleteFieldIndex(e,t){return b.resolve()}deleteAllFieldIndexes(e){return b.resolve()}createTargetIndexes(e,t){return b.resolve()}getDocumentsMatchingTarget(e,t){return b.resolve(null)}getIndexType(e,t){return b.resolve(0)}getFieldIndexes(e,t){return b.resolve([])}getNextCollectionGroupToUpdate(e){return b.resolve(null)}getMinOffset(e,t){return b.resolve(wt.min())}getMinOffsetFromCollectionGroup(e,t){return b.resolve(wt.min())}updateCollectionGroup(e,t,n){return b.resolve()}updateIndexEntries(e,t){return b.resolve()}}class wu{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),i=this.index[t]||new Ie(le.comparator),s=!i.has(n);return this.index[t]=i.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),i=this.index[t];return i&&i.has(n)}getEntries(e){return(this.index[e]||new Ie(le.comparator)).toArray()}}const Uo=new Uint8Array(0);class Vg{constructor(e,t){this.databaseId=t,this.cn=new wu,this.ln=new vn(n=>ze(n),(n,i)=>De(n,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){const n=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});const s={collectionId:n,parent:et(i)};return $h(e).put(s)}return b.resolve()}getCollectionParents(e,t){const n=[],i=IDBKeyRange.bound([t,""],[Zs(t),""],!1,!0);return $h(e).U(i).next(s=>{for(const a of s){if(a.collectionId!==t)break;n.push(Kt(a.parent))}return n})}addFieldIndex(e,t){const n=as(e),i={indexId:(u=t).indexId,collectionGroup:u.collectionGroup,fields:u.fields.map(l=>[l.fieldPath.canonicalString(),l.kind])};var u;delete i.indexId;const s=n.add(i);if(t.indexState){const a=oi(e);return s.next(u=>{a.put(Fh(u,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=as(e),i=oi(e),s=si(e);return n.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=as(e),n=si(e),i=oi(e);return t.j().next(()=>n.j()).next(()=>i.j())}createTargetIndexes(e,t){return b.forEach(this.hn(t),n=>this.getIndexType(e,n).next(i=>{if(0===i||1===i){const s=new Gh(n).an();if(null!=s)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){const n=si(e);let i=!0;const s=new Map;return b.forEach(this.hn(t),a=>this.Pn(e,a).next(u=>{i&&(i=!!u),s.set(a,u)})).next(()=>{if(i){let a=ae();const u=[];return b.forEach(s,(l,d)=>{var J;M("IndexedDbIndexManager",`Using index ${J=l,`id=${J.indexId}|cg=${J.collectionGroup}|f=${J.fields.map(ne=>`${ne.fieldPath}:${ne.kind}`).join(",")}`} to execute ${ze(t)}`);const g=function(J,ne){const de=ki(ne);if(void 0===de)return null;for(const se of Ct(J,de.fieldPath))switch(se.op){case"array-contains-any":return se.value.arrayValue.values||[];case"array-contains":return[se.value]}return null}(d,l),y=function(J,ne){const de=new Map;for(const se of gn(ne))for(const R of Ct(J,se.fieldPath))switch(R.op){case"==":case"in":de.set(se.fieldPath.canonicalString(),R.value);break;case"not-in":case"!=":return de.set(se.fieldPath.canonicalString(),R.value),Array.from(de.values())}return null}(d,l),E=function(J,ne){const de=[];let se=!0;for(const R of gn(ne)){const I=0===R.kind?rt(J,R.fieldPath,J.startAt):Je(J,R.fieldPath,J.startAt);de.push(I.value),se&&(se=I.inclusive)}return new rn(de,se)}(d,l),V=function(J,ne){const de=[];let se=!0;for(const R of gn(ne)){const I=0===R.kind?Je(J,R.fieldPath,J.endAt):rt(J,R.fieldPath,J.endAt);de.push(I.value),se&&(se=I.inclusive)}return new rn(de,se)}(d,l),F=this.In(l,d,E),q=this.In(l,d,V),U=this.Tn(l,d,y),H=this.En(l.indexId,g,F,E.inclusive,q,V.inclusive,U);return b.forEach(H,Z=>n.G(Z,t.limit).next(J=>{J.forEach(ne=>{const de=K.fromSegments(ne.documentKey);a.has(de)||(a=a.add(de),u.push(de))})}))}).next(()=>u)}return b.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(t=0===e.filters.length?[e]:Sg(ye.create(e.filters,"and")).map(n=>Se(e.path,e.collectionGroup,e.orderBy,n.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t),t)}En(e,t,n,i,s,a,u){const l=(null!=t?t.length:1)*Math.max(n.length,s.length),d=l/(null!=t?t.length:1),g=[];for(let y=0;y<l;++y){const E=t?this.dn(t[y/d]):Uo,V=this.An(e,E,n[y%d],i),F=this.Rn(e,E,s[y%d],a),q=u.map(U=>this.An(e,E,U,!0));g.push(...this.createRange(V,F,q))}return g}An(e,t,n,i){const s=new Sr(e,K.empty(),t,n);return i?s:s.Zt()}Rn(e,t,n,i){const s=new Sr(e,K.empty(),t,n);return i?s.Zt():s}Pn(e,t){const n=new Gh(t),i=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let a=null;for(const u of s)n.rn(u)&&(!a||u.fields.length>a.fields.length)&&(a=u);return a})}getIndexType(e,t){let n=2;const i=this.hn(t);return b.forEach(i,s=>this.Pn(e,s).next(a=>{a?0!==n&&a.fields.length<function(l){let d=new Ie(Pe.comparator),g=!1;for(const y of l.filters)for(const E of y.getFlattenedFilters())E.field.isKeyField()||("array-contains"===E.op||"array-contains-any"===E.op?g=!0:d=d.add(E.field));for(const y of l.orderBy)y.field.isKeyField()||(d=d.add(y.field));return d.size+(g?1:0)}(s)&&(n=1):n=0})).next(()=>null!==t.limit&&i.length>1&&2===n?1:n)}Vn(e,t){const n=new os;for(const i of gn(e)){const s=t.data.field(i.fieldPath);if(null==s)return null;const a=n.Yt(i.kind);Pr.vt.It(s,a)}return n.zt()}dn(e){const t=new os;return Pr.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){const n=new os;return Pr.vt.It(nn(this.databaseId,t),n.Yt(function(s){const a=gn(s);return 0===a.length?0:a[a.length-1].kind}(e))),n.zt()}Tn(e,t,n){if(null===n)return[];let i=[];i.push(new os);let s=0;for(const a of gn(e)){const u=n[s++];for(const l of i)if(this.fn(t,a.fieldPath)&&Xr(u))i=this.gn(i,a,u);else{const d=l.Yt(a.kind);Pr.vt.It(u,d)}}return this.pn(i)}In(e,t,n){return this.Tn(e,t,n.position)}pn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].zt();return t}gn(e,t,n){const i=[...e],s=[];for(const a of n.arrayValue.values||[])for(const u of i){const l=new os;l.seed(u.zt()),Pr.vt.It(a,l.Yt(t.kind)),s.push(l)}return s}fn(e,t){return!!e.filters.find(n=>n instanceof he&&n.field.isEqual(t)&&("in"===n.op||"not-in"===n.op))}getFieldIndexes(e,t){const n=as(e),i=oi(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next(s=>{const a=[];return b.forEach(s,u=>i.get([u.indexId,this.uid]).next(l=>{a.push(function(g,y){const E=y?new Ln(y.sequenceNumber,new wt(wr(y.readTime),new K(Kt(y.documentKey)),y.largestBatchId)):Ln.empty(),V=g.fields.map(([F,q])=>new it(Pe.fromServerFormat(F),q));return new mn(g.indexId,g.collectionGroup,V,E)}(u,l))})).next(()=>a)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>0===t.length?null:(t.sort((n,i)=>{const s=n.indexState.sequenceNumber-i.indexState.sequenceNumber;return 0!==s?s:re(n.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,n){const i=as(e),s=oi(e);return this.yn(e).next(a=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(u=>b.forEach(u,l=>s.put(Fh(l.indexId,this.uid,a,n)))))}updateIndexEntries(e,t){const n=new Map;return b.forEach(t,(i,s)=>{const a=n.get(i.collectionGroup);return(a?b.resolve(a):this.getFieldIndexes(e,i.collectionGroup)).next(u=>(n.set(i.collectionGroup,u),b.forEach(u,l=>this.wn(e,i,l).next(d=>{const g=this.Sn(s,l);return d.isEqual(g)?b.resolve():this.bn(e,s,l,d,g)}))))})}Dn(e,t,n,i){return si(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}vn(e,t,n,i){return si(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}wn(e,t,n){const i=si(e);let s=new Ie(Wn);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},(a,u)=>{s=s.add(new Sr(n.indexId,t,u.arrayValue,u.directionalValue))}).next(()=>s)}Sn(e,t){let n=new Ie(Wn);const i=this.Vn(t,e);if(null==i)return n;const s=ki(t);if(null!=s){const a=e.data.field(s.fieldPath);if(Xr(a))for(const u of a.arrayValue.values||[])n=n.add(new Sr(t.indexId,e.key,this.dn(u),i))}else n=n.add(new Sr(t.indexId,e.key,Uo,i));return n}bn(e,t,n,i,s){M("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const a=[];return function(l,d,g,y,E){const V=l.getIterator(),F=d.getIterator();let q=Kn(V),U=Kn(F);for(;q||U;){let H=!1,Z=!1;if(q&&U){const J=g(q,U);J<0?Z=!0:J>0&&(H=!0)}else null!=q?Z=!0:H=!0;H?(y(U),U=Kn(F)):Z?(E(q),q=Kn(V)):(q=Kn(V),U=Kn(F))}}(i,s,Wn,u=>{a.push(this.Dn(e,t,n,u))},u=>{a.push(this.vn(e,t,n,u))}),b.waitFor(a)}yn(e){let t=1;return oi(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(n,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((a,u)=>Wn(a,u)).filter((a,u,l)=>!u||0!==Wn(a,l[u-1]));const i=[];i.push(e);for(const a of n){const u=Wn(a,e),l=Wn(a,t);if(0===u)i[0]=e.Zt();else if(u>0&&l<0)i.push(a),i.push(a.Zt());else if(l>0)break}i.push(t);const s=[];for(let a=0;a<i.length;a+=2){if(this.Cn(i[a],i[a+1]))return[];s.push(IDBKeyRange.bound([i[a].indexId,this.uid,i[a].arrayValue,i[a].directionalValue,Uo,[]],[i[a+1].indexId,this.uid,i[a+1].arrayValue,i[a+1].directionalValue,Uo,[]]))}return s}Cn(e,t){return Wn(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Qh)}getMinOffset(e,t){return b.mapArray(this.hn(t),n=>this.Pn(e,n).next(i=>i||$())).next(Qh)}}function $h(r){return je(r,"collectionParents")}function si(r){return je(r,"indexEntries")}function as(r){return je(r,"indexConfiguration")}function oi(r){return je(r,"indexState")}function Qh(r){X(0!==r.length);let e=r[0].indexState.offset,t=e.largestBatchId;for(let n=1;n<r.length;n++){const i=r[n].indexState.offset;Ze(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new wt(e.readTime,e.documentKey,t)}const Wh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class pt{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new pt(e,pt.DEFAULT_COLLECTION_PERCENTILE,pt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Hh(r,e,t){const n=r.store("mutations"),i=r.store("documentMutations"),s=[],a=IDBKeyRange.only(t.batchId);let u=0;const l=n.J({range:a},(g,y,E)=>(u++,E.delete()));s.push(l.next(()=>{X(1===u)}));const d=[];for(const g of t.mutations){const y=Li(e,g.key.path,t.batchId);s.push(i.delete(y)),d.push(g.key)}return b.waitFor(s).next(()=>d)}function Bo(r){if(!r)return 0;let e;if(r.document)e=r.document;else if(r.unknownDocument)e=r.unknownDocument;else{if(!r.noDocument)throw $();e=r.noDocument}return JSON.stringify(e).length}pt.DEFAULT_COLLECTION_PERCENTILE=10,pt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,pt.DEFAULT=new pt(41943040,pt.DEFAULT_COLLECTION_PERCENTILE,pt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),pt.DISABLED=new pt(-1,0,0);class qo{constructor(e,t,n,i){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=i,this.Fn={}}static lt(e,t,n,i){X(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new qo(s,t,n,i)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Hn(e).J({index:"userMutationsIndex",range:n},(i,s,a)=>{t=!1,a.done()}).next(()=>t)}addMutationBatch(e,t,n,i){const s=ai(e),a=Hn(e);return a.add({}).next(u=>{X("number"==typeof u);const l=new lu(u,t,n,i),d=function(V,F,q){const U=q.baseMutations.map(Z=>rs(V.ct,Z)),H=q.mutations.map(Z=>rs(V.ct,Z));return{userId:F,batchId:q.batchId,localWriteTimeMs:q.localWriteTime.toMillis(),baseMutations:U,mutations:H}}(this.serializer,this.userId,l),g=[];let y=new Ie((E,V)=>re(E.canonicalString(),V.canonicalString()));for(const E of i){const V=Li(this.userId,E.key.path,u);y=y.add(E.key.path.popLast()),g.push(a.put(d)),g.push(s.put(V,Qr))}return y.forEach(E=>{g.push(this.indexManager.addToCollectionParentIndex(e,E))}),e.addOnCommittedListener(()=>{this.Fn[u]=l.keys()}),b.waitFor(g).next(()=>l)})}lookupMutationBatch(e,t){return Hn(e).get(t).next(n=>n?(X(n.userId===this.userId),Rr(this.serializer,n)):null)}Mn(e,t){return this.Fn[t]?b.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(n=>{if(n){const i=n.keys();return this.Fn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){const n=t+1,i=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Hn(e).J({index:"userMutationsIndex",range:i},(a,u,l)=>{u.userId===this.userId&&(X(u.batchId>=n),s=Rr(this.serializer,u)),l.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Hn(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,a)=>{n=s.batchId,a.done()}).next(()=>n)}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Hn(e).U("userMutationsIndex",t).next(n=>n.map(i=>Rr(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=hr(this.userId,t.path),i=IDBKeyRange.lowerBound(n),s=[];return ai(e).J({range:i},(a,u,l)=>{const[d,g,y]=a,E=Kt(g);if(d===this.userId&&t.path.isEqual(E))return Hn(e).get(y).next(V=>{if(!V)throw $();X(V.userId===this.userId),s.push(Rr(this.serializer,V))});l.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ie(re);const i=[];return t.forEach(s=>{const a=hr(this.userId,s.path),u=IDBKeyRange.lowerBound(a),l=ai(e).J({range:u},(d,g,y)=>{const[E,V,F]=d,q=Kt(V);E===this.userId&&s.path.isEqual(q)?n=n.add(F):y.done()});i.push(l)}),b.waitFor(i).next(()=>this.xn(e,n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,i=n.length+1,s=hr(this.userId,n),a=IDBKeyRange.lowerBound(s);let u=new Ie(re);return ai(e).J({range:a},(l,d,g)=>{const[y,E,V]=l,F=Kt(E);y===this.userId&&n.isPrefixOf(F)?F.length===i&&(u=u.add(V)):g.done()}).next(()=>this.xn(e,u))}xn(e,t){const n=[],i=[];return t.forEach(s=>{i.push(Hn(e).get(s).next(a=>{if(null===a)throw $();X(a.userId===this.userId),n.push(Rr(this.serializer,a))}))}),b.waitFor(i).next(()=>n)}removeMutationBatch(e,t){return Hh(e._e,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),b.forEach(n,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return b.resolve();const n=IDBKeyRange.lowerBound(function(a){return[a]}(this.userId)),i=[];return ai(e).J({range:n},(s,a,u)=>{if(s[0]===this.userId){const l=Kt(s[1]);i.push(l)}else u.done()}).next(()=>{X(0===i.length)})})}containsKey(e,t){return Xh(e,this.userId,t)}Nn(e){return Jh(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function Xh(r,e,t){const n=hr(e,t.path),i=n[1],s=IDBKeyRange.lowerBound(n);let a=!1;return ai(r).J({range:s,H:!0},(u,l,d)=>{const[g,y,E]=u;g===e&&y===i&&(a=!0),d.done()}).next(()=>a)}function Hn(r){return je(r,"mutations")}function ai(r){return je(r,"documentMutations")}function Jh(r){return je(r,"mutationQueues")}class br{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new br(0)}static kn(){return new br(-1)}}class xg{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{const n=new br(t.highestTargetId);return t.highestTargetId=n.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(t=>j.fromTimestamp(new Ve(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.qn(e).next(i=>(i.highestListenSequenceNumber=t,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.Qn(e,i)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(n=>(n.targetCount+=1,this.$n(t,n),this.Qn(e,n))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>ui(e).delete(t.targetId)).next(()=>this.qn(e)).next(n=>(X(n.targetCount>0),n.targetCount-=1,this.Qn(e,n)))}removeTargets(e,t,n){let i=0;const s=[];return ui(e).J((a,u)=>{const l=is(u);l.sequenceNumber<=t&&null===n.get(l.targetId)&&(i++,s.push(this.removeTargetData(e,l)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(e,t){return ui(e).J((n,i)=>{const s=is(i);t(s)})}qn(e){return Yh(e).get("targetGlobalKey").next(t=>(X(null!==t),t))}Qn(e,t){return Yh(e).put("targetGlobalKey",t)}Kn(e,t){return ui(e).put(Oh(this.serializer,t))}$n(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.qn(e).next(t=>t.targetCount)}getTargetData(e,t){const n=ze(t),i=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return ui(e).J({range:i,index:"queryTargetsIndex"},(a,u,l)=>{const d=is(u);De(t,d.target)&&(s=d,l.done())}).next(()=>s)}addMatchingKeys(e,t,n){const i=[],s=Xn(e);return t.forEach(a=>{const u=et(a.path);i.push(s.put({targetId:n,path:u})),i.push(this.referenceDelegate.addReference(e,n,a))}),b.waitFor(i)}removeMatchingKeys(e,t,n){const i=Xn(e);return b.forEach(t,s=>{const a=et(s.path);return b.waitFor([i.delete([n,a]),this.referenceDelegate.removeReference(e,n,s)])})}removeMatchingKeysForTargetId(e,t){const n=Xn(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(i)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),i=Xn(e);let s=ae();return i.J({range:n,H:!0},(a,u,l)=>{const d=Kt(a[1]),g=new K(d);s=s.add(g)}).next(()=>s)}containsKey(e,t){const n=et(t.path),i=IDBKeyRange.bound([n],[Zs(n)],!1,!0);let s=0;return Xn(e).J({index:"documentTargetsIndex",H:!0,range:i},([a,u],l,d)=>{0!==a&&(s++,d.done())}).next(()=>s>0)}ot(e,t){return ui(e).get(t).next(n=>n?is(n):null)}}function ui(r){return je(r,"targets")}function Yh(r){return je(r,"targetGlobal")}function Xn(r){return je(r,"targetDocuments")}function Zh([r,e],[t,n]){const i=re(r,t);return 0===i?re(e,n):i}class Cg{constructor(e){this.Un=e,this.buffer=new Ie(Zh),this.Wn=0}Gn(){return++this.Wn}zn(e){const t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{const n=this.buffer.last();Zh(t,n)<0&&(this.buffer=this.buffer.delete(n).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ed{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.jn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return null!==this.jn}Hn(e){var t=this;M("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(0,O.A)(function*(){t.jn=null;try{yield t.localStore.collectGarbage(t.garbageCollector)}catch(n){Yt(n)?M("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",n):yield Vt(n)}yield t.Hn(3e5)}))}}class Dg{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(n=>Math.floor(t/100*n))}nthSequenceNumber(e,t){if(0===t)return b.resolve(Xe.oe);const n=new Cg(t);return this.Jn.forEachTarget(e,i=>n.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(e,i=>n.zn(i))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(M("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(Wh)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(M("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Wh):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let n,i,s,a,u,l,d;const g=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(y=>(y>this.params.maximumSequenceNumbersToCollect?(M("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${y}`),i=this.params.maximumSequenceNumbersToCollect):i=y,a=Date.now(),this.nthSequenceNumber(e,i))).next(y=>(n=y,u=Date.now(),this.removeTargets(e,n,t))).next(y=>(s=y,l=Date.now(),this.removeOrphanedDocuments(e,n))).next(y=>(d=Date.now(),Bt()<=fe.$b.DEBUG&&M("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-g}ms\n\tDetermined least recently used ${i} in `+(u-a)+`ms\n\tRemoved ${s} targets in `+(l-u)+`ms\n\tRemoved ${y} documents in `+(d-l)+`ms\nTotal Duration: ${d-g}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:y})))}}class Ng{constructor(e,t){this.db=e,this.garbageCollector=function td(r,e){return new Dg(r,e)}(this,t)}Yn(e){const t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(n=>t.next(i=>n+i))}er(e){let t=0;return this.Zn(e,n=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(n,i)=>t(i))}addReference(e,t,n){return Go(e,n)}removeReference(e,t,n){return Go(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Go(e,t)}nr(e,t){return function(i,s){let a=!1;return Jh(i).Y(u=>Xh(i,u,s).next(l=>(l&&(a=!0),b.resolve(!l)))).next(()=>a)}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let s=0;return this.tr(e,(a,u)=>{if(u<=t){const l=this.nr(e,a).next(d=>{if(!d)return s++,n.getEntry(e,a).next(()=>(n.removeEntry(a,j.min()),Xn(e).delete([0,et(a.path)])))});i.push(l)}}).next(()=>b.waitFor(i)).next(()=>n.apply(e)).next(()=>s)}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Go(e,t)}tr(e,t){const n=Xn(e);let i,s=Xe.oe;return n.J({index:"documentTargetsIndex"},([a,u],{path:l,sequenceNumber:d})=>{0===a?(s!==Xe.oe&&t(new K(Kt(i)),s),s=d,i=l):s=Xe.oe}).next(()=>{s!==Xe.oe&&t(new K(Kt(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Go(r,e){return Xn(r).put((i=r.currentSequenceNumber,{targetId:0,path:et(e.path),sequenceNumber:i}));var i}class nd{constructor(){this.changes=new vn(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ce.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?b.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class kg{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Vr(e).put(n)}removeEntry(e,t,n){return Vr(e).delete(function(s,a){const u=s.path.toArray();return[u.slice(0,u.length-2),u[u.length-2],Mo(a),u[u.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.rr(e,n)))}getEntry(e,t){let n=Ce.newInvalidDocument(t);return Vr(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(us(t))},(i,s)=>{n=this.ir(t,s)}).next(()=>n)}sr(e,t){let n={size:0,document:Ce.newInvalidDocument(t)};return Vr(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(us(t))},(i,s)=>{n={document:this.ir(t,s),size:Bo(s)}}).next(()=>n)}getEntries(e,t){let n=Dt();return this._r(e,t,(i,s)=>{const a=this.ir(i,s);n=n.insert(i,a)}).next(()=>n)}ar(e,t){let n=Dt(),i=new Te(K.comparator);return this._r(e,t,(s,a)=>{const u=this.ir(s,a);n=n.insert(s,u),i=i.insert(s,Bo(a))}).next(()=>({documents:n,ur:i}))}_r(e,t,n){if(t.isEmpty())return b.resolve();let i=new Ie(od);t.forEach(l=>i=i.add(l));const s=IDBKeyRange.bound(us(i.first()),us(i.last())),a=i.getIterator();let u=a.getNext();return Vr(e).J({index:"documentKeyIndex",range:s},(l,d,g)=>{const y=K.fromSegments([...d.prefixPath,d.collectionGroup,d.documentId]);for(;u&&od(u,y)<0;)n(u,null),u=a.getNext();u&&u.isEqual(y)&&(n(u,d),u=a.hasNext()?a.getNext():null),u?g.$(us(u)):g.done()}).next(()=>{for(;u;)n(u,null),u=a.hasNext()?a.getNext():null})}getDocumentsMatchingQuery(e,t,n,i,s){const a=t.path,u=[a.popLast().toArray(),a.lastSegment(),Mo(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],l=[a.popLast().toArray(),a.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Vr(e).U(IDBKeyRange.bound(u,l,!0)).next(d=>{null==s||s.incrementDocumentReadCount(d.length);let g=Dt();for(const y of d){const E=this.ir(K.fromSegments(y.prefixPath.concat(y.collectionGroup,y.documentId)),y);E.isFoundDocument()&&(Wi(t,E)||i.has(E.key))&&(g=g.insert(E.key,E))}return g})}getAllFromCollectionGroup(e,t,n,i){let s=Dt();const a=sd(t,n),u=sd(t,wt.max());return Vr(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(a,u,!0)},(l,d,g)=>{const y=this.ir(K.fromSegments(d.prefixPath.concat(d.collectionGroup,d.documentId)),d);s=s.insert(y.key,y),s.size===i&&g.done()}).next(()=>s)}newChangeBuffer(e){return new Og(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return id(e).get("remoteDocumentGlobalKey").next(t=>(X(!!t),t))}rr(e,t){return id(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){const n=function Ig(r,e){let t;if(e.document)t=Ph(r.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const n=K.fromSegments(e.noDocument.path),i=wr(e.noDocument.readTime);t=Ce.newNoDocument(n,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return $();{const n=K.fromSegments(e.unknownDocument.path),i=wr(e.unknownDocument.version);t=Ce.newUnknownDocument(n,i)}}return e.readTime&&t.setReadTime(function(i){const s=new Ve(i[0],i[1]);return j.fromTimestamp(s)}(e.readTime)),t}(this.serializer,t);if(!n.isNoDocument()||!n.version.isEqual(j.min()))return n}return Ce.newInvalidDocument(e)}}function rd(r){return new kg(r)}class Og extends nd{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new vn(n=>n.toString(),(n,i)=>n.isEqual(i))}applyChanges(e){const t=[];let n=0,i=new Ie((s,a)=>re(s.canonicalString(),a.canonicalString()));return this.changes.forEach((s,a)=>{const u=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,u.readTime)),a.isValidDocument()){const l=kh(this.cr.serializer,a);i=i.add(s.path.popLast());const d=Bo(l);n+=d-u.size,t.push(this.cr.addEntry(e,s,l))}else if(n-=u.size,this.trackRemovals){const l=kh(this.cr.serializer,a.convertToNoDocument(j.min()));t.push(this.cr.addEntry(e,s,l))}}),i.forEach(s=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.cr.updateMetadata(e,n)),b.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(n=>(this.lr.set(t,{size:n.size,readTime:n.document.readTime}),n.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:n,ur:i})=>(i.forEach((s,a)=>{this.lr.set(s,{size:a,readTime:n.get(s).readTime})}),n))}}function id(r){return je(r,"remoteDocumentGlobal")}function Vr(r){return je(r,"remoteDocumentsV14")}function us(r){const e=r.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function sd(r,e){const t=e.documentKey.path.toArray();return[r,Mo(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function od(r,e){const t=r.path.toArray(),n=e.path.toArray();let i=0;for(let s=0;s<t.length-2&&s<n.length-2;++s)if(i=re(t[s],n[s]),i)return i;return i=re(t.length,n.length),i||(i=re(t[t.length-2],n[n.length-2]),i||re(t[t.length-1],n[n.length-1]))}class Mg{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class ad{constructor(e,t,n,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=i}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(n=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(null!==n&&Yi(n.mutation,i,ut.empty(),Ve.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(n=>this.getLocalViewOfDocuments(e,n,ae()).next(()=>n))}getLocalViewOfDocuments(e,t,n=ae()){const i=on();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,n).next(s=>{let a=Hi();return s.forEach((u,l)=>{a=a.insert(u,l.overlayedDocument)}),a}))}getOverlayedDocuments(e,t){const n=on();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,ae()))}populateOverlays(e,t,n){const i=[];return n.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((a,u)=>{t.set(a,u)})})}computeViews(e,t,n,i){let s=Dt();const a=Xi(),u=Xi();return t.forEach((l,d)=>{const g=n.get(d.key);i.has(d.key)&&(void 0===g||g.mutation instanceof An)?s=s.insert(d.key,d):void 0!==g?(a.set(d.key,g.mutation.getFieldMask()),Yi(g.mutation,d,g.mutation.getFieldMask(),Ve.now())):a.set(d.key,ut.empty())}),this.recalculateAndSaveOverlays(e,s).next(l=>(l.forEach((d,g)=>a.set(d,g)),t.forEach((d,g)=>{var y;return u.set(d,new Mg(g,null!==(y=a.get(d))&&void 0!==y?y:null))}),u))}recalculateAndSaveOverlays(e,t){const n=Xi();let i=new Te((a,u)=>a-u),s=ae();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(a=>{for(const u of a)u.keys().forEach(l=>{const d=t.get(l);if(null===d)return;let g=n.get(l)||ut.empty();g=u.applyToLocalView(d,g),n.set(l,g);const y=(i.get(u.batchId)||ae()).add(l);i=i.insert(u.batchId,y)})}).next(()=>{const a=[],u=i.getReverseIterator();for(;u.hasNext();){const l=u.getNext(),d=l.key,g=l.value,y=Xc();g.forEach(E=>{if(!s.has(E)){const V=ih(t.get(E),n.get(E));null!==V&&y.set(E,V),s=s.add(E)}}),a.push(this.documentOverlayCache.saveOverlays(e,d,y))}return b.waitFor(a)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(n=>this.recalculateAndSaveOverlays(e,n))}getDocumentsMatchingQuery(e,t,n,i){return K.isDocumentKey((a=t).path)&&null===a.collectionGroup&&0===a.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Ir(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,i):this.getDocumentsMatchingCollectionQuery(e,t,n,i);var a}getNextDocuments(e,t,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,i).next(s=>{const a=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,i-s.size):b.resolve(on());let u=-1,l=s;return a.next(d=>b.forEach(d,(g,y)=>(u<y.largestBatchId&&(u=y.largestBatchId),s.get(g)?b.resolve():this.remoteDocumentCache.getEntry(e,g).next(E=>{l=l.insert(g,E)}))).next(()=>this.populateOverlays(e,d,s)).next(()=>this.computeViews(e,l,d,ae())).next(g=>({batchId:u,changes:Hc(g)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new K(t)).next(n=>{let i=Hi();return n.isFoundDocument()&&(i=i.insert(n.key,n)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,n,i){const s=t.collectionGroup;let a=Hi();return this.indexManager.getCollectionParents(e,s).next(u=>b.forEach(u,l=>{const d=(y=t,E=l.child(s),new mt(E,null,y.explicitOrderBy.slice(),y.filters.slice(),y.limit,y.limitType,y.startAt,y.endAt));var y,E;return this.getDocumentsMatchingCollectionQuery(e,d,n,i).next(g=>{g.forEach((y,E)=>{a=a.insert(y,E)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(e,t,n,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(a=>(s=a,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,i))).next(a=>{s.forEach((l,d)=>{const g=d.getKey();null===a.get(g)&&(a=a.insert(g,Ce.newInvalidDocument(g)))});let u=Hi();return a.forEach((l,d)=>{const g=s.get(l);void 0!==g&&Yi(g.mutation,d,ut.empty(),Ve.now()),Wi(t,d)&&(u=u.insert(l,d))}),u})}}class Fg{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return b.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,{id:(i=t).id,version:i.version,createTime:He(i.createTime)}),b.resolve();var i}getNamedQuery(e,t){return b.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,{name:(i=t).name,query:yu(i.bundledQuery),readTime:He(i.readTime)}),b.resolve();var i}}class Lg{constructor(){this.overlays=new Te(K.comparator),this.Ir=new Map}getOverlay(e,t){return b.resolve(this.overlays.get(t))}getOverlays(e,t){const n=on();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{null!==s&&n.set(i,s)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((i,s)=>{this.ht(e,t,s)}),b.resolve()}removeOverlaysForBatchId(e,t,n){const i=this.Ir.get(n);return void 0!==i&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(n)),b.resolve()}getOverlaysForCollection(e,t,n){const i=on(),s=t.length+1,a=new K(t.child("")),u=this.overlays.getIteratorFrom(a);for(;u.hasNext();){const l=u.getNext().value,d=l.getKey();if(!t.isPrefixOf(d.path))break;d.path.length===s&&l.largestBatchId>n&&i.set(l.getKey(),l)}return b.resolve(i)}getOverlaysForCollectionGroup(e,t,n,i){let s=new Te((d,g)=>d-g);const a=this.overlays.getIterator();for(;a.hasNext();){const d=a.getNext().value;if(d.getKey().getCollectionGroup()===t&&d.largestBatchId>n){let g=s.get(d.largestBatchId);null===g&&(g=on(),s=s.insert(d.largestBatchId,g)),g.set(d.getKey(),d)}}const u=on(),l=s.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((d,g)=>u.set(d,g)),!(u.size()>=i)););return b.resolve(u)}ht(e,t,n){const i=this.overlays.get(n.key);if(null!==i){const a=this.Ir.get(i.largestBatchId).delete(n.key);this.Ir.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(n.key,new hu(t,n));let s=this.Ir.get(t);void 0===s&&(s=ae(),this.Ir.set(t,s)),this.Ir.set(t,s.add(n.key))}}class Ug{constructor(){this.sessionToken=Oe.EMPTY_BYTE_STRING}getSessionToken(e){return b.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,b.resolve()}}class Ru{constructor(){this.Tr=new Ie(ot.Er),this.dr=new Ie(ot.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){const n=new ot(e,t);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(e,t){e.forEach(n=>this.addReference(n,t))}removeReference(e,t){this.Vr(new ot(e,t))}mr(e,t){e.forEach(n=>this.removeReference(n,t))}gr(e){const t=new K(new le([])),n=new ot(t,e),i=new ot(t,e+1),s=[];return this.dr.forEachInRange([n,i],a=>{this.Vr(a),s.push(a.key)}),s}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){const t=new K(new le([])),n=new ot(t,e),i=new ot(t,e+1);let s=ae();return this.dr.forEachInRange([n,i],a=>{s=s.add(a.key)}),s}containsKey(e){const t=new ot(e,0),n=this.Tr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class ot{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return K.comparator(e.key,t.key)||re(e.wr,t.wr)}static Ar(e,t){return re(e.wr,t.wr)||K.comparator(e.key,t.key)}}class Bg{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new Ie(ot.Er)}checkEmpty(e){return b.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,i){const s=this.Sr;this.Sr++;const a=new lu(s,t,n,i);this.mutationQueue.push(a);for(const u of i)this.br=this.br.add(new ot(u.key,s)),this.indexManager.addToCollectionParentIndex(e,u.key.path.popLast());return b.resolve(a)}lookupMutationBatch(e,t){return b.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){const i=this.vr(t+1),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(0===this.mutationQueue.length?-1:this.Sr-1)}getAllMutationBatches(e){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new ot(t,0),i=new ot(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([n,i],a=>{const u=this.Dr(a.wr);s.push(u)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Ie(re);return t.forEach(i=>{const s=new ot(i,0),a=new ot(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,a],u=>{n=n.add(u.wr)})}),b.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,i=n.length+1;let s=n;K.isDocumentKey(s)||(s=s.child(""));const a=new ot(new K(s),0);let u=new Ie(re);return this.br.forEachWhile(l=>{const d=l.key.path;return!!n.isPrefixOf(d)&&(d.length===i&&(u=u.add(l.wr)),!0)},a),b.resolve(this.Cr(u))}Cr(e){const t=[];return e.forEach(n=>{const i=this.Dr(n);null!==i&&t.push(i)}),t}removeMutationBatch(e,t){X(0===this.Fr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.br;return b.forEach(t.mutations,i=>{const s=new ot(i.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.br=n})}On(e){}containsKey(e,t){const n=new ot(t,0),i=this.br.firstAfterOrEqual(n);return b.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return b.resolve()}Fr(e,t){return this.vr(e)}vr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Dr(e){const t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class qg{constructor(e){this.Mr=e,this.docs=new Te(K.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,i=this.docs.get(n),s=i?i.size:0,a=this.Mr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:a}),this.size+=a-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return b.resolve(n?n.document.mutableCopy():Ce.newInvalidDocument(t))}getEntries(e,t){let n=Dt();return t.forEach(i=>{const s=this.docs.get(i);n=n.insert(i,s?s.document.mutableCopy():Ce.newInvalidDocument(i))}),b.resolve(n)}getDocumentsMatchingQuery(e,t,n,i){let s=Dt();const a=t.path,u=new K(a.child("")),l=this.docs.getIteratorFrom(u);for(;l.hasNext();){const{key:d,value:{document:g}}=l.getNext();if(!a.isPrefixOf(d.path))break;d.path.length>a.length+1||Ze(Mi(g),n)<=0||(i.has(g.key)||Wi(t,g))&&(s=s.insert(g.key,g.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(e,t,n,i){$()}Or(e,t){return b.forEach(this.docs,n=>t(n))}newChangeBuffer(e){return new Gg(this)}getSize(e){return b.resolve(this.size)}}class Gg extends nd{constructor(e){super(),this.cr=e}applyChanges(e){const t=[];return this.changes.forEach((n,i)=>{i.isValidDocument()?t.push(this.cr.addEntry(e,i)):this.cr.removeEntry(n)}),b.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}class Kg{constructor(e){this.persistence=e,this.Nr=new vn(t=>ze(t),De),this.lastRemoteSnapshotVersion=j.min(),this.highestTargetId=0,this.Lr=0,this.Br=new Ru,this.targetCount=0,this.kr=br.Bn()}forEachTarget(e,t){return this.Nr.forEach((n,i)=>t(i)),b.resolve()}getLastRemoteSnapshotVersion(e){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return b.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Lr&&(this.Lr=t),b.resolve()}Kn(e){this.Nr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.kr=new br(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,b.resolve()}updateTargetData(e,t){return this.Kn(t),b.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,b.resolve()}removeTargets(e,t,n){let i=0;const s=[];return this.Nr.forEach((a,u)=>{u.sequenceNumber<=t&&null===n.get(u.targetId)&&(this.Nr.delete(a),s.push(this.removeMatchingKeysForTargetId(e,u.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(e){return b.resolve(this.targetCount)}getTargetData(e,t){const n=this.Nr.get(t)||null;return b.resolve(n)}addMatchingKeys(e,t,n){return this.Br.Rr(t,n),b.resolve()}removeMatchingKeys(e,t,n){this.Br.mr(t,n);const i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(a=>{s.push(i.markPotentiallyOrphaned(e,a))}),b.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),b.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Br.yr(t);return b.resolve(n)}containsKey(e,t){return b.resolve(this.Br.containsKey(t))}}class Pu{constructor(e,t){this.qr={},this.overlays={},this.Qr=new Xe(0),this.Kr=!1,this.Kr=!0,this.$r=new Ug,this.referenceDelegate=e(this),this.Ur=new Kg(this),this.indexManager=new bg,this.remoteDocumentCache=new qg(n=>this.referenceDelegate.Wr(n)),this.serializer=new Nh(t),this.Gr=new Fg(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Lg,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.qr[e.toKey()];return n||(n=new Bg(t,this.referenceDelegate),this.qr[e.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,n){M("MemoryPersistence","Starting transaction:",e);const i=new zg(this.Qr.next());return this.referenceDelegate.zr(),n(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(e,t){return b.or(Object.values(this.qr).map(n=>()=>n.containsKey(e,t)))}}class zg extends no{constructor(e){super(),this.currentSequenceNumber=e}}class Ko{constructor(e){this.persistence=e,this.Jr=new Ru,this.Yr=null}static Zr(e){return new Ko(e)}get Xr(){if(this.Yr)return this.Yr;throw $()}addReference(e,t,n){return this.Jr.addReference(n,t),this.Xr.delete(n.toString()),b.resolve()}removeReference(e,t,n){return this.Jr.removeReference(n,t),this.Xr.add(n.toString()),b.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),b.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(i=>this.Xr.add(i.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>n.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Xr,n=>{const i=K.fromPath(n);return this.ei(e,i).next(s=>{s||t.removeEntry(i,j.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(n=>{n?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return b.or([()=>b.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}class jg{constructor(e){this.serializer=e}O(e,t,n,i){const s=new cr("createOrUpgrade",t);var l;n<1&&i>=1&&(e.createObjectStore("owner"),(l=e).createObjectStore("mutationQueues",{keyPath:"userId"}),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",oo,{unique:!0}),l.createObjectStore("documentMutations"),ud(e),function(l){l.createObjectStore("remoteDocuments")}(e));let a=b.resolve();return n<3&&i>=3&&(0!==n&&(function(l){l.deleteObjectStore("targetDocuments"),l.deleteObjectStore("targets"),l.deleteObjectStore("targetGlobal")}(e),ud(e)),a=a.next(()=>function(l){const d=l.store("targetGlobal"),g={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:j.min().toTimestamp(),targetCount:0};return d.put("targetGlobalKey",g)}(s))),n<4&&i>=4&&(0!==n&&(a=a.next(()=>function(l,d){return d.store("mutations").U().next(g=>{l.deleteObjectStore("mutations"),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",oo,{unique:!0});const y=d.store("mutations"),E=g.map(V=>y.put(V));return b.waitFor(E)})}(e,s))),a=a.next(()=>{!function(l){l.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)})),n<5&&i>=5&&(a=a.next(()=>this.ni(s))),n<6&&i>=6&&(a=a.next(()=>(function(l){l.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s)))),n<7&&i>=7&&(a=a.next(()=>this.ii(s))),n<8&&i>=8&&(a=a.next(()=>this.si(e,s))),n<9&&i>=9&&(a=a.next(()=>{!function(l){l.objectStoreNames.contains("remoteDocumentChanges")&&l.deleteObjectStore("remoteDocumentChanges")}(e)})),n<10&&i>=10&&(a=a.next(()=>this.oi(s))),n<11&&i>=11&&(a=a.next(()=>{(function(l){l.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(l){l.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),n<12&&i>=12&&(a=a.next(()=>{!function(l){const d=l.createObjectStore("documentOverlays",{keyPath:Ja});d.createIndex("collectionPathOverlayIndex",Ya,{unique:!1}),d.createIndex("collectionGroupOverlayIndex",Mt,{unique:!1})}(e)})),n<13&&i>=13&&(a=a.next(()=>function(l){const d=l.createObjectStore("remoteDocumentsV14",{keyPath:Ui});d.createIndex("documentKeyIndex",$a),d.createIndex("collectionGroupIndex",Qa)}(e)).next(()=>this._i(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),n<14&&i>=14&&(a=a.next(()=>this.ai(e,s))),n<15&&i>=15&&(a=a.next(()=>function(l){l.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),l.createObjectStore("indexState",{keyPath:Bi}).createIndex("sequenceNumberIndex",Xa,{unique:!1}),l.createObjectStore("indexEntries",{keyPath:Gn}).createIndex("documentKeyIndex",uo,{unique:!1})}(e))),n<16&&i>=16&&(a=a.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),n<17&&i>=17&&(a=a.next(()=>{!function(l){l.createObjectStore("globals",{keyPath:"name"})}(e)})),a}ri(e){let t=0;return e.store("remoteDocuments").J((n,i)=>{t+=Bo(i)}).next(()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next(i=>b.forEach(i,s=>{const a=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",a).next(u=>b.forEach(u,l=>{X(l.userId===s.userId);const d=Rr(this.serializer,l);return Hh(e,s.userId,d).next(()=>{})}))}))}ii(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return n.J((a,u)=>{const l=new le(a),d=[0,et(l)];s.push(t.get(d).next(g=>g?b.resolve():t.put({targetId:0,path:et(l),sequenceNumber:i.highestListenSequenceNumber})))}).next(()=>b.waitFor(s))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:at});const n=t.store("collectionParents"),i=new wu,s=a=>{if(i.add(a)){const u=a.lastSegment(),l=a.popLast();return n.put({collectionId:u,parent:et(l)})}};return t.store("remoteDocuments").J({H:!0},(a,u)=>{const l=new le(a);return s(l.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([a,u,l],d)=>{const g=Kt(u);return s(g.popLast())}))}oi(e){const t=e.store("targets");return t.J((n,i)=>{const s=is(i),a=Oh(this.serializer,s);return t.put(a)})}_i(e,t){const n=t.store("remoteDocuments"),i=[];return n.J((s,a)=>{const u=t.store("remoteDocumentsV14"),l=(y=a,y.document?new K(le.fromString(y.document.name).popFirst(5)):y.noDocument?K.fromSegments(y.noDocument.path):y.unknownDocument?K.fromSegments(y.unknownDocument.path):$()).path.toArray(),d={prefixPath:l.slice(0,l.length-2),collectionGroup:l[l.length-2],documentId:l[l.length-1],readTime:a.readTime||[0,0],unknownDocument:a.unknownDocument,noDocument:a.noDocument,document:a.document,hasCommittedMutations:!!a.hasCommittedMutations};var y;i.push(u.put(d))}).next(()=>b.waitFor(i))}ai(e,t){const n=t.store("mutations"),i=rd(this.serializer),s=new Pu(Ko.Zr,this.serializer.ct);return n.U().next(a=>{const u=new Map;return a.forEach(l=>{var d;let g=null!==(d=u.get(l.userId))&&void 0!==d?d:ae();Rr(this.serializer,l).keys().forEach(y=>g=g.add(y)),u.set(l.userId,g)}),b.forEach(u,(l,d)=>{const g=new ke(d),y=Fo.lt(this.serializer,g),E=s.getIndexManager(g),V=qo.lt(g,this.serializer,E,s.referenceDelegate);return new ad(i,V,y,E).recalculateAndSaveOverlaysForDocumentKeys(new qi(t,Xe.oe),l).next()})})}}function ud(r){r.createObjectStore("targetDocuments",{keyPath:Wa}).createIndex("documentTargetsIndex",Ha,{unique:!0}),r.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ao,{unique:!0}),r.createObjectStore("targetGlobal")}const Su="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class bu{constructor(e,t,n,i,s,a,u,l,d,g,y=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ui=s,this.window=a,this.document=u,this.ci=d,this.li=g,this.hi=y,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=E=>Promise.resolve(),!bu.D())throw new L(D.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ng(this,i),this.Ai=t+"main",this.serializer=new Nh(l),this.Ri=new Gt(this.Ai,this.hi,new jg(this.serializer)),this.$r=new vg,this.Ur=new xg(this.referenceDelegate,this.serializer),this.remoteDocumentCache=rd(this.serializer),this.Gr=new Eg,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,!1===g&&Ge("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new L(D.FAILED_PRECONDITION,Su);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new Xe(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){var t=this;return this.di=function(){var n=(0,O.A)(function*(i){if(t.started)return e(i)});return function(i){return n.apply(this,arguments)}}(),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(function(){var t=(0,O.A)(function*(n){null===n.newVersion&&(yield e())});return function(n){return t.apply(this,arguments)}}())}setNetworkEnabled(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget((0,O.A)(function*(){t.started&&(yield t.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>jo(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(t=>{t||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(Yt(e))return M("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return M("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return ls(e).get("owner").next(t=>b.resolve(this.vi(t)))}Ci(e){return jo(e).delete(this.clientId)}Fi(){var e=this;return(0,O.A)(function*(){if(e.isPrimary&&!e.Mi(e.Ei,18e5)){e.Ei=Date.now();const t=yield e.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",n=>{const i=je(n,"clientMetadata");return i.U().next(s=>{const a=e.xi(s,18e5),u=s.filter(l=>-1===a.indexOf(l));return b.forEach(u,l=>i.delete(l.clientId)).next(()=>u)})}).catch(()=>[]);if(e.Vi)for(const n of t)e.Vi.removeItem(e.Oi(n.clientId))}})()}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?b.resolve(!0):ls(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new L(D.FAILED_PRECONDITION,Su);return!1}}return!(!this.networkEnabled||!this.inForeground)||jo(e).U().next(n=>void 0===this.xi(n,5e3).find(i=>!(this.clientId===i.clientId||!(!this.networkEnabled&&i.networkEnabled||!this.inForeground&&i.inForeground&&this.networkEnabled===i.networkEnabled))))}).next(t=>(this.isPrimary!==t&&M("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){var e=this;return(0,O.A)(function*(){e.Kr=!1,e.Li(),e.Ti&&(e.Ti.cancel(),e.Ti=null),e.Bi(),e.ki(),yield e.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{const n=new qi(t,Xe.oe);return e.bi(n).next(()=>e.Ci(n))}),e.Ri.close(),e.qi()})()}xi(e,t){return e.filter(n=>this.Mi(n.updateTimeMs,t)&&!this.Ni(n.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>jo(e).U().next(t=>this.xi(t,18e5).map(n=>n.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return qo.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Vg(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Fo.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,n){M("IndexedDbPersistence","Starting transaction:",e);const i="readonly"===t?"readonly":"readwrite",s=17===(l=this.hi)?eu:16===l?pn:15===l?Wr:14===l?ho:13===l?co:12===l?Za:11===l?lo:void $();var l;let a;return this.Ri.runTransaction(e,i,s,u=>(a=new qi(u,this.Qr?this.Qr.next():Xe.oe),"readwrite-primary"===t?this.wi(a).next(l=>!!l||this.Si(a)).next(l=>{if(!l)throw Ge(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new L(D.FAILED_PRECONDITION,lr);return n(a)}).next(l=>this.Di(a).next(()=>l)):this.Ki(a).next(()=>n(a)))).then(u=>(a.raiseOnCommittedEvent(),u))}Ki(e){return ls(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)&&!this.vi(t)&&!(this.li||this.allowTabSynchronization&&t.allowTabSynchronization))throw new L(D.FAILED_PRECONDITION,Su)})}Di(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return ls(e).put("owner",t)}static D(){return Gt.D()}bi(e){const t=ls(e);return t.get("owner").next(n=>this.vi(n)?(M("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):b.resolve())}Mi(e,t){const n=Date.now();return!(e<n-t||e>n&&(Ge(`Detected an update time that is in the future: ${e} > ${n}`),1))}fi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground="visible"===this.document.visibilityState)}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Pi=()=>{this.Li();const t=/(?:Version|Mobile)\/1[456]/;(0,ee.nr)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{const n=null!==(null===(t=this.Vi)||void 0===t?void 0:t.getItem(this.Oi(e)));return M("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(n){return Ge("IndexedDbPersistence","Failed to get zombied client id.",n),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){Ge("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function ls(r){return je(r,"owner")}function jo(r){return je(r,"clientMetadata")}function Vu(r,e){let t=r.projectId;return r.isDefaultDatabase||(t+="."+r.database),"firestore/"+e+"/"+t+"/"}class xu{constructor(e,t,n,i){this.targetId=e,this.fromCache=t,this.$i=n,this.Ui=i}static Wi(e,t){let n=ae(),i=ae();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new xu(e,t.fromCache,n,i)}}class $g{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class ld{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=(0,ee.nr)()?8:$r((0,ee.ZQ)())>0?6:4}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,n,i){const s={result:null};return this.Yi(e,t).next(a=>{s.result=a}).next(()=>{if(!s.result)return this.Zi(e,t,i,n).next(a=>{s.result=a})}).next(()=>{if(s.result)return;const a=new $g;return this.Xi(e,t,a).next(u=>{if(s.result=u,this.zi)return this.es(e,t,a,u.size)})}).next(()=>s.result)}es(e,t,n,i){return n.documentReadCount<this.ji?(Bt()<=fe.$b.DEBUG&&M("QueryEngine","SDK will not create cache indexes for query:",Yr(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),b.resolve()):(Bt()<=fe.$b.DEBUG&&M("QueryEngine","Query:",Yr(t),"scans",n.documentReadCount,"local documents and returns",i,"documents as results."),n.documentReadCount>this.Hi*i?(Bt()<=fe.$b.DEBUG&&M("QueryEngine","The SDK decides to create cache indexes for query:",Yr(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,gt(t))):b.resolve())}Yi(e,t){if($n(t))return b.resolve(null);let n=gt(t);return this.indexManager.getIndexType(e,n).next(i=>0===i?null:(null!==t.limit&&1===i&&(t=Vo(t,null,"F"),n=gt(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next(s=>{const a=ae(...s);return this.Ji.getDocuments(e,a).next(u=>this.indexManager.getMinOffset(e,n).next(l=>{const d=this.ts(t,u);return this.ns(t,d,a,l.readTime)?this.Yi(e,Vo(t,null,"F")):this.rs(e,d,t,l)}))})))}Zi(e,t,n,i){return $n(t)||i.isEqual(j.min())?b.resolve(null):this.Ji.getDocuments(e,n).next(s=>{const a=this.ts(t,s);return this.ns(t,a,n,i)?b.resolve(null):(Bt()<=fe.$b.DEBUG&&M("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Yr(t)),this.rs(e,a,t,to(i,-1)).next(u=>u))})}ts(e,t){let n=new Ie(Qc(e));return t.forEach((i,s)=>{Wi(e,s)&&(n=n.add(s))}),n}ns(e,t,n,i){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(e,t,n){return Bt()<=fe.$b.DEBUG&&M("QueryEngine","Using full collection scan to execute query:",Yr(t)),this.Ji.getDocumentsMatchingQuery(e,t,wt.min(),n)}rs(e,t,n,i){return this.Ji.getDocumentsMatchingQuery(e,n,i).next(s=>(t.forEach(a=>{s=s.insert(a.key,a)}),s))}}class Qg{constructor(e,t,n,i){this.persistence=e,this.ss=t,this.serializer=i,this.os=new Te(re),this._s=new vn(s=>ze(s),De),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(n)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new ad(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}}function cd(r,e,t,n){return new Qg(r,e,t,n)}function hd(r,e){return Cu.apply(this,arguments)}function Cu(){return(Cu=(0,O.A)(function*(r,e){const t=G(r);return yield t.persistence.runTransaction("Handle user change","readonly",n=>{let i;return t.mutationQueue.getAllMutationBatches(n).next(s=>(i=s,t.ls(e),t.mutationQueue.getAllMutationBatches(n))).next(s=>{const a=[],u=[];let l=ae();for(const d of i){a.push(d.batchId);for(const g of d.mutations)l=l.add(g.key)}for(const d of s){u.push(d.batchId);for(const g of d.mutations)l=l.add(g.key)}return t.localDocuments.getDocuments(n,l).next(d=>({hs:d,removedBatchIds:a,addedBatchIds:u}))})})})).apply(this,arguments)}function dd(r){const e=G(r);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function fd(r,e,t){let n=ae(),i=ae();return t.forEach(s=>n=n.add(s)),e.getEntries(r,n).next(s=>{let a=Dt();return t.forEach((u,l)=>{const d=s.get(u);l.isFoundDocument()!==d.isFoundDocument()&&(i=i.add(u)),l.isNoDocument()&&l.version.isEqual(j.min())?(e.removeEntry(u,l.readTime),a=a.insert(u,l)):!d.isValidDocument()||l.version.compareTo(d.version)>0||0===l.version.compareTo(d.version)&&d.hasPendingWrites?(e.addEntry(l),a=a.insert(u,l)):M("LocalStore","Ignoring outdated watch update for ",u,". Current version:",d.version," Watch version:",l.version)}),{Ps:a,Is:i}})}function Xg(r,e){const t=G(r);return t.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===e&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(n,e)))}function li(r,e){const t=G(r);return t.persistence.runTransaction("Allocate target","readwrite",n=>{let i;return t.Ur.getTargetData(n,e).next(s=>s?(i=s,b.resolve(i)):t.Ur.allocateTargetId(n).next(a=>(i=new wn(e,a,"TargetPurposeListen",n.currentSequenceNumber),t.Ur.addTargetData(n,i).next(()=>i))))}).then(n=>{const i=t.os.get(n.targetId);return(null===i||n.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.os=t.os.insert(n.targetId,n),t._s.set(e,n.targetId)),n})}function ci(r,e,t){return Du.apply(this,arguments)}function Du(){return(Du=(0,O.A)(function*(r,e,t){const n=G(r),i=n.os.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield n.persistence.runTransaction("Release target",s,a=>n.persistence.referenceDelegate.removeTarget(a,i)))}catch(a){if(!Yt(a))throw a;M("LocalStore",`Failed to update sequence numbers for target ${e}: ${a}`)}n.os=n.os.remove(e),n._s.delete(i.target)})).apply(this,arguments)}function $o(r,e,t){const n=G(r);let i=j.min(),s=ae();return n.persistence.runTransaction("Execute query","readwrite",a=>function(l,d,g){const y=G(l),E=y._s.get(g);return void 0!==E?b.resolve(y.os.get(E)):y.Ur.getTargetData(d,g)}(n,a,gt(e)).next(u=>{if(u)return i=u.lastLimboFreeSnapshotVersion,n.Ur.getMatchingKeysForTargetId(a,u.targetId).next(l=>{s=l})}).next(()=>n.ss.getDocumentsMatchingQuery(a,e,t?i:j.min(),t?s:ae())).next(u=>(pd(n,$c(e),u),{documents:u,Ts:s})))}function md(r,e){const t=G(r),n=G(t.Ur),i=t.os.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>n.ot(s,e).next(a=>a?a.target:null))}function gd(r,e){const t=G(r),n=t.us.get(e)||j.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.cs.getAllFromCollectionGroup(i,e,to(n,-1),Number.MAX_SAFE_INTEGER)).then(i=>(pd(t,e,i),i))}function pd(r,e,t){let n=r.us.get(e)||j.min();t.forEach((i,s)=>{s.readTime.compareTo(n)>0&&(n=s.readTime)}),r.us.set(e,n)}function Nu(){return(Nu=(0,O.A)(function*(r,e,t,n){const i=G(r);let s=ae(),a=Dt();for(const d of t){const g=e.Es(d.metadata.name);d.document&&(s=s.add(g));const y=e.ds(d);y.setReadTime(e.As(d.metadata.readTime)),a=a.insert(g,y)}const u=i.cs.newChangeBuffer({trackRemovals:!0}),l=yield li(i,(g=n,gt(sn(le.fromString(`__bundle__/docs/${g}`)))));var g;return i.persistence.runTransaction("Apply bundle documents","readwrite",d=>fd(d,u,a).next(g=>(u.apply(d),g)).next(g=>i.Ur.removeMatchingKeysForTargetId(d,l.targetId).next(()=>i.Ur.addMatchingKeys(d,s,l.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(d,g.Ps,g.Is)).next(()=>g.Ps)))})).apply(this,arguments)}function Yg(r,e){return ku.apply(this,arguments)}function ku(){return(ku=(0,O.A)(function*(r,e,t=ae()){const n=yield li(r,gt(yu(e.bundledQuery))),i=G(r);return i.persistence.runTransaction("Save named query","readwrite",s=>{const a=He(e.readTime);if(n.snapshotVersion.compareTo(a)>=0)return i.Gr.saveNamedQuery(s,e);const u=n.withResumeToken(Oe.EMPTY_BYTE_STRING,a);return i.os=i.os.insert(u.targetId,u),i.Ur.updateTargetData(s,u).next(()=>i.Ur.removeMatchingKeysForTargetId(s,n.targetId)).next(()=>i.Ur.addMatchingKeys(s,t,n.targetId)).next(()=>i.Gr.saveNamedQuery(s,e))})})).apply(this,arguments)}function _d(r,e){return`firestore_clients_${r}_${e}`}function yd(r,e,t){let n=`firestore_mutations_${r}_${t}`;return e.isAuthenticated()&&(n+=`_${e.uid}`),n}function Ou(r,e){return`firestore_targets_${r}_${e}`}class Qo{constructor(e,t,n,i){this.user=e,this.batchId=t,this.state=n,this.error=i}static Rs(e,t,n){const i=JSON.parse(n);let s,a="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return a&&i.error&&(a="string"==typeof i.error.message&&"string"==typeof i.error.code,a&&(s=new L(i.error.code,i.error.message))),a?new Qo(e,t,i.state,s):(Ge("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class cs{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Rs(e,t){const n=JSON.parse(t);let i,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(i=new L(n.error.code,n.error.message))),s?new cs(e,n.state,i):(Ge("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Wo{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){const n=JSON.parse(t);let i="object"==typeof n&&n.activeTargetIds instanceof Array,s=ou();for(let a=0;i&&a<n.activeTargetIds.length;++a)i=io(n.activeTargetIds[a]),s=s.add(n.activeTargetIds[a]);return i?new Wo(e,s):(Ge("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Mu{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Mu(t.clientId,t.onlineState):(Ge("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Fu{constructor(){this.activeTargetIds=ou()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Lu{constructor(e,t,n,i,s){this.window=e,this.ui=t,this.persistenceKey=n,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new Te(re),this.started=!1,this.bs=[];const a=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=_d(this.persistenceKey,this.ps),this.vs=`firestore_sequence_number_${this.persistenceKey}`,this.Ss=this.Ss.insert(this.ps,new Fu),this.Cs=new RegExp(`^firestore_clients_${a}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${a}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${a}_(\\d+)$`),this.xs=`firestore_online_state_${this.persistenceKey}`,this.Os=function(l){return`firestore_bundle_loaded_v2_${l}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}start(){var e=this;return(0,O.A)(function*(){const t=yield e.syncEngine.Qi();for(const i of t){if(i===e.ps)continue;const s=e.getItem(_d(e.persistenceKey,i));if(s){const a=Wo.Rs(i,s);a&&(e.Ss=e.Ss.insert(a.clientId,a))}}e.Ns();const n=e.storage.getItem(e.xs);if(n){const i=e.Ls(n);i&&e.Bs(i)}for(const i of e.bs)e.ws(i);e.bs=[],e.window.addEventListener("pagehide",()=>e.shutdown()),e.started=!0})()}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((n,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,n){this.qs(e,t,n),this.Qs(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Ou(this.persistenceKey,e));if(n){const i=cs.Rs(e,n);i&&(t=i.state)}}return this.Ks.fs(e),this.Ns(),t}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Ou(this.persistenceKey,e))}updateQueryState(e,t,n){this.$s(e,t,n)}handleUserChange(e,t,n){t.forEach(i=>{this.Qs(i)}),this.currentUser=e,n.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return M("SharedClientState","READ",e,t),t}setItem(e,t){M("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){M("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){var t=this;const n=e;if(n.storageArea===this.storage){if(M("SharedClientState","EVENT",n.key,n.newValue),n.key===this.Ds)return void Ge("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable((0,O.A)(function*(){if(t.started){if(null!==n.key)if(t.Cs.test(n.key)){if(null==n.newValue){const i=t.Gs(n.key);return t.zs(i,null)}{const i=t.js(n.key,n.newValue);if(i)return t.zs(i.clientId,i)}}else if(t.Fs.test(n.key)){if(null!==n.newValue){const i=t.Hs(n.key,n.newValue);if(i)return t.Js(i)}}else if(t.Ms.test(n.key)){if(null!==n.newValue){const i=t.Ys(n.key,n.newValue);if(i)return t.Zs(i)}}else if(n.key===t.xs){if(null!==n.newValue){const i=t.Ls(n.newValue);if(i)return t.Bs(i)}}else if(n.key===t.vs){const i=function(a){let u=Xe.oe;if(null!=a)try{const l=JSON.parse(a);X("number"==typeof l),u=l}catch(l){Ge("SharedClientState","Failed to read sequence number from WebStorage",l)}return u}(n.newValue);i!==Xe.oe&&t.sequenceNumberHandler(i)}else if(n.key===t.Os){const i=t.Xs(n.newValue);yield Promise.all(i.map(s=>t.syncEngine.eo(s)))}}else t.bs.push(n)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,n){const i=new Qo(this.currentUser,e,t,n),s=yd(this.persistenceKey,this.currentUser,e);this.setItem(s,i.Vs())}Qs(e){const t=yd(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){this.storage.setItem(this.xs,JSON.stringify({clientId:this.ps,onlineState:e}))}$s(e,t,n){const i=Ou(this.persistenceKey,e),s=new cs(e,t,n);this.setItem(i,s.Vs())}Ws(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){const t=this.Cs.exec(e);return t?t[1]:null}js(e,t){const n=this.Gs(e);return Wo.Rs(n,t)}Hs(e,t){const n=this.Fs.exec(e),i=Number(n[1]);return Qo.Rs(new ke(void 0!==n[2]?n[2]:null),i,t)}Ys(e,t){const n=this.Ms.exec(e),i=Number(n[1]);return cs.Rs(i,t)}Ls(e){return Mu.Rs(e)}Xs(e){return JSON.parse(e)}Js(e){var t=this;return(0,O.A)(function*(){if(e.user.uid===t.currentUser.uid)return t.syncEngine.no(e.batchId,e.state,e.error);M("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})()}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){const n=t?this.Ss.insert(e,t):this.Ss.remove(e),i=this.ks(this.Ss),s=this.ks(n),a=[],u=[];return s.forEach(l=>{i.has(l)||a.push(l)}),i.forEach(l=>{s.has(l)||u.push(l)}),this.syncEngine.io(a,u).then(()=>{this.Ss=n})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=ou();return e.forEach((n,i)=>{t=t.unionWith(i.activeTargetIds)}),t}}class Td{constructor(){this.so=new Fu,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,n){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new Fu,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Zg{_o(e){}shutdown(){}}class Id{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){M("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ho)e(0)}lo(){M("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ho)e(1)}static D(){return typeof window<"u"&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Ho=null;function Uu(){return null===Ho?Ho=268435456+Math.round(2147483648*Math.random()):Ho++,"0x"+Ho.toString(16)}const ep={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class tp{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}const _t="WebChannelConnection";class np extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const n=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=n+"://"+t.host,this.vo=`projects/${i}/databases/${s}`,this.Co="(default)"===this.databaseId.database?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(t,n,i,s,a){const u=Uu(),l=this.xo(t,n.toUriEncodedString());M("RestConnection",`Sending RPC '${t}' ${u}:`,l,i);const d={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(d,s,a),this.No(t,l,d,i).then(g=>(M("RestConnection",`Received RPC '${t}' ${u}: `,g),g),g=>{throw ft("RestConnection",`RPC '${t}' ${u} failed with error: `,g,"url: ",l,"request:",i),g})}Lo(t,n,i,s,a,u){return this.Mo(t,n,i,s,a)}Oo(t,n,i){t["X-Goog-Api-Client"]="gl-js/ fire/"+dn,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),n&&n.headers.forEach((s,a)=>t[a]=s),i&&i.headers.forEach((s,a)=>t[a]=s)}xo(t,n){return`${this.Do}/v1/${n}:${ep[t]}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,n,i){const s=Uu();return new Promise((a,u)=>{const l=new zs;l.setWithCredentials(!0),l.listenOnce(js.COMPLETE,()=>{try{switch(l.getLastErrorCode()){case zr.NO_ERROR:const g=l.getResponseJson();M(_t,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(g)),a(g);break;case zr.TIMEOUT:M(_t,`RPC '${e}' ${s} timed out`),u(new L(D.DEADLINE_EXCEEDED,"Request time out"));break;case zr.HTTP_ERROR:const y=l.getStatus();if(M(_t,`RPC '${e}' ${s} failed with status:`,y,"response text:",l.getResponseText()),y>0){let E=l.getResponseJson();Array.isArray(E)&&(E=E[0]);const V=null==E?void 0:E.error;if(V&&V.status&&V.message){const F=function(U){const H=U.toLowerCase().replace(/_/g,"-");return Object.values(D).indexOf(H)>=0?H:D.UNKNOWN}(V.status);u(new L(F,V.message))}else u(new L(D.UNKNOWN,"Server responded with status "+l.getStatus()))}else u(new L(D.UNAVAILABLE,"Connection failed."));break;default:$()}}finally{M(_t,`RPC '${e}' ${s} completed.`)}});const d=JSON.stringify(i);M(_t,`RPC '${e}' ${s} sending request:`,i),l.send(t,"POST",d,n,15)})}Bo(e,t,n){const i=Uu(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=Qs(),u=$s(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},d=this.longPollingOptions.timeoutSeconds;void 0!==d&&(l.longPollingTimeout=Math.round(1e3*d)),this.useFetchStreams&&(l.xmlHttpFactory=new xi({})),this.Oo(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;const g=s.join("");M(_t,`Creating RPC '${e}' stream ${i}: ${g}`,l);const y=a.createWebChannel(g,l);let E=!1,V=!1;const F=new tp({Io:U=>{V?M(_t,`Not sending because RPC '${e}' stream ${i} is closed:`,U):(E||(M(_t,`Opening RPC '${e}' stream ${i} transport.`),y.open(),E=!0),M(_t,`RPC '${e}' stream ${i} sending:`,U),y.send(U))},To:()=>y.close()}),q=(U,H,Z)=>{U.listen(H,J=>{try{Z(J)}catch(ne){setTimeout(()=>{throw ne},0)}})};return q(y,On.EventType.OPEN,()=>{V||(M(_t,`RPC '${e}' stream ${i} transport opened.`),F.yo())}),q(y,On.EventType.CLOSE,()=>{V||(V=!0,M(_t,`RPC '${e}' stream ${i} transport closed`),F.So())}),q(y,On.EventType.ERROR,U=>{V||(V=!0,ft(_t,`RPC '${e}' stream ${i} transport errored:`,U),F.So(new L(D.UNAVAILABLE,"The operation could not be completed")))}),q(y,On.EventType.MESSAGE,U=>{var H;if(!V){const Z=U.data[0];X(!!Z);const ne=Z.error||(null===(H=Z[0])||void 0===H?void 0:H.error);if(ne){M(_t,`RPC '${e}' stream ${i} received error:`,ne);const de=ne.status;let se=function(A){const P=Ye[A];if(void 0!==P)return hh(P)}(de),R=ne.message;void 0===se&&(se=D.INTERNAL,R="Unknown error status: "+de+" with message "+ne.message),V=!0,F.So(new L(se,R)),y.close()}else M(_t,`RPC '${e}' stream ${i} received:`,Z),F.bo(Z)}}),q(u,Di.STAT_EVENT,U=>{U.stat===Ci.PROXY?M(_t,`RPC '${e}' stream ${i} detected buffering proxy`):U.stat===Ci.NOPROXY&&M(_t,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{F.wo()},0),F}}function Ed(){return typeof window<"u"?window:null}function Xo(){return typeof document<"u"?document:null}function hs(r){return new cg(r,!0)}class Bu{constructor(e,t,n=1e3,i=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=n,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();const t=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),i=Math.max(0,t-n);i>0&&M("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){null!==this.$o&&(this.$o.skipDelay(),this.$o=null)}cancel(){null!==this.$o&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}class vd{constructor(e,t,n,i,s,a,u,l){this.ui=e,this.Ho=n,this.Jo=i,this.connection=s,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=u,this.listener=l,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new Bu(e,t)}n_(){return 1===this.state||5===this.state||this.r_()}r_(){return 2===this.state||3===this.state}start(){this.e_=0,4!==this.state?this.auth():this.i_()}stop(){var e=this;return(0,O.A)(function*(){e.n_()&&(yield e.close(0))})()}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&null===this.Zo&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}__(){var e=this;return(0,O.A)(function*(){if(e.r_())return e.close(0)})()}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(e,t){var n=this;return(0,O.A)(function*(){n.u_(),n.c_(),n.t_.cancel(),n.Yo++,4!==e?n.t_.reset():t&&t.code===D.RESOURCE_EXHAUSTED?(Ge(t.toString()),Ge("Using maximum backoff delay to prevent overloading the backend."),n.t_.Wo()):t&&t.code===D.UNAUTHENTICATED&&3!==n.state&&(n.authCredentialsProvider.invalidateToken(),n.appCheckCredentialsProvider.invalidateToken()),null!==n.stream&&(n.l_(),n.stream.close(),n.stream=null),n.state=e,yield n.listener.mo(t)})()}l_(){}auth(){this.state=1;const e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([n,i])=>{this.Yo===t&&this.P_(n,i)},n=>{e(()=>{const i=new L(D.UNKNOWN,"Fetching auth token failed: "+n.message);return this.I_(i)})})}P_(e,t){const n=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{n(()=>this.I_(i))}),this.stream.onMessage(i=>{n(()=>1==++this.e_?this.E_(i):this.onNext(i))})}i_(){var e=this;this.state=5,this.t_.Go((0,O.A)(function*(){e.state=0,e.start()}))}I_(e){return M("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(M("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class rp extends vd{constructor(e,t,n,i,s,a){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,i,a),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();const t=function fg(r,e){let t;if("targetChange"in e){const n="NO_CHANGE"===(d=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===d?1:"REMOVE"===d?2:"CURRENT"===d?3:"RESET"===d?4:$(),i=e.targetChange.targetIds||[],s=function(d,g){return d.useProto3Json?(X(void 0===g||"string"==typeof g),Oe.fromBase64String(g||"")):(X(void 0===g||g instanceof Buffer||g instanceof Uint8Array),Oe.fromUint8Array(g||new Uint8Array))}(r,e.targetChange.resumeToken),a=e.targetChange.cause,u=a&&function(d){const g=void 0===d.code?D.UNKNOWN:hh(d.code);return new L(g,d.message||"")}(a);t=new ph(n,i,s,u||null)}else if("documentChange"in e){const n=e.documentChange,i=an(r,n.document.name),s=He(n.document.updateTime),a=n.document.createTime?He(n.document.createTime):j.min(),u=new nt({mapValue:{fields:n.document.fields}}),l=Ce.newFoundDocument(i,s,a,u);t=new ko(n.targetIds||[],n.removedTargetIds||[],l.key,l)}else if("documentDelete"in e){const n=e.documentDelete,i=an(r,n.document),s=n.readTime?He(n.readTime):j.min(),a=Ce.newNoDocument(i,s);t=new ko([],n.removedTargetIds||[],a.key,a)}else if("documentRemove"in e){const n=e.documentRemove,i=an(r,n.document);t=new ko([],n.removedTargetIds||[],i,null)}else{if(!("filter"in e))return $();{const n=e.filter,{count:i=0,unchangedNames:s}=n,a=new ig(i,s);t=new gh(n.targetId,a)}}var d;return t}(this.serializer,e),n=function(s){if(!("targetChange"in s))return j.min();const a=s.targetChange;return a.targetIds&&a.targetIds.length?j.min():a.readTime?He(a.readTime):j.min()}(e);return this.listener.d_(t,n)}A_(e){const t={};t.database=pu(this.serializer),t.addTarget=function(s,a){let u;const l=a.target;if(u=xt(l)?{documents:Sh(s,l)}:{query:Oo(s,l)._t},u.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){u.resumeToken=Ih(s,a.resumeToken);const d=fu(s,a.expectedCount);null!==d&&(u.expectedCount=d)}else if(a.snapshotVersion.compareTo(j.min())>0){u.readTime=ri(s,a.snapshotVersion.toTimestamp());const d=fu(s,a.expectedCount);null!==d&&(u.expectedCount=d)}return u}(this.serializer,e);const n=function gg(r,e){const t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return $()}}(e.purpose);return null==t?null:{"goog-listen-tags":t}}(0,e);n&&(t.labels=n),this.a_(t)}R_(e){const t={};t.database=pu(this.serializer),t.removeTarget=e,this.a_(t)}}class ip extends vd{constructor(e,t,n,i,s,a){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,i,a),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return X(!!e.streamToken),this.lastStreamToken=e.streamToken,X(!e.writeResults||0===e.writeResults.length),this.listener.f_()}onNext(e){X(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();const t=function mg(r,e){return r&&r.length>0?(X(void 0!==e),r.map(t=>function(i,s){let a=He(i.updateTime?i.updateTime:s);return a.isEqual(j.min())&&(a=He(s)),new tg(a,i.transformResults||[])}(t,e))):[]}(e.writeResults,e.commitTime),n=He(e.commitTime);return this.listener.g_(n,t)}p_(){const e={};e.database=pu(this.serializer),this.a_(e)}m_(e){const t={streamToken:this.lastStreamToken,writes:e.map(n=>rs(this.serializer,n))};this.a_(t)}}class sp extends class{}{constructor(e,t,n,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new L(D.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,n,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Mo(e,gu(t,n),i,s,a)).catch(s=>{throw"FirebaseError"===s.name?(s.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new L(D.UNKNOWN,s.toString())})}Lo(e,t,n,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,u])=>this.connection.Lo(e,gu(t,n),i,a,u,s)).catch(a=>{throw"FirebaseError"===a.name?(a.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new L(D.UNKNOWN,a.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class op{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){0===this.S_&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){"Online"===this.state?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,"Online"===e&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(Ge(t),this.D_=!1):M("OnlineStateTracker",t)}x_(){null!==this.b_&&(this.b_.cancel(),this.b_=null)}}class ap{constructor(e,t,n,i,s){var a=this;this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(u=>{n.enqueueAndForget((0,O.A)(function*(){var l;Jn(a)&&(M("RemoteStore","Restarting streams for network reachability change."),yield(l=(0,O.A)(function*(g){const y=G(g);y.L_.add(4),yield hi(y),y.q_.set("Unknown"),y.L_.delete(4),yield ds(y)}),function d(g){return l.apply(this,arguments)})(a))}))}),this.q_=new op(n,i)}}function ds(r){return qu.apply(this,arguments)}function qu(){return(qu=(0,O.A)(function*(r){if(Jn(r))for(const e of r.B_)yield e(!0)})).apply(this,arguments)}function hi(r){return Gu.apply(this,arguments)}function Gu(){return(Gu=(0,O.A)(function*(r){for(const e of r.B_)yield e(!1)})).apply(this,arguments)}function Jo(r,e){const t=G(r);t.N_.has(e.targetId)||(t.N_.set(e.targetId,e),ju(t)?zu(t):mi(t).r_()&&Ku(t,e))}function di(r,e){const t=G(r),n=mi(t);t.N_.delete(e),n.r_()&&Ad(t,e),0===t.N_.size&&(n.r_()?n.o_():Jn(t)&&t.q_.set("Unknown"))}function Ku(r,e){if(r.Q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(j.min())>0){const t=r.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}mi(r).A_(e)}function Ad(r,e){r.Q_.xe(e),mi(r).R_(e)}function zu(r){r.Q_=new og({getRemoteKeysForTarget:e=>r.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>r.N_.get(e)||null,tt:()=>r.datastore.serializer.databaseId}),mi(r).start(),r.q_.v_()}function ju(r){return Jn(r)&&!mi(r).n_()&&r.N_.size>0}function Jn(r){return 0===G(r).L_.size}function wd(r){r.Q_=void 0}function up(r){return $u.apply(this,arguments)}function $u(){return($u=(0,O.A)(function*(r){r.q_.set("Online")})).apply(this,arguments)}function lp(r){return Qu.apply(this,arguments)}function Qu(){return(Qu=(0,O.A)(function*(r){r.N_.forEach((e,t)=>{Ku(r,e)})})).apply(this,arguments)}function cp(r,e){return Wu.apply(this,arguments)}function Wu(){return(Wu=(0,O.A)(function*(r,e){wd(r),ju(r)?(r.q_.M_(e),zu(r)):r.q_.set("Unknown")})).apply(this,arguments)}function hp(r,e,t){return Hu.apply(this,arguments)}function Hu(){return Hu=(0,O.A)(function*(r,e,t){if(r.q_.set("Online"),e instanceof ph&&2===e.state&&e.cause)try{yield(n=(0,O.A)(function*(s,a){const u=a.cause;for(const l of a.targetIds)s.N_.has(l)&&(yield s.remoteSyncer.rejectListen(l,u),s.N_.delete(l),s.Q_.removeTarget(l))}),function i(s,a){return n.apply(this,arguments)})(r,e)}catch(n){M("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),yield Yo(r,n)}else if(e instanceof ko?r.Q_.Ke(e):e instanceof gh?r.Q_.He(e):r.Q_.We(e),!t.isEqual(j.min()))try{const n=yield dd(r.localStore);t.compareTo(n)>=0&&(yield function(s,a){const u=s.Q_.rt(a);return u.targetChanges.forEach((l,d)=>{if(l.resumeToken.approximateByteSize()>0){const g=s.N_.get(d);g&&s.N_.set(d,g.withResumeToken(l.resumeToken,a))}}),u.targetMismatches.forEach((l,d)=>{const g=s.N_.get(l);if(!g)return;s.N_.set(l,g.withResumeToken(Oe.EMPTY_BYTE_STRING,g.snapshotVersion)),Ad(s,l);const y=new wn(g.target,l,d,g.sequenceNumber);Ku(s,y)}),s.remoteSyncer.applyRemoteEvent(u)}(r,t))}catch(n){M("RemoteStore","Failed to raise snapshot:",n),yield Yo(r,n)}var n}),Hu.apply(this,arguments)}function Yo(r,e,t){return Xu.apply(this,arguments)}function Xu(){return(Xu=(0,O.A)(function*(r,e,t){if(!Yt(e))throw e;r.L_.add(1),yield hi(r),r.q_.set("Offline"),t||(t=()=>dd(r.localStore)),r.asyncQueue.enqueueRetryable((0,O.A)(function*(){M("RemoteStore","Retrying IndexedDB access"),yield t(),r.L_.delete(1),yield ds(r)}))})).apply(this,arguments)}function Rd(r,e){return e().catch(t=>Yo(r,t,e))}function fi(r){return Ju.apply(this,arguments)}function Ju(){return(Ju=(0,O.A)(function*(r){const e=G(r),t=Yn(e);let n=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;dp(e);)try{const i=yield Xg(e.localStore,n);if(null===i){0===e.O_.length&&t.o_();break}n=i.batchId,fp(e,i)}catch(i){yield Yo(e,i)}Pd(e)&&Sd(e)})).apply(this,arguments)}function dp(r){return Jn(r)&&r.O_.length<10}function fp(r,e){r.O_.push(e);const t=Yn(r);t.r_()&&t.V_&&t.m_(e.mutations)}function Pd(r){return Jn(r)&&!Yn(r).n_()&&r.O_.length>0}function Sd(r){Yn(r).start()}function mp(r){return Yu.apply(this,arguments)}function Yu(){return(Yu=(0,O.A)(function*(r){Yn(r).p_()})).apply(this,arguments)}function gp(r){return Zu.apply(this,arguments)}function Zu(){return(Zu=(0,O.A)(function*(r){const e=Yn(r);for(const t of r.O_)e.m_(t.mutations)})).apply(this,arguments)}function pp(r,e,t){return el.apply(this,arguments)}function el(){return(el=(0,O.A)(function*(r,e,t){const n=r.O_.shift(),i=cu.from(n,e,t);yield Rd(r,()=>r.remoteSyncer.applySuccessfulWrite(i)),yield fi(r)})).apply(this,arguments)}function _p(r,e){return tl.apply(this,arguments)}function tl(){return tl=(0,O.A)(function*(r,e){var t;e&&Yn(r).V_&&(yield(t=(0,O.A)(function*(i,s){if(ch(u=s.code)&&u!==D.ABORTED){const a=i.O_.shift();Yn(i).s_(),yield Rd(i,()=>i.remoteSyncer.rejectFailedWrite(a.batchId,s)),yield fi(i)}var u}),function n(i,s){return t.apply(this,arguments)})(r,e)),Pd(r)&&Sd(r)}),tl.apply(this,arguments)}function bd(r,e){return nl.apply(this,arguments)}function nl(){return(nl=(0,O.A)(function*(r,e){const t=G(r);t.asyncQueue.verifyOperationInProgress(),M("RemoteStore","RemoteStore received new credentials");const n=Jn(t);t.L_.add(3),yield hi(t),n&&t.q_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.L_.delete(3),yield ds(t)})).apply(this,arguments)}function rl(r,e){return il.apply(this,arguments)}function il(){return(il=(0,O.A)(function*(r,e){const t=G(r);e?(t.L_.delete(2),yield ds(t)):e||(t.L_.add(2),yield hi(t),t.q_.set("Unknown"))})).apply(this,arguments)}function mi(r){return r.K_||(r.K_=function(t,n,i){const s=G(t);return s.w_(),new rp(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:up.bind(null,r),Ro:lp.bind(null,r),mo:cp.bind(null,r),d_:hp.bind(null,r)}),r.B_.push(function(){var e=(0,O.A)(function*(t){t?(r.K_.s_(),ju(r)?zu(r):r.q_.set("Unknown")):(yield r.K_.stop(),wd(r))});return function(t){return e.apply(this,arguments)}}())),r.K_}function Yn(r){return r.U_||(r.U_=function(t,n,i){const s=G(t);return s.w_(),new ip(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:()=>Promise.resolve(),Ro:mp.bind(null,r),mo:_p.bind(null,r),f_:gp.bind(null,r),g_:pp.bind(null,r)}),r.B_.push(function(){var e=(0,O.A)(function*(t){t?(r.U_.s_(),yield fi(r)):(yield r.U_.stop(),r.O_.length>0&&(M("RemoteStore",`Stopping write stream with ${r.O_.length} pending writes`),r.O_=[]))});return function(t){return e.apply(this,arguments)}}())),r.U_}class sl{constructor(e,t,n,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=i,this.removalCallback=s,this.deferred=new Ke,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,i,s){const a=Date.now()+n,u=new sl(e,t,a,i,s);return u.start(n),u}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new L(D.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function gi(r,e){if(Ge("AsyncQueue",`${e}: ${r}`),Yt(r))return new L(D.UNAVAILABLE,`${e}: ${r}`);throw r}class pi{constructor(e){this.comparator=e?(t,n)=>e(t,n)||K.comparator(t.key,n.key):(t,n)=>K.comparator(t.key,n.key),this.keyedMap=Hi(),this.sortedSet=new Te(this.comparator)}static emptySet(e){return new pi(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof pi)||this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const i=t.getNext().key,s=n.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new pi;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Vd{constructor(){this.W_=new Te(K.comparator)}track(e){const t=e.doc.key,n=this.W_.get(t);n?0!==e.type&&3===n.type?this.W_=this.W_.insert(t,e):3===e.type&&1!==n.type?this.W_=this.W_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.W_=this.W_.remove(t):1===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):$():this.W_=this.W_.insert(t,e)}G_(){const e=[];return this.W_.inorderTraversal((t,n)=>{e.push(n)}),e}}class _i{constructor(e,t,n,i,s,a,u,l,d){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=s,this.fromCache=a,this.syncStateChanged=u,this.excludesMetadataChanges=l,this.hasCachedResults=d}static fromInitialDocuments(e,t,n,i,s){const a=[];return t.forEach(u=>{a.push({type:0,doc:u})}),new _i(e,t,pi.emptySet(t),a,n,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Qi(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==n[i].type||!t[i].doc.isEqual(n[i].doc))return!1;return!0}}class yp{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}}class Tp{constructor(){this.queries=xd(),this.onlineState="Unknown",this.Y_=new Set}terminate(){!function(t,n){const i=G(t),s=i.queries;i.queries=xd(),s.forEach((a,u)=>{for(const l of u.j_)l.onError(n)})}(this,new L(D.ABORTED,"Firestore shutting down"))}}function xd(){return new vn(r=>jc(r),Qi)}function ol(r,e){return al.apply(this,arguments)}function al(){return(al=(0,O.A)(function*(r,e){const t=G(r);let n=3;const i=e.query;let s=t.queries.get(i);s?!s.H_()&&e.J_()&&(n=2):(s=new yp,n=e.J_()?0:1);try{switch(n){case 0:s.z_=yield t.onListen(i,!0);break;case 1:s.z_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(a){const u=gi(a,`Initialization of query '${Yr(e.query)}' failed`);return void e.onError(u)}t.queries.set(i,s),s.j_.push(e),e.Z_(t.onlineState),s.z_&&e.X_(s.z_)&&cl(t)})).apply(this,arguments)}function ul(r,e){return ll.apply(this,arguments)}function ll(){return(ll=(0,O.A)(function*(r,e){const t=G(r),n=e.query;let i=3;const s=t.queries.get(n);if(s){const a=s.j_.indexOf(e);a>=0&&(s.j_.splice(a,1),0===s.j_.length?i=e.J_()?0:1:!s.H_()&&e.J_()&&(i=2))}switch(i){case 0:return t.queries.delete(n),t.onUnlisten(n,!0);case 1:return t.queries.delete(n),t.onUnlisten(n,!1);case 2:return t.onLastRemoteStoreUnlisten(n);default:return}})).apply(this,arguments)}function Ip(r,e){const t=G(r);let n=!1;for(const i of e){const a=t.queries.get(i.query);if(a){for(const u of a.j_)u.X_(i)&&(n=!0);a.z_=i}}n&&cl(t)}function Ep(r,e,t){const n=G(r),i=n.queries.get(e);if(i)for(const s of i.j_)s.onError(t);n.queries.delete(e)}function cl(r){r.Y_.forEach(e=>{e.next()})}var hl,Cd;(Cd=hl||(hl={})).ea="default",Cd.Cache="cache";class dl{constructor(e,t,n){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(e){if(!this.options.includeMetadataChanges){const n=[];for(const i of e.docChanges)3!==i.type&&n.push(i);e=new _i(e.query,e.docs,e.oldDocs,n,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){return!e.fromCache||!this.J_()||(!this.options._a||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ia(e){return e.docChanges.length>0||!!(e.syncStateChanged||this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites)&&!0===this.options.includeMetadataChanges}oa(e){e=_i.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==hl.Cache}}class vp{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}}class Dd{constructor(e){this.serializer=e}Es(e){return an(this.serializer,e)}ds(e){return e.metadata.exists?Ph(this.serializer,e.document,!1):Ce.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return He(e)}}class Ap{constructor(e,t,n){this.ca=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Nd(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;const n=le.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){const t=new Map,n=new Dd(this.serializer);for(const i of e)if(i.metadata.queries){const s=n.Es(i.metadata.name);for(const a of i.metadata.queries){const u=(t.get(a)||ae()).add(s);t.set(a,u)}}return t}complete(){var e=this;return(0,O.A)(function*(){const t=yield function Jg(r,e,t,n){return Nu.apply(this,arguments)}(e.localStore,new Dd(e.serializer),e.documents,e.ca.id),n=e.ha(e.documents);for(const i of e.queries)yield Yg(e.localStore,i,n.get(i.name));return e.progress.taskState="Success",{progress:e.progress,Pa:e.collectionGroups,Ia:t}})()}}function Nd(r){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}}class kd{constructor(e){this.key=e}}class Od{constructor(e){this.key=e}}class Md{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=ae(),this.mutatedKeys=ae(),this.Aa=Qc(e),this.Ra=new pi(this.Aa)}get Va(){return this.Ta}ma(e,t){const n=t?t.fa:new Vd,i=t?t.Ra:this.Ra;let s=t?t.mutatedKeys:this.mutatedKeys,a=i,u=!1;const l="F"===this.query.limitType&&i.size===this.query.limit?i.last():null,d="L"===this.query.limitType&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((g,y)=>{const E=i.get(g),V=Wi(this.query,y)?y:null,F=!!E&&this.mutatedKeys.has(E.key),q=!!V&&(V.hasLocalMutations||this.mutatedKeys.has(V.key)&&V.hasCommittedMutations);let U=!1;E&&V?E.data.isEqual(V.data)?F!==q&&(n.track({type:3,doc:V}),U=!0):this.ga(E,V)||(n.track({type:2,doc:V}),U=!0,(l&&this.Aa(V,l)>0||d&&this.Aa(V,d)<0)&&(u=!0)):!E&&V?(n.track({type:0,doc:V}),U=!0):E&&!V&&(n.track({type:1,doc:E}),U=!0,(l||d)&&(u=!0)),U&&(V?(a=a.add(V),s=q?s.add(g):s.delete(g)):(a=a.delete(g),s=s.delete(g)))}),null!==this.query.limit)for(;a.size>this.query.limit;){const g="F"===this.query.limitType?a.last():a.first();a=a.delete(g.key),s=s.delete(g.key),n.track({type:1,doc:g})}return{Ra:a,fa:n,ns:u,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,i){const s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;const a=e.fa.G_();a.sort((g,y)=>function(V,F){const q=U=>{switch(U){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return $()}};return q(V)-q(F)}(g.type,y.type)||this.Aa(g.doc,y.doc)),this.pa(n),i=null!=i&&i;const u=t&&!i?this.ya():[],l=0===this.da.size&&this.current&&!i?1:0,d=l!==this.Ea;return this.Ea=l,0!==a.length||d?{snapshot:new _i(this.query,e.Ra,s,a,e.mutatedKeys,0===l,d,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:u}:{wa:u}}Z_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new Vd,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(t=>this.Ta=this.Ta.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ta=this.Ta.delete(t)),this.current=e.current)}ya(){if(!this.current)return[];const e=this.da;this.da=ae(),this.Ra.forEach(n=>{this.Sa(n.key)&&(this.da=this.da.add(n.key))});const t=[];return e.forEach(n=>{this.da.has(n)||t.push(new Od(n))}),this.da.forEach(n=>{e.has(n)||t.push(new kd(n))}),t}ba(e){this.Ta=e.Ts,this.da=ae();const t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return _i.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,0===this.Ea,this.hasCachedResults)}}class wp{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Rp{constructor(e){this.key=e,this.va=!1}}class Pp{constructor(e,t,n,i,s,a){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=a,this.Ca={},this.Fa=new vn(u=>jc(u),Qi),this.Ma=new Map,this.xa=new Set,this.Oa=new Te(K.comparator),this.Na=new Map,this.La=new Ru,this.Ba={},this.ka=new Map,this.qa=br.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return!0===this.Qa}}function Sp(r,e){return fl.apply(this,arguments)}function fl(){return(fl=(0,O.A)(function*(r,e,t=!0){const n=Zo(r);let i;const s=n.Fa.get(e);return s?(n.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield Fd(n,e,t,!0),i})).apply(this,arguments)}function bp(r,e){return ml.apply(this,arguments)}function ml(){return(ml=(0,O.A)(function*(r,e){const t=Zo(r);yield Fd(t,e,!0,!1)})).apply(this,arguments)}function Fd(r,e,t,n){return gl.apply(this,arguments)}function gl(){return(gl=(0,O.A)(function*(r,e,t,n){const i=yield li(r.localStore,gt(e)),s=i.targetId,a=t?r.sharedClientState.addLocalQueryTarget(s):"not-current";let u;return n&&(u=yield pl(r,e,s,"current"===a,i.resumeToken)),r.isPrimaryClient&&t&&Jo(r.remoteStore,i),u})).apply(this,arguments)}function pl(r,e,t,n,i){return _l.apply(this,arguments)}function _l(){return _l=(0,O.A)(function*(r,e,t,n,i){r.Ka=(y,E,V)=>{return(F=(0,O.A)(function*(U,H,Z,J){let ne=H.view.ma(Z);ne.ns&&(ne=yield $o(U.localStore,H.query,!1).then(({documents:I})=>H.view.ma(I,ne)));const de=J&&J.targetChanges.get(H.targetId),se=J&&null!=J.targetMismatches.get(H.targetId),R=H.view.applyChanges(ne,U.isPrimaryClient,de,se);return bl(U,H.targetId,R.wa),R.snapshot}),function q(U,H,Z,J){return F.apply(this,arguments)})(r,y,E,V);var F};const s=yield $o(r.localStore,e,!0),a=new Md(e,s.Ts),u=a.ma(s.documents),l=ts.createSynthesizedTargetChangeForCurrentChange(t,n&&"Offline"!==r.onlineState,i),d=a.applyChanges(u,r.isPrimaryClient,l);bl(r,t,d.wa);const g=new wp(e,t,a);return r.Fa.set(e,g),r.Ma.has(t)?r.Ma.get(t).push(e):r.Ma.set(t,[e]),d.snapshot}),_l.apply(this,arguments)}function Vp(r,e,t){return yl.apply(this,arguments)}function yl(){return(yl=(0,O.A)(function*(r,e,t){const n=G(r),i=n.Fa.get(e),s=n.Ma.get(i.targetId);if(s.length>1)return n.Ma.set(i.targetId,s.filter(a=>!Qi(a,e))),void n.Fa.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(i.targetId),n.sharedClientState.isActiveQueryTarget(i.targetId)||(yield ci(n.localStore,i.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(i.targetId),t&&di(n.remoteStore,i.targetId),yi(n,i.targetId)}).catch(Vt))):(yi(n,i.targetId),yield ci(n.localStore,i.targetId,!0))})).apply(this,arguments)}function xp(r,e){return Tl.apply(this,arguments)}function Tl(){return(Tl=(0,O.A)(function*(r,e){const t=G(r),n=t.Fa.get(e),i=t.Ma.get(n.targetId);t.isPrimaryClient&&1===i.length&&(t.sharedClientState.removeLocalQueryTarget(n.targetId),di(t.remoteStore,n.targetId))})).apply(this,arguments)}function Il(){return(Il=(0,O.A)(function*(r,e,t){const n=Ul(r);try{const i=yield function(a,u){const l=G(a),d=Ve.now(),g=u.reduce((V,F)=>V.add(F.key),ae());let y,E;return l.persistence.runTransaction("Locally write mutations","readwrite",V=>{let F=Dt(),q=ae();return l.cs.getEntries(V,g).next(U=>{F=U,F.forEach((H,Z)=>{Z.isValidDocument()||(q=q.add(H))})}).next(()=>l.localDocuments.getOverlayedDocuments(V,F)).next(U=>{y=U;const H=[];for(const Z of u){const J=rg(Z,y.get(Z.key).overlayedDocument);null!=J&&H.push(new An(Z.key,J,Ro(J.value.mapValue),Be.exists(!0)))}return l.mutationQueue.addMutationBatch(V,d,H,u)}).next(U=>{E=U;const H=U.applyToLocalDocumentSet(y,q);return l.documentOverlayCache.saveOverlays(V,U.batchId,H)})}).then(()=>({batchId:E.batchId,changes:Hc(y)}))}(n.localStore,e);n.sharedClientState.addPendingMutation(i.batchId),function(a,u,l){let d=a.Ba[a.currentUser.toKey()];d||(d=new Te(re)),d=d.insert(u,l),a.Ba[a.currentUser.toKey()]=d}(n,i.batchId,t),yield Rn(n,i.changes),yield fi(n.remoteStore)}catch(i){const s=gi(i,"Failed to persist write");t.reject(s)}})).apply(this,arguments)}function Ld(r,e){return El.apply(this,arguments)}function El(){return(El=(0,O.A)(function*(r,e){const t=G(r);try{const n=yield function Hg(r,e){const t=G(r),n=e.snapshotVersion;let i=t.os;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{const a=t.cs.newChangeBuffer({trackRemovals:!0});i=t.os;const u=[];e.targetChanges.forEach((g,y)=>{const E=i.get(y);if(!E)return;u.push(t.Ur.removeMatchingKeys(s,g.removedDocuments,y).next(()=>t.Ur.addMatchingKeys(s,g.addedDocuments,y)));let V=E.withSequenceNumber(s.currentSequenceNumber);var q,U,H;null!==e.targetMismatches.get(y)?V=V.withResumeToken(Oe.EMPTY_BYTE_STRING,j.min()).withLastLimboFreeSnapshotVersion(j.min()):g.resumeToken.approximateByteSize()>0&&(V=V.withResumeToken(g.resumeToken,n)),i=i.insert(y,V),U=V,H=g,(0===(q=E).resumeToken.approximateByteSize()||U.snapshotVersion.toMicroseconds()-q.snapshotVersion.toMicroseconds()>=3e8||H.addedDocuments.size+H.modifiedDocuments.size+H.removedDocuments.size>0)&&u.push(t.Ur.updateTargetData(s,V))});let l=Dt(),d=ae();if(e.documentUpdates.forEach(g=>{e.resolvedLimboDocuments.has(g)&&u.push(t.persistence.referenceDelegate.updateLimboDocument(s,g))}),u.push(fd(s,a,e.documentUpdates).next(g=>{l=g.Ps,d=g.Is})),!n.isEqual(j.min())){const g=t.Ur.getLastRemoteSnapshotVersion(s).next(y=>t.Ur.setTargetsMetadata(s,s.currentSequenceNumber,n));u.push(g)}return b.waitFor(u).next(()=>a.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,l,d)).next(()=>l)}).then(s=>(t.os=i,s))}(t.localStore,e);e.targetChanges.forEach((i,s)=>{const a=t.Na.get(s);a&&(X(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?a.va=!0:i.modifiedDocuments.size>0?X(a.va):i.removedDocuments.size>0&&(X(a.va),a.va=!1))}),yield Rn(t,n,e)}catch(n){yield Vt(n)}})).apply(this,arguments)}function Ud(r,e,t){const n=G(r);if(n.isPrimaryClient&&0===t||!n.isPrimaryClient&&1===t){const i=[];n.Fa.forEach((s,a)=>{const u=a.view.Z_(e);u.snapshot&&i.push(u.snapshot)}),function(a,u){const l=G(a);l.onlineState=u;let d=!1;l.queries.forEach((g,y)=>{for(const E of y.j_)E.Z_(u)&&(d=!0)}),d&&cl(l)}(n.eventManager,e),i.length&&n.Ca.d_(i),n.onlineState=e,n.isPrimaryClient&&n.sharedClientState.setOnlineState(e)}}function Dp(r,e,t){return vl.apply(this,arguments)}function vl(){return(vl=(0,O.A)(function*(r,e,t){const n=G(r);n.sharedClientState.updateQueryState(e,"rejected",t);const i=n.Na.get(e),s=i&&i.key;if(s){let a=new Te(K.comparator);a=a.insert(s,Ce.newNoDocument(s,j.min()));const u=ae().add(s),l=new es(j.min(),new Map,new Te(re),a,u);yield Ld(n,l),n.Oa=n.Oa.remove(s),n.Na.delete(e),Vl(n)}else yield ci(n.localStore,e,!1).then(()=>yi(n,e,t)).catch(Vt)})).apply(this,arguments)}function Np(r,e){return Al.apply(this,arguments)}function Al(){return(Al=(0,O.A)(function*(r,e){const t=G(r),n=e.batch.batchId;try{const i=yield function Wg(r,e){const t=G(r);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",n=>{const i=e.batch.keys(),s=t.cs.newChangeBuffer({trackRemovals:!0});return function(u,l,d,g){const y=d.batch,E=y.keys();let V=b.resolve();return E.forEach(F=>{V=V.next(()=>g.getEntry(l,F)).next(q=>{const U=d.docVersions.get(F);X(null!==U),q.version.compareTo(U)<0&&(y.applyToRemoteDocument(q,d),q.isValidDocument()&&(q.setReadTime(d.commitVersion),g.addEntry(q)))})}),V.next(()=>u.mutationQueue.removeMutationBatch(l,y))}(t,n,e,s).next(()=>s.apply(n)).next(()=>t.mutationQueue.performConsistencyCheck(n)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(n,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(n,function(u){let l=ae();for(let d=0;d<u.mutationResults.length;++d)u.mutationResults[d].transformResults.length>0&&(l=l.add(u.batch.mutations[d].key));return l}(e))).next(()=>t.localDocuments.getDocuments(n,i))})}(t.localStore,e);Sl(t,n,null),Pl(t,n),t.sharedClientState.updateMutationState(n,"acknowledged"),yield Rn(t,i)}catch(i){yield Vt(i)}})).apply(this,arguments)}function kp(r,e,t){return wl.apply(this,arguments)}function wl(){return(wl=(0,O.A)(function*(r,e,t){const n=G(r);try{const i=yield function(a,u){const l=G(a);return l.persistence.runTransaction("Reject batch","readwrite-primary",d=>{let g;return l.mutationQueue.lookupMutationBatch(d,u).next(y=>(X(null!==y),g=y.keys(),l.mutationQueue.removeMutationBatch(d,y))).next(()=>l.mutationQueue.performConsistencyCheck(d)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(d,g,u)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(d,g)).next(()=>l.localDocuments.getDocuments(d,g))})}(n.localStore,e);Sl(n,e,t),Pl(n,e),n.sharedClientState.updateMutationState(e,"rejected",t),yield Rn(n,i)}catch(i){yield Vt(i)}})).apply(this,arguments)}function Rl(){return(Rl=(0,O.A)(function*(r,e){const t=G(r);Jn(t.remoteStore)||M("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const n=yield function(a){const u=G(a);return u.persistence.runTransaction("Get highest unacknowledged batch id","readonly",l=>u.mutationQueue.getHighestUnacknowledgedBatchId(l))}(t.localStore);if(-1===n)return void e.resolve();const i=t.ka.get(n)||[];i.push(e),t.ka.set(n,i)}catch(n){const i=gi(n,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})).apply(this,arguments)}function Pl(r,e){(r.ka.get(e)||[]).forEach(t=>{t.resolve()}),r.ka.delete(e)}function Sl(r,e,t){const n=G(r);let i=n.Ba[n.currentUser.toKey()];if(i){const s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),n.Ba[n.currentUser.toKey()]=i}}function yi(r,e,t=null){r.sharedClientState.removeLocalQueryTarget(e);for(const n of r.Ma.get(e))r.Fa.delete(n),t&&r.Ca.$a(n,t);r.Ma.delete(e),r.isPrimaryClient&&r.La.gr(e).forEach(n=>{r.La.containsKey(n)||Bd(r,n)})}function Bd(r,e){r.xa.delete(e.path.canonicalString());const t=r.Oa.get(e);null!==t&&(di(r.remoteStore,t),r.Oa=r.Oa.remove(e),r.Na.delete(t),Vl(r))}function bl(r,e,t){for(const n of t)n instanceof kd?(r.La.addReference(n.key,e),Mp(r,n)):n instanceof Od?(M("SyncEngine","Document no longer in limbo: "+n.key),r.La.removeReference(n.key,e),r.La.containsKey(n.key)||Bd(r,n.key)):$()}function Mp(r,e){const t=e.key,n=t.path.canonicalString();r.Oa.get(t)||r.xa.has(n)||(M("SyncEngine","New document in limbo: "+t),r.xa.add(n),Vl(r))}function Vl(r){for(;r.xa.size>0&&r.Oa.size<r.maxConcurrentLimboResolutions;){const e=r.xa.values().next().value;r.xa.delete(e);const t=new K(le.fromString(e)),n=r.qa.next();r.Na.set(n,new Rp(t)),r.Oa=r.Oa.insert(t,n),Jo(r.remoteStore,new wn(gt(sn(t.path)),n,"TargetPurposeLimboResolution",Xe.oe))}}function Rn(r,e,t){return xl.apply(this,arguments)}function xl(){return xl=(0,O.A)(function*(r,e,t){const n=G(r),i=[],s=[],a=[];var u;n.Fa.isEmpty()||(n.Fa.forEach((u,l)=>{a.push(n.Ka(l,e,t).then(d=>{var g;if((d||t)&&n.isPrimaryClient){const y=d?!d.fromCache:null===(g=null==t?void 0:t.targetChanges.get(l.targetId))||void 0===g?void 0:g.current;n.sharedClientState.updateQueryState(l.targetId,y?"current":"not-current")}if(d){i.push(d);const y=xu.Wi(l.targetId,d);s.push(y)}}))}),yield Promise.all(a),n.Ca.d_(i),yield(u=(0,O.A)(function*(d,g){const y=G(d);try{yield y.persistence.runTransaction("notifyLocalViewChanges","readwrite",E=>b.forEach(g,V=>b.forEach(V.$i,F=>y.persistence.referenceDelegate.addReference(E,V.targetId,F)).next(()=>b.forEach(V.Ui,F=>y.persistence.referenceDelegate.removeReference(E,V.targetId,F)))))}catch(E){if(!Yt(E))throw E;M("LocalStore","Failed to update sequence numbers: "+E)}for(const E of g){const V=E.targetId;if(!E.fromCache){const F=y.os.get(V),U=F.withLastLimboFreeSnapshotVersion(F.snapshotVersion);y.os=y.os.insert(V,U)}}}),function l(d,g){return u.apply(this,arguments)})(n.localStore,s))}),xl.apply(this,arguments)}function Fp(r,e){return Cl.apply(this,arguments)}function Cl(){return(Cl=(0,O.A)(function*(r,e){const t=G(r);if(!t.currentUser.isEqual(e)){M("SyncEngine","User change. New user:",e.toKey());const n=yield hd(t.localStore,e);t.currentUser=e,(s=t).ka.forEach(u=>{u.forEach(l=>{l.reject(new L(D.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),s.ka.clear(),t.sharedClientState.handleUserChange(e,n.removedBatchIds,n.addedBatchIds),yield Rn(t,n.hs)}var s})).apply(this,arguments)}function Lp(r,e){const t=G(r),n=t.Na.get(e);if(n&&n.va)return ae().add(n.key);{let i=ae();const s=t.Ma.get(e);if(!s)return i;for(const a of s){const u=t.Fa.get(a);i=i.unionWith(u.view.Va)}return i}}function Up(r,e){return Dl.apply(this,arguments)}function Dl(){return(Dl=(0,O.A)(function*(r,e){const t=G(r),n=yield $o(t.localStore,e.query,!0),i=e.view.ba(n);return t.isPrimaryClient&&bl(t,e.targetId,i.wa),i})).apply(this,arguments)}function Bp(r,e){return Nl.apply(this,arguments)}function Nl(){return(Nl=(0,O.A)(function*(r,e){const t=G(r);return gd(t.localStore,e).then(n=>Rn(t,n))})).apply(this,arguments)}function qp(r,e,t,n){return kl.apply(this,arguments)}function kl(){return(kl=(0,O.A)(function*(r,e,t,n){const i=G(r),s=yield function(u,l){const d=G(u),g=G(d.mutationQueue);return d.persistence.runTransaction("Lookup mutation documents","readonly",y=>g.Mn(y,l).next(E=>E?d.localDocuments.getDocuments(y,E):b.resolve(null)))}(i.localStore,e);var l;null!==s?("pending"===t?yield fi(i.remoteStore):"acknowledged"===t||"rejected"===t?(Sl(i,e,n||null),Pl(i,e),l=e,G(G(i.localStore).mutationQueue).On(l)):$(),yield Rn(i,s)):M("SyncEngine","Cannot apply mutation batch with id: "+e)})).apply(this,arguments)}function Ol(){return(Ol=(0,O.A)(function*(r,e){const t=G(r);if(Zo(t),Ul(t),!0===e&&!0!==t.Qa){const n=t.sharedClientState.getAllActiveQueryTargets(),i=yield qd(t,n.toArray());t.Qa=!0,yield rl(t.remoteStore,!0);for(const s of i)Jo(t.remoteStore,s)}else if(!1===e&&!1!==t.Qa){const n=[];let i=Promise.resolve();t.Ma.forEach((s,a)=>{t.sharedClientState.isLocalQueryTarget(a)?n.push(a):i=i.then(()=>(yi(t,a),ci(t.localStore,a,!0))),di(t.remoteStore,a)}),yield i,yield qd(t,n),function(a){const u=G(a);u.Na.forEach((l,d)=>{di(u.remoteStore,d)}),u.La.pr(),u.Na=new Map,u.Oa=new Te(K.comparator)}(t),t.Qa=!1,yield rl(t.remoteStore,!1)}})).apply(this,arguments)}function qd(r,e,t){return Ml.apply(this,arguments)}function Ml(){return(Ml=(0,O.A)(function*(r,e,t){const n=G(r),i=[],s=[];for(const a of e){let u;const l=n.Ma.get(a);if(l&&0!==l.length){u=yield li(n.localStore,gt(l[0]));for(const d of l){const g=n.Fa.get(d),y=yield Up(n,g);y.snapshot&&s.push(y.snapshot)}}else{const d=yield md(n.localStore,a);u=yield li(n.localStore,d),yield pl(n,Gd(d),a,!1,u.resumeToken)}i.push(u)}return n.Ca.d_(s),i})).apply(this,arguments)}function Gd(r){return En(r.path,r.collectionGroup,r.orderBy,r.filters,r.limit,"F",r.startAt,r.endAt)}function Kp(r){return t=G(r).localStore,G(G(t).persistence).Qi();var t}function zp(r,e,t,n){return Fl.apply(this,arguments)}function Fl(){return(Fl=(0,O.A)(function*(r,e,t,n){const i=G(r);if(i.Qa)return void M("SyncEngine","Ignoring unexpected query state notification.");const s=i.Ma.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{const a=yield gd(i.localStore,$c(s[0])),u=es.createSynthesizedRemoteEventForCurrentChange(e,"current"===t,Oe.EMPTY_BYTE_STRING);yield Rn(i,a,u);break}case"rejected":yield ci(i.localStore,e,!0),yi(i,e,n);break;default:$()}})).apply(this,arguments)}function jp(r,e,t){return Ll.apply(this,arguments)}function Ll(){return(Ll=(0,O.A)(function*(r,e,t){const n=Zo(r);if(n.Qa){for(const i of e){if(n.Ma.has(i)&&n.sharedClientState.isActiveQueryTarget(i)){M("SyncEngine","Adding an already active target "+i);continue}const s=yield md(n.localStore,i),a=yield li(n.localStore,s);yield pl(n,Gd(s),a.targetId,!1,a.resumeToken),Jo(n.remoteStore,a)}for(const i of t)n.Ma.has(i)&&(yield ci(n.localStore,i,!1).then(()=>{di(n.remoteStore,i),yi(n,i)}).catch(Vt))}})).apply(this,arguments)}function Zo(r){const e=G(r);return e.remoteStore.remoteSyncer.applyRemoteEvent=Ld.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Lp.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Dp.bind(null,e),e.Ca.d_=Ip.bind(null,e.eventManager),e.Ca.$a=Ep.bind(null,e.eventManager),e}function Ul(r){const e=G(r);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Np.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=kp.bind(null,e),e}class Ti{constructor(){this.synchronizeTabs=!1}initialize(e){var t=this;return(0,O.A)(function*(){t.serializer=hs(e.databaseInfo.databaseId),t.sharedClientState=t.createSharedClientState(e),t.persistence=t.createPersistence(e),yield t.persistence.start(),t.localStore=t.createLocalStore(e),t.gcScheduler=t.createGarbageCollectionScheduler(e,t.localStore),t.indexBackfillerScheduler=t.createIndexBackfillerScheduler(e,t.localStore)})()}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return cd(this.persistence,new ld,e.initialUser,this.serializer)}createPersistence(e){return new Pu(Ko.Zr,this.serializer)}createSharedClientState(e){return new Td}terminate(){var e=this;return(0,O.A)(function*(){var t,n;null===(t=e.gcScheduler)||void 0===t||t.stop(),null===(n=e.indexBackfillerScheduler)||void 0===n||n.stop(),e.sharedClientState.shutdown(),yield e.persistence.shutdown()})()}}class Bl extends Ti{constructor(e,t,n){super(),this.Wa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}initialize(e){var t=()=>super.initialize,n=this;return(0,O.A)(function*(){yield t().call(n,e),yield n.Wa.initialize(n,e),yield Ul(n.Wa.syncEngine),yield fi(n.Wa.remoteStore),yield n.persistence.yi(()=>(n.gcScheduler&&!n.gcScheduler.started&&n.gcScheduler.start(),n.indexBackfillerScheduler&&!n.indexBackfillerScheduler.started&&n.indexBackfillerScheduler.start(),Promise.resolve()))})()}createLocalStore(e){return cd(this.persistence,new ld,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){return new ed(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new za(t,this.persistence);return new Ka(e.asyncQueue,n)}createPersistence(e){const t=Vu(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?pt.withCacheSize(this.cacheSizeBytes):pt.DEFAULT;return new bu(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Ed(),Xo(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Td}}class Kd extends Bl{constructor(e,t){super(e,t,!1),this.Wa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){var t=()=>super.initialize,n=this;return(0,O.A)(function*(){yield t().call(n,e);const i=n.Wa.syncEngine;n.sharedClientState instanceof Lu&&(n.sharedClientState.syncEngine={no:qp.bind(null,i),ro:zp.bind(null,i),io:jp.bind(null,i),Qi:Kp.bind(null,i),eo:Bp.bind(null,i)},yield n.sharedClientState.start()),yield n.persistence.yi(function(){var s=(0,O.A)(function*(a){yield function Gp(r,e){return Ol.apply(this,arguments)}(n.Wa.syncEngine,a),n.gcScheduler&&(a&&!n.gcScheduler.started?n.gcScheduler.start():a||n.gcScheduler.stop()),n.indexBackfillerScheduler&&(a&&!n.indexBackfillerScheduler.started?n.indexBackfillerScheduler.start():a||n.indexBackfillerScheduler.stop())});return function(a){return s.apply(this,arguments)}}())})()}createSharedClientState(e){const t=Ed();if(!Lu.D(t))throw new L(D.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Vu(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Lu(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Ii{initialize(e,t){var n=this;return(0,O.A)(function*(){n.localStore||(n.localStore=e.localStore,n.sharedClientState=e.sharedClientState,n.datastore=n.createDatastore(t),n.remoteStore=n.createRemoteStore(t),n.eventManager=n.createEventManager(t),n.syncEngine=n.createSyncEngine(t,!e.synchronizeTabs),n.sharedClientState.onlineStateHandler=i=>Ud(n.syncEngine,i,1),n.remoteStore.remoteSyncer.handleCredentialChange=Fp.bind(null,n.syncEngine),yield rl(n.remoteStore,n.syncEngine.isPrimaryClient))})()}createEventManager(e){return new Tp}createDatastore(e){const t=hs(e.databaseInfo.databaseId),n=new np(e.databaseInfo);return new sp(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return n=this.localStore,i=this.datastore,s=e.asyncQueue,a=t=>Ud(this.syncEngine,t,0),u=Id.D()?new Id:new Zg,new ap(n,i,s,a,u);var n,i,s,a,u}createSyncEngine(e,t){return function(i,s,a,u,l,d,g){const y=new Pp(i,s,a,u,l,d);return g&&(y.Qa=!0),y}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){var e=this;return(0,O.A)(function*(){var t,n,i;yield(i=(0,O.A)(function*(a){const u=G(a);M("RemoteStore","RemoteStore shutting down."),u.L_.add(5),yield hi(u),u.k_.shutdown(),u.q_.set("Unknown")}),function s(a){return i.apply(this,arguments)})(e.remoteStore),null===(t=e.datastore)||void 0===t||t.terminate(),null===(n=e.eventManager)||void 0===n||n.terminate()})()}}function zd(r,e=10240){let t=0;return{read:()=>(0,O.A)(function*(){if(t<r.byteLength){const n={value:r.slice(t,t+e),done:!1};return t+=e,n}return{done:!0}})(),cancel:()=>(0,O.A)(function*(){})(),releaseLock(){},closed:Promise.resolve()}}class ea{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ga(this.observer.next,e)}error(e){this.observer.error?this.Ga(this.observer.error,e):Ge("Uncaught Error in snapshot listener:",e.toString())}za(){this.muted=!0}Ga(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Wp{constructor(e,t){this.ja=e,this.serializer=t,this.metadata=new Ke,this.buffer=new Uint8Array,this.Ha=new TextDecoder("utf-8"),this.Ja().then(n=>{n&&n.ua()?this.metadata.resolve(n.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==n?void 0:n.aa)}`))},n=>this.metadata.reject(n))}close(){return this.ja.cancel()}getMetadata(){var e=this;return(0,O.A)(function*(){return e.metadata.promise})()}Ua(){var e=this;return(0,O.A)(function*(){return yield e.getMetadata(),e.Ja()})()}Ja(){var e=this;return(0,O.A)(function*(){const t=yield e.Ya();if(null===t)return null;const n=e.Ha.decode(t),i=Number(n);isNaN(i)&&e.Za(`length string (${n}) is not valid number`);const s=yield e.Xa(i);return new vp(JSON.parse(s),t.length+i)})()}eu(){return this.buffer.findIndex(e=>123===e)}Ya(){var e=this;return(0,O.A)(function*(){for(;e.eu()<0&&!(yield e.tu()););if(0===e.buffer.length)return null;const t=e.eu();t<0&&e.Za("Reached the end of bundle when a length string is expected.");const n=e.buffer.slice(0,t);return e.buffer=e.buffer.slice(t),n})()}Xa(e){var t=this;return(0,O.A)(function*(){for(;t.buffer.length<e;)(yield t.tu())&&t.Za("Reached the end of bundle when more is expected.");const n=t.Ha.decode(t.buffer.slice(0,e));return t.buffer=t.buffer.slice(e),n})()}Za(e){throw this.ja.cancel(),new Error(`Invalid bundle format: ${e}`)}tu(){var e=this;return(0,O.A)(function*(){const t=yield e.ja.read();if(!t.done){const n=new Uint8Array(e.buffer.length+t.value.length);n.set(e.buffer),n.set(t.value,e.buffer.length),e.buffer=n}return t.done})()}}class Hp{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){var t=this;return(0,O.A)(function*(){if(t.ensureCommitNotCalled(),t.mutations.length>0)throw t.lastTransactionError=new L(D.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),t.lastTransactionError;const n=yield(i=(0,O.A)(function*(a,u){const l=G(a),d={documents:u.map(V=>ns(l.serializer,V))},g=yield l.Lo("BatchGetDocuments",l.serializer.databaseId,le.emptyPath(),d,u.length),y=new Map;g.forEach(V=>{const F=function dg(r,e){return"found"in e?function(n,i){X(!!i.found);const s=an(n,i.found.name),a=He(i.found.updateTime),u=i.found.createTime?He(i.found.createTime):j.min(),l=new nt({mapValue:{fields:i.found.fields}});return Ce.newFoundDocument(s,a,u,l)}(r,e):"missing"in e?function(n,i){X(!!i.missing),X(!!i.readTime);const s=an(n,i.missing),a=He(i.readTime);return Ce.newNoDocument(s,a)}(r,e):$()}(l.serializer,V);y.set(F.key.toString(),F)});const E=[];return u.forEach(V=>{const F=y.get(V.toString());X(!!F),E.push(F)}),E}),function s(a,u){return i.apply(this,arguments)})(t.datastore,e);var i;return n.forEach(i=>t.recordVersion(i)),n})()}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(n){this.lastTransactionError=n}this.writtenDocs.add(e.toString())}delete(e){this.write(new ni(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){var e=this;return(0,O.A)(function*(){if(e.ensureCommitNotCalled(),e.lastTransactionError)throw e.lastTransactionError;const t=e.readVersions;var n;e.mutations.forEach(n=>{t.delete(n.key.toString())}),t.forEach((n,i)=>{const s=K.fromPath(i);e.mutations.push(new uu(s,e.precondition(s)))}),yield(n=(0,O.A)(function*(s,a){const u=G(s),l={writes:a.map(d=>rs(u.serializer,d))};yield u.Mo("Commit",u.serializer.databaseId,le.emptyPath(),l)}),function i(s,a){return n.apply(this,arguments)})(e.datastore,e.mutations),e.committed=!0})()}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw $();t=j.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new L(D.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(j.min())?Be.exists(!1):Be.updateTime(t):Be.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(j.min()))throw new L(D.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Be.updateTime(t)}return Be.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Xp{constructor(e,t,n,i,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=i,this.deferred=s,this.nu=n.maxAttempts,this.t_=new Bu(this.asyncQueue,"transaction_retry")}ru(){this.nu-=1,this.iu()}iu(){var e=this;this.t_.Go((0,O.A)(function*(){const t=new Hp(e.datastore),n=e.su(t);n&&n.then(i=>{e.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{e.deferred.resolve(i)}).catch(s=>{e.ou(s)}))}).catch(i=>{e.ou(i)})}))}su(e){try{const t=this.updateFunction(e);return!Xt(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}ou(e){this.nu>0&&this._u(e)?(this.nu-=1,this.asyncQueue.enqueueAndForget(()=>(this.iu(),Promise.resolve()))):this.deferred.reject(e)}_u(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!ch(t)}return!1}}class Jp{constructor(e,t,n,i){var s=this;this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=i,this.user=ke.UNAUTHENTICATED,this.clientId=Ys.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,function(){var a=(0,O.A)(function*(u){M("FirestoreClient","Received user=",u.uid),yield s.authCredentialListener(u),s.user=u});return function(u){return a.apply(this,arguments)}}()),this.appCheckCredentials.start(n,a=>(M("FirestoreClient","Received new app check token=",a),this.appCheckCredentialListener(a,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new L(D.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){var e=this;this.asyncQueue.enterRestrictedMode();const t=new Ke;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((0,O.A)(function*(){try{e._onlineComponents&&(yield e._onlineComponents.terminate()),e._offlineComponents&&(yield e._offlineComponents.terminate()),e.authCredentials.shutdown(),e.appCheckCredentials.shutdown(),t.resolve()}catch(n){const i=gi(n,"Failed to shutdown persistence");t.reject(i)}})),t.promise}}function ta(r,e){return ql.apply(this,arguments)}function ql(){return ql=(0,O.A)(function*(r,e){r.asyncQueue.verifyOperationInProgress(),M("FirestoreClient","Initializing OfflineComponentProvider");const t=r.configuration;yield e.initialize(t);let n=t.initialUser;r.setCredentialChangeListener(function(){var i=(0,O.A)(function*(s){n.isEqual(s)||(yield hd(e.localStore,s),n=s)});return function(s){return i.apply(this,arguments)}}()),e.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=e}),ql.apply(this,arguments)}function Gl(r,e){return Kl.apply(this,arguments)}function Kl(){return(Kl=(0,O.A)(function*(r,e){r.asyncQueue.verifyOperationInProgress();const t=yield zl(r);M("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,r.configuration),r.setCredentialChangeListener(n=>bd(e.remoteStore,n)),r.setAppCheckTokenChangeListener((n,i)=>bd(e.remoteStore,i)),r._onlineComponents=e})).apply(this,arguments)}function jd(r){return"FirebaseError"===r.name?r.code===D.FAILED_PRECONDITION||r.code===D.UNIMPLEMENTED:!(typeof DOMException<"u"&&r instanceof DOMException)||22===r.code||20===r.code||11===r.code}function zl(r){return jl.apply(this,arguments)}function jl(){return(jl=(0,O.A)(function*(r){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){M("FirestoreClient","Using user provided OfflineComponentProvider");try{yield ta(r,r._uninitializedComponentsProvider._offline)}catch(e){const t=e;if(!jd(t))throw t;ft("Error using user provided cache. Falling back to memory cache: "+t),yield ta(r,new Ti)}}else M("FirestoreClient","Using default OfflineComponentProvider"),yield ta(r,new Ti);return r._offlineComponents})).apply(this,arguments)}function na(r){return $l.apply(this,arguments)}function $l(){return($l=(0,O.A)(function*(r){return r._onlineComponents||(r._uninitializedComponentsProvider?(M("FirestoreClient","Using user provided OnlineComponentProvider"),yield Gl(r,r._uninitializedComponentsProvider._online)):(M("FirestoreClient","Using default OnlineComponentProvider"),yield Gl(r,new Ii))),r._onlineComponents})).apply(this,arguments)}function $d(r){return zl(r).then(e=>e.persistence)}function Ei(r){return zl(r).then(e=>e.localStore)}function Qd(r){return na(r).then(e=>e.remoteStore)}function Ql(r){return na(r).then(e=>e.syncEngine)}function vi(r){return Wl.apply(this,arguments)}function Wl(){return(Wl=(0,O.A)(function*(r){const e=yield na(r),t=e.eventManager;return t.onListen=Sp.bind(null,e.syncEngine),t.onUnlisten=Vp.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=bp.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=xp.bind(null,e.syncEngine),t})).apply(this,arguments)}function Hd(r,e,t={}){const n=new Ke;return r.asyncQueue.enqueueAndForget((0,O.A)(function*(){return function(s,a,u,l,d){const g=new ea({next:E=>{a.enqueueAndForget(()=>ul(s,y));const V=E.docs.has(u);!V&&E.fromCache?d.reject(new L(D.UNAVAILABLE,"Failed to get document because the client is offline.")):V&&E.fromCache&&l&&"server"===l.source?d.reject(new L(D.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):d.resolve(E)},error:E=>d.reject(E)}),y=new dl(sn(u.path),g,{includeMetadataChanges:!0,_a:!0});return ol(s,y)}(yield vi(r),r.asyncQueue,e,t,n)})),n.promise}function Xd(r,e,t={}){const n=new Ke;return r.asyncQueue.enqueueAndForget((0,O.A)(function*(){return function(s,a,u,l,d){const g=new ea({next:E=>{a.enqueueAndForget(()=>ul(s,y)),E.fromCache&&"server"===l.source?d.reject(new L(D.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):d.resolve(E)},error:E=>d.reject(E)}),y=new dl(u,g,{includeMetadataChanges:!0,_a:!0});return ol(s,y)}(yield vi(r),r.asyncQueue,e,t,n)})),n.promise}function Jd(r){const e={};return void 0!==r.timeoutSeconds&&(e.timeoutSeconds=r.timeoutSeconds),e}const Yd=new Map;function Hl(r,e,t){if(!t)throw new L(D.INVALID_ARGUMENT,`Function ${r}() cannot be called with an empty ${e}.`)}function Zd(r,e,t,n){if(!0===e&&!0===n)throw new L(D.INVALID_ARGUMENT,`${r} and ${t} cannot be used together.`)}function ef(r){if(!K.isDocumentKey(r))throw new L(D.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${r} has ${r.length}.`)}function tf(r){if(K.isDocumentKey(r))throw new L(D.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${r} has ${r.length}.`)}function ra(r){if(void 0===r)return"undefined";if(null===r)return"null";if("string"==typeof r)return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if("number"==typeof r||"boolean"==typeof r)return""+r;if("object"==typeof r){if(r instanceof Array)return"an array";{const e=(n=r).constructor?n.constructor.name:null;return e?`a custom ${e} object`:"an object"}}var n;return"function"==typeof r?"a function":$()}function ce(r,e){if("_delegate"in r&&(r=r._delegate),!(r instanceof e)){if(e.name===r.constructor.name)throw new L(D.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const t=ra(r);throw new L(D.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return r}function nf(r,e){if(e<=0)throw new L(D.INVALID_ARGUMENT,`Function ${r}() requires a positive number, but it was: ${e}.`)}class rf{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new L(D.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new L(D.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Zd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!(this.experimentalForceLongPolling||void 0!==e.experimentalAutoDetectLongPolling&&!e.experimentalAutoDetectLongPolling),this.experimentalLongPollingOptions=Jd(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(s){if(void 0!==s.timeoutSeconds){if(isNaN(s.timeoutSeconds))throw new L(D.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new L(D.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new L(D.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.experimentalLongPollingOptions.timeoutSeconds===e.experimentalLongPollingOptions.timeoutSeconds&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class fs{constructor(e,t,n,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new rf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new L(D.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new L(D.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new rf(e),void 0!==e.credentials&&(this._authCredentials=function(n){if(!n)return new Hs;switch(n.type){case"firstParty":return new jr(n.sessionIndex||"0",n.iamToken||null,n.authTokenFactory||null);case"provider":return n.client;default:throw new L(D.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const n=Yd.get(t);n&&(M("ComponentProvider","Removing Datastore"),Yd.delete(t),n.terminate())}(this),Promise.resolve()}}class lt{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lt(this.firestore,e,this._query)}}class Me{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new un(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Me(this.firestore,e,this._key)}}class un extends lt{constructor(e,t,n){super(e,t,sn(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Me(this.firestore,null,new K(e))}withConverter(e){return new un(this.firestore,e,this._path)}}function af(r,e,...t){if(r=(0,ee.Ku)(r),Hl("collection","path",e),r instanceof fs){const n=le.fromString(e,...t);return tf(n),new un(r,null,n)}{if(!(r instanceof Me||r instanceof un))throw new L(D.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=r._path.child(le.fromString(e,...t));return tf(n),new un(r.firestore,null,n)}}function ia(r,e,...t){if(r=(0,ee.Ku)(r),1===arguments.length&&(e=Ys.newId()),Hl("doc","path",e),r instanceof fs){const n=le.fromString(e,...t);return ef(n),new Me(r,null,new K(n))}{if(!(r instanceof Me||r instanceof un))throw new L(D.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=r._path.child(le.fromString(e,...t));return ef(n),new Me(r.firestore,r instanceof un?r.converter:null,new K(n))}}function uf(r,e){return r=(0,ee.Ku)(r),e=(0,ee.Ku)(e),(r instanceof Me||r instanceof un)&&(e instanceof Me||e instanceof un)&&r.firestore===e.firestore&&r.path===e.path&&r.converter===e.converter}function Xl(r,e){return r=(0,ee.Ku)(r),e=(0,ee.Ku)(e),r instanceof lt&&e instanceof lt&&r.firestore===e.firestore&&Qi(r._query,e._query)&&r.converter===e.converter}class c_{constructor(){this.au=Promise.resolve(),this.uu=[],this.cu=!1,this.lu=[],this.hu=null,this.Pu=!1,this.Iu=!1,this.Tu=[],this.t_=new Bu(this,"async_queue_retry"),this.Eu=()=>{const t=Xo();t&&M("AsyncQueue","Visibility state changed to "+t.visibilityState),this.t_.jo()};const e=Xo();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Eu)}get isShuttingDown(){return this.cu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.du(),this.Au(e)}enterRestrictedMode(e){if(!this.cu){this.cu=!0,this.Iu=e||!1;const t=Xo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Eu)}}enqueue(e){if(this.du(),this.cu)return new Promise(()=>{});const t=new Ke;return this.Au(()=>this.cu&&this.Iu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.uu.push(e),this.Ru()))}Ru(){var e=this;return(0,O.A)(function*(){if(0!==e.uu.length){try{yield e.uu[0](),e.uu.shift(),e.t_.reset()}catch(t){if(!Yt(t))throw t;M("AsyncQueue","Operation failed with retryable error: "+t)}e.uu.length>0&&e.t_.Go(()=>e.Ru())}})()}Au(e){const t=this.au.then(()=>(this.Pu=!0,e().catch(n=>{throw this.hu=n,this.Pu=!1,Ge("INTERNAL UNHANDLED ERROR: ",function(a){let u=a.message||"";return a.stack&&(u=a.stack.includes(a.message)?a.stack:a.message+"\n"+a.stack),u}(n)),n}).then(n=>(this.Pu=!1,n))));return this.au=t,t}enqueueAfterDelay(e,t,n){this.du(),this.Tu.indexOf(e)>-1&&(t=0);const i=sl.createAndSchedule(this,e,t,n,s=>this.Vu(s));return this.lu.push(i),i}du(){this.hu&&$()}verifyOperationInProgress(){}mu(){var e=this;return(0,O.A)(function*(){let t;do{t=e.au,yield t}while(t!==e.au)})()}fu(e){for(const t of this.lu)if(t.timerId===e)return!0;return!1}gu(e){return this.mu().then(()=>{this.lu.sort((t,n)=>t.targetTimeMs-n.targetTimeMs);for(const t of this.lu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.mu()})}pu(e){this.Tu.push(e)}Vu(e){const t=this.lu.indexOf(e);this.lu.splice(t,1)}}function Jl(r){return function(t){if("object"!=typeof t||null===t)return!1;const i=t;for(const s of["next","error","complete"])if(s in i&&"function"==typeof i[s])return!0;return!1}(r)}class h_{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ke,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class we extends fs{constructor(e,t,n,i){super(e,t,n,i),this.type="firestore",this._queue=new c_,this._persistenceKey=(null==i?void 0:i.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||lf(this),this._firestoreClient.terminate()}}function qe(r){return r._firestoreClient||lf(r),r._firestoreClient.verifyNotTerminated(),r._firestoreClient}function lf(r){var e,t,n;const i=r._freezeSettings(),s=(l=(null===(e=r._app)||void 0===e?void 0:e.options.appId)||"",new Gc(r._databaseId,l,r._persistenceKey,(g=i).host,g.ssl,g.experimentalForceLongPolling,g.experimentalAutoDetectLongPolling,Jd(g.experimentalLongPollingOptions),g.useFetchStreams));var l,g;r._firestoreClient=new Jp(r._authCredentials,r._appCheckCredentials,r._queue,s),null!==(t=i.localCache)&&void 0!==t&&t._offlineComponentProvider&&null!==(n=i.localCache)&&void 0!==n&&n._onlineComponentProvider&&(r._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function cf(r,e,t){const n=new Ke;return r.asyncQueue.enqueue((0,O.A)(function*(){try{yield ta(r,t),yield Gl(r,e),n.resolve()}catch(i){const s=i;if(!jd(s))throw s;ft("Error enabling indexeddb cache. Falling back to memory cache: "+s),n.reject(s)}})).then(()=>n.promise)}function hf(r){if(r._initialized||r._terminated)throw new L(D.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class ln{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ln(Oe.fromBase64String(e))}catch(t){throw new L(D.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new ln(Oe.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Pn{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new L(D.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Pe(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class xr{constructor(e){this._methodName=e}}class sa{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new L(D.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new L(D.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return re(this._lat,e._lat)||re(this._long,e._long)}}class oa{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(n,i){if(n.length!==i.length)return!1;for(let s=0;s<n.length;++s)if(n[s]!==i[s])return!1;return!0}(this._values,e._values)}}const v_=/^__.*__$/;class A_{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new An(e,this.data,this.fieldMask,t,this.fieldTransforms):new ti(e,this.data,t,this.fieldTransforms)}}class df{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new An(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function ff(r){switch(r){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw $()}}class aa{constructor(e,t,n,i,s,a){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=i,void 0===s&&this.yu(),this.fieldTransforms=s||[],this.fieldMask=a||[]}get path(){return this.settings.path}get wu(){return this.settings.wu}Su(e){return new aa(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}bu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.Su({path:n,Du:!1});return i.vu(e),i}Cu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.Su({path:n,Du:!1});return i.yu(),i}Fu(e){return this.Su({path:void 0,Du:!0})}Mu(e){return ca(e,this.settings.methodName,this.settings.xu||!1,this.path,this.settings.Ou)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}yu(){if(this.path)for(let e=0;e<this.path.length;e++)this.vu(this.path.get(e))}vu(e){if(0===e.length)throw this.Mu("Document fields must not be empty");if(ff(this.wu)&&v_.test(e))throw this.Mu('Document fields cannot begin and end with "__"')}}class w_{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||hs(e)}Nu(e,t,n,i=!1){return new aa({wu:e,methodName:t,Ou:n,path:Pe.emptyPath(),Du:!1,xu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Cr(r){const e=r._freezeSettings(),t=hs(r._databaseId);return new w_(r._databaseId,!!e.ignoreUndefinedProperties,t)}function ua(r,e,t,n,i,s={}){const a=r.Nu(s.merge||s.mergeFields?2:0,e,t,i);ic("Data must be an object, but it was:",a,n);const u=pf(n,a);let l,d;if(s.merge)l=new ut(a.fieldMask),d=a.fieldTransforms;else if(s.mergeFields){const g=[];for(const y of s.mergeFields){const E=ps(e,y,t);if(!a.contains(E))throw new L(D.INVALID_ARGUMENT,`Field '${E}' is specified in your field mask but missing from your input data.`);yf(g,E)||g.push(E)}l=new ut(g),d=a.fieldTransforms.filter(y=>l.covers(y.field))}else l=null,d=a.fieldTransforms;return new A_(new nt(u),l,d)}class gs extends xr{_toFieldTransform(e){if(2!==e.wu)throw e.Mu(1===e.wu?`${this._methodName}() can only appear at the top level of your update data`:`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof gs}}function mf(r,e,t){return new aa({wu:3,Ou:e.settings.Ou,methodName:r._methodName,Du:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class Yl extends xr{_toFieldTransform(e){return new Ji(e.path,new Zr)}isEqual(e){return e instanceof Yl}}class Zl extends xr{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){const t=mf(this,e,!0),n=this.Lu.map(s=>Dr(s,t)),i=new Er(n);return new Ji(e.path,i)}isEqual(e){return e instanceof Zl&&(0,ee.bD)(this.Lu,e.Lu)}}class ec extends xr{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){const t=mf(this,e,!0),n=this.Lu.map(s=>Dr(s,t)),i=new vr(n);return new Ji(e.path,i)}isEqual(e){return e instanceof ec&&(0,ee.bD)(this.Lu,e.Lu)}}class tc extends xr{constructor(e,t){super(e),this.Bu=t}_toFieldTransform(e){const t=new ei(e.serializer,Yc(e.serializer,this.Bu));return new Ji(e.path,t)}isEqual(e){return e instanceof tc&&this.Bu===e.Bu}}function nc(r,e,t,n){const i=r.Nu(1,e,t);ic("Data must be an object, but it was:",i,n);const s=[],a=nt.empty();Zt(n,(l,d)=>{const g=la(e,l,t);d=(0,ee.Ku)(d);const y=i.Cu(g);if(d instanceof gs)s.push(g);else{const E=Dr(d,y);null!=E&&(s.push(g),a.set(g,E))}});const u=new ut(s);return new df(a,u,i.fieldTransforms)}function rc(r,e,t,n,i,s){const a=r.Nu(1,e,t),u=[ps(e,n,t)],l=[i];if(s.length%2!=0)throw new L(D.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let E=0;E<s.length;E+=2)u.push(ps(e,s[E])),l.push(s[E+1]);const d=[],g=nt.empty();for(let E=u.length-1;E>=0;--E)if(!yf(d,u[E])){const V=u[E];let F=l[E];F=(0,ee.Ku)(F);const q=a.Cu(V);if(F instanceof gs)d.push(V);else{const U=Dr(F,q);null!=U&&(d.push(V),g.set(V,U))}}const y=new ut(d);return new df(g,y,a.fieldTransforms)}function gf(r,e,t,n=!1){return Dr(t,r.Nu(n?4:3,e))}function Dr(r,e){if(_f(r=(0,ee.Ku)(r)))return ic("Unsupported field value:",e,r),pf(r,e);if(r instanceof xr)return function(n,i){if(!ff(i.wu))throw i.Mu(`${n._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Mu(`${n._methodName}() is not currently supported inside arrays`);const s=n._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(r,e),null;if(void 0===r&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),r instanceof Array){if(e.settings.Du&&4!==e.wu)throw e.Mu("Nested arrays are not supported");return function(n,i){const s=[];let a=0;for(const u of n){let l=Dr(u,i.Fu(a));null==l&&(l={nullValue:"NULL_VALUE"}),s.push(l),a++}return{arrayValue:{values:s}}}(r,e)}return function(n,i){if(null===(n=(0,ee.Ku)(n)))return{nullValue:"NULL_VALUE"};if("number"==typeof n)return Yc(i.serializer,n);if("boolean"==typeof n)return{booleanValue:n};if("string"==typeof n)return{stringValue:n};if(n instanceof Date){const s=Ve.fromDate(n);return{timestampValue:ri(i.serializer,s)}}if(n instanceof Ve){const s=new Ve(n.seconds,1e3*Math.floor(n.nanoseconds/1e3));return{timestampValue:ri(i.serializer,s)}}if(n instanceof sa)return{geoPointValue:{latitude:n.latitude,longitude:n.longitude}};if(n instanceof ln)return{bytesValue:Ih(i.serializer,n._byteString)};if(n instanceof Me){const s=i.databaseId,a=n.firestore._databaseId;if(!a.isEqual(s))throw i.Mu(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:mu(n.firestore._databaseId||i.databaseId,n._key.path)}}if(n instanceof oa)return u=i,{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:n.toArray().map(l=>{if("number"!=typeof l)throw u.Mu("VectorValues must only contain numeric values.");return au(u.serializer,l)})}}}}};var u;throw i.Mu(`Unsupported field value: ${ra(n)}`)}(r,e)}function pf(r,e){const t={};return Gi(r)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Zt(r,(n,i)=>{const s=Dr(i,e.bu(n));null!=s&&(t[n]=s)}),{mapValue:{fields:t}}}function _f(r){return!("object"!=typeof r||null===r||r instanceof Array||r instanceof Date||r instanceof Ve||r instanceof sa||r instanceof ln||r instanceof Me||r instanceof xr||r instanceof oa)}function ic(r,e,t){if(!_f(t)||"object"!=typeof(i=t)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i)){const n=ra(t);throw e.Mu("an object"===n?r+" a custom object":r+" "+n)}var i}function ps(r,e,t){if((e=(0,ee.Ku)(e))instanceof Pn)return e._internalPath;if("string"==typeof e)return la(r,e);throw ca("Field path arguments must be of type string or ",r,!1,void 0,t)}const R_=new RegExp("[~\\*/\\[\\]]");function la(r,e,t){if(e.search(R_)>=0)throw ca(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,r,!1,void 0,t);try{return new Pn(...e.split("."))._internalPath}catch{throw ca(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,r,!1,void 0,t)}}function ca(r,e,t,n,i){const s=n&&!n.isEmpty(),a=void 0!==i;let u=`Function ${e}() called with invalid data`;t&&(u+=" (via `toFirestore()`)"),u+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new L(D.INVALID_ARGUMENT,u+r+l)}function yf(r,e){return r.some(t=>t.isEqual(e))}class _s{constructor(e,t,n,i,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Me(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new P_(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(ha("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class P_ extends _s{data(){return super.data()}}function ha(r,e){return"string"==typeof e?la(r,e):e instanceof Pn?e._internalPath:e._delegate._internalPath}function Tf(r){if("L"===r.limitType&&0===r.explicitOrderBy.length)throw new L(D.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class sc{}class ys extends sc{}function Zn(r,e,...t){let n=[];e instanceof sc&&n.push(e),n=n.concat(t),function(s){const a=s.filter(l=>l instanceof Ai).length,u=s.filter(l=>l instanceof Ts).length;if(a>1||a>0&&u>0)throw new L(D.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(const i of n)r=i._apply(r);return r}class Ts extends ys{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Ts(e,t,n)}_apply(e){const t=this._parse(e);return Af(e._query,t),new lt(e.firestore,e.converter,su(e._query,t))}_parse(e){const t=Cr(e.firestore);return function(s,a,u,l,d,g,y){let E;if(d.isKeyField()){if("array-contains"===g||"array-contains-any"===g)throw new L(D.INVALID_ARGUMENT,`Invalid Query. You can't perform '${g}' queries on documentId().`);if("in"===g||"not-in"===g){vf(y,g);const V=[];for(const F of y)V.push(Ef(l,s,F));E={arrayValue:{values:V}}}else E=Ef(l,s,y)}else"in"!==g&&"not-in"!==g&&"array-contains-any"!==g||vf(y,g),E=gf(u,"where",y,"in"===g||"not-in"===g);return he.create(d,g,E)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}class Ai extends sc{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Ai(e,t)}_parse(e){const t=this._queryConstraints.map(n=>n._parse(e)).filter(n=>n.getFilters().length>0);return 1===t.length?t[0]:ye.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(i,s){let a=i;const u=s.getFlattenedFilters();for(const l of u)Af(a,l),a=su(a,l)}(e._query,t),new lt(e.firestore,e.converter,su(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class oc extends ys{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new oc(e,t)}_apply(e){const t=function(i,s,a){if(null!==i.startAt)throw new L(D.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==i.endAt)throw new L(D.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new yr(s,a)}(e._query,this._field,this._direction);return new lt(e.firestore,e.converter,function(i,s){const a=i.explicitOrderBy.concat([s]);return new mt(i.path,i.collectionGroup,a,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}}class da extends ys{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new da(e,t,n)}_apply(e){return new lt(e.firestore,e.converter,Vo(e._query,this._limit,this._limitType))}}class fa extends ys{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new fa(e,t,n)}_apply(e){const t=If(e,this.type,this._docOrFields,this._inclusive);return new lt(e.firestore,e.converter,(s=t,new mt((i=e._query).path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)));var i,s}}class ma extends ys{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new ma(e,t,n)}_apply(e){const t=If(e,this.type,this._docOrFields,this._inclusive);return new lt(e.firestore,e.converter,(s=t,new mt((i=e._query).path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)));var i,s}}function If(r,e,t,n){if(t[0]=(0,ee.Ku)(t[0]),t[0]instanceof _s)return function(s,a,u,l,d){if(!l)throw new L(D.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${u}().`);const g=[];for(const y of Jr(s))if(y.field.isKeyField())g.push(nn(a,l.key));else{const E=l.data.field(y.field);if(fr(E))throw new L(D.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+y.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===E){const V=y.field.canonicalString();throw new L(D.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${V}' (used as the orderBy) does not exist.`)}g.push(E)}return new rn(g,d)}(r._query,r.firestore._databaseId,e,t[0]._document,n);{const i=Cr(r.firestore);return function(a,u,l,d,g,y){const E=a.explicitOrderBy;if(g.length>E.length)throw new L(D.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const V=[];for(let F=0;F<g.length;F++){const q=g[F];if(E[F].field.isKeyField()){if("string"!=typeof q)throw new L(D.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a ${typeof q}`);if(!Ir(a)&&-1!==q.indexOf("/"))throw new L(D.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${q}' contains a slash.`);const U=a.path.child(le.fromString(q));if(!K.isDocumentKey(U))throw new L(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${U}' is not because it contains an odd number of segments.`);const H=new K(U);V.push(nn(u,H))}else{const U=gf(l,d,q);V.push(U)}}return new rn(V,y)}(r._query,r.firestore._databaseId,i,e,t,n)}}function Ef(r,e,t){if("string"==typeof(t=(0,ee.Ku)(t))){if(""===t)throw new L(D.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ir(e)&&-1!==t.indexOf("/"))throw new L(D.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);const n=e.path.child(le.fromString(t));if(!K.isDocumentKey(n))throw new L(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return nn(r,new K(n))}if(t instanceof Me)return nn(r,t._key);throw new L(D.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ra(t)}.`)}function vf(r,e){if(!Array.isArray(r)||0===r.length)throw new L(D.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function Af(r,e){const t=function(i,s){for(const a of i)for(const u of a.getFlattenedFilters())if(s.indexOf(u.op)>=0)return u.op;return null}(r.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==t)throw new L(D.INVALID_ARGUMENT,t===e.op?`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`:`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}class ac{convertValue(e,t="none"){switch(en(e)){case 0:return null;case 1:return e.booleanValue;case 2:return xe(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ft(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw $()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Zt(e,(i,s)=>{n[i]=this.convertValue(s,t)}),n}convertVectorValue(e){var t,n,i;const s=null===(i=null===(n=null===(t=e.fields)||void 0===t?void 0:t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===i?void 0:i.map(a=>xe(a.doubleValue));return new oa(s)}convertGeoPoint(e){return new sa(xe(e.latitude),xe(e.longitude))}convertArray(e,t){return(e.values||[]).map(n=>this.convertValue(n,t))}convertServerTimestamp(e,t){switch(t){case"previous":const n=mr(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(zn(e));default:return null}}convertTimestamp(e){const t=zt(e);return new Ve(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=le.fromString(e);X(Dh(n));const i=new _n(n.get(1),n.get(3)),s=new K(n.popFirst(5));return i.isEqual(t)||Ge(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function ga(r,e,t){let n;return n=r?t&&(t.merge||t.mergeFields)?r.toFirestore(e,t):r.toFirestore(e):e,n}class O_ extends ac{constructor(e){super(),this.firestore=e}convertBytes(e){return new ln(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Me(this.firestore,null,t)}}class Nr{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Sn extends _s{constructor(e,t,n,i,s,a){super(e,t,n,i,a),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Is(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(ha("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Is extends Sn{data(e={}){return super.data(e)}}class er{constructor(e,t,n,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new Nr(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new Is(this._firestore,this._userDataWriter,n.key,n,new Nr(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new L(D.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let a=0;return i._snapshot.docChanges.map(u=>({type:"added",doc:new Is(i._firestore,i._userDataWriter,u.doc.key,u.doc,new Nr(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:a++}))}{let a=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(u=>s||3!==u.type).map(u=>{const l=new Is(i._firestore,i._userDataWriter,u.doc.key,u.doc,new Nr(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter);let d=-1,g=-1;return 0!==u.type&&(d=a.indexOf(u.doc.key),a=a.delete(u.doc.key)),1!==u.type&&(a=a.add(u.doc),g=a.indexOf(u.doc.key)),{type:F_(u.type),doc:l,oldIndex:d,newIndex:g}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function F_(r){switch(r){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return $()}}function Rf(r,e){return r instanceof Sn&&e instanceof Sn?r._firestore===e._firestore&&r._key.isEqual(e._key)&&(null===r._document?null===e._document:r._document.isEqual(e._document))&&r._converter===e._converter:r instanceof er&&e instanceof er&&r._firestore===e._firestore&&Xl(r.query,e.query)&&r.metadata.isEqual(e.metadata)&&r._snapshot.isEqual(e._snapshot)}class tr extends ac{constructor(e){super(),this.firestore=e}convertBytes(e){return new ln(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Me(this.firestore,null,t)}}function Pf(r,e,t){r=ce(r,Me);const n=ce(r.firestore,we),i=ga(r.converter,e,t);return wi(n,[ua(Cr(n),"setDoc",r._key,i,null!==r.converter,t).toMutation(r._key,Be.none())])}function Sf(r,e,t,...n){r=ce(r,Me);const i=ce(r.firestore,we),s=Cr(i);let a;return a="string"==typeof(e=(0,ee.Ku)(e))||e instanceof Pn?rc(s,"updateDoc",r._key,e,t,n):nc(s,"updateDoc",r._key,e),wi(i,[a.toMutation(r._key,Be.exists(!0))])}function bf(r,...e){var t,n,i;r=(0,ee.Ku)(r);let s={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof e[a]||Jl(e[a])||(s=e[a],a++);const u={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Jl(e[a])){const y=e[a];e[a]=null===(t=y.next)||void 0===t?void 0:t.bind(y),e[a+1]=null===(n=y.error)||void 0===n?void 0:n.bind(y),e[a+2]=null===(i=y.complete)||void 0===i?void 0:i.bind(y)}let l,d,g;if(r instanceof Me)d=ce(r.firestore,we),g=sn(r._key.path),l={next:y=>{e[a]&&e[a](uc(d,r,y))},error:e[a+1],complete:e[a+2]};else{const y=ce(r,lt);d=ce(y.firestore,we),g=y._query;const E=new tr(d);l={next:V=>{e[a]&&e[a](new er(d,E,y,V))},error:e[a+1],complete:e[a+2]},Tf(r._query)}return function(E,V,F,q){const U=new ea(q),H=new dl(V,U,F);return E.asyncQueue.enqueueAndForget((0,O.A)(function*(){return ol(yield vi(E),H)})),()=>{U.za(),E.asyncQueue.enqueueAndForget((0,O.A)(function*(){return ul(yield vi(E),H)}))}}(qe(d),g,u,l)}function wi(r,e){return function(n,i){const s=new Ke;return n.asyncQueue.enqueueAndForget((0,O.A)(function*(){return function Cp(r,e,t){return Il.apply(this,arguments)}(yield Ql(n),i,s)})),s.promise}(qe(r),e)}function uc(r,e,t){const n=t.docs.get(e._key),i=new tr(r);return new Sn(r,i,e._key,n,new Nr(t.hasPendingWrites,t.fromCache),e.converter)}const ty={maxAttempts:5};class Vf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Cr(e)}set(e,t,n){this._verifyNotCommitted();const i=nr(e,this._firestore),s=ga(i.converter,t,n),a=ua(this._dataReader,"WriteBatch.set",i._key,s,null!==i.converter,n);return this._mutations.push(a.toMutation(i._key,Be.none())),this}update(e,t,n,...i){this._verifyNotCommitted();const s=nr(e,this._firestore);let a;return a="string"==typeof(t=(0,ee.Ku)(t))||t instanceof Pn?rc(this._dataReader,"WriteBatch.update",s._key,t,n,i):nc(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(a.toMutation(s._key,Be.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=nr(e,this._firestore);return this._mutations=this._mutations.concat(new ni(t._key,Be.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new L(D.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function nr(r,e){if((r=(0,ee.Ku)(r)).firestore!==e)throw new L(D.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return r}class ny extends class{constructor(t,n){this._firestore=t,this._transaction=n,this._dataReader=Cr(t)}get(t){const n=nr(t,this._firestore),i=new O_(this._firestore);return this._transaction.lookup([n._key]).then(s=>{if(!s||1!==s.length)return $();const a=s[0];if(a.isFoundDocument())return new _s(this._firestore,i,a.key,a,n.converter);if(a.isNoDocument())return new _s(this._firestore,i,n._key,null,n.converter);throw $()})}set(t,n,i){const s=nr(t,this._firestore),a=ga(s.converter,n,i),u=ua(this._dataReader,"Transaction.set",s._key,a,null!==s.converter,i);return this._transaction.set(s._key,u),this}update(t,n,i,...s){const a=nr(t,this._firestore);let u;return u="string"==typeof(n=(0,ee.Ku)(n))||n instanceof Pn?rc(this._dataReader,"Transaction.update",a._key,n,i,s):nc(this._dataReader,"Transaction.update",a._key,n),this._transaction.update(a._key,u),this}delete(t){const n=nr(t,this._firestore);return this._transaction.delete(n._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=nr(e,this._firestore),n=new tr(this._firestore);return super.get(e).then(i=>new Sn(this._firestore,n,t._key,i._document,new Nr(!1,!1),t.converter))}}function cc(r,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new L("invalid-argument",`Invalid options passed to function ${r}(): You cannot specify both "merge" and "mergeFields".`);return e}function Nf(){if(typeof Uint8Array>"u")throw new L("unimplemented","Uint8Arrays are not available in this environment.")}function kf(){if(!function tu(){return typeof atob<"u"}())throw new L("unimplemented","Blobs are unavailable in Firestore in this environment.")}!function(e,t=!0){dn=Ut.SDK_VERSION,(0,Ut._registerComponent)(new kn.uA("firestore",(n,{instanceIdentifier:i,options:s})=>{const a=n.getProvider("app").getImmediate(),u=new we(new Xs(n.getProvider("auth-internal")),new Ua(n.getProvider("app-check-internal")),function(d,g){if(!Object.prototype.hasOwnProperty.apply(d.options,["projectId"]))throw new L(D.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new _n(d.options.projectId,g)}(a,i),a);return s=Object.assign({useFetchStreams:t},s),u._setSettings(s),u},"PUBLIC").setMultipleInstances(!0)),(0,Ut.registerVersion)(Ws,"4.7.1",e),(0,Ut.registerVersion)(Ws,"4.7.1","esm2017")}();class Es{constructor(e){this._delegate=e}static fromBase64String(e){return kf(),new Es(ln.fromBase64String(e))}static fromUint8Array(e){return Nf(),new Es(ln.fromUint8Array(e))}toBase64(){return kf(),this._delegate.toBase64()}toUint8Array(){return Nf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function hc(r){return function dy(r,e){if("object"!=typeof r||null===r)return!1;const t=r;for(const n of e)if(n in t&&"function"==typeof t[n])return!0;return!1}(r,["next","error","complete"])}class fy{enableIndexedDbPersistence(e,t){return function f_(r,e){hf(r=ce(r,we));const t=qe(r);if(t._uninitializedComponentsProvider)throw new L(D.FAILED_PRECONDITION,"SDK cache is already specified.");ft("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=r._freezeSettings(),i=new Ii;return cf(t,i,new Bl(i,n.cacheSizeBytes,null==e?void 0:e.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function m_(r){hf(r=ce(r,we));const e=qe(r);if(e._uninitializedComponentsProvider)throw new L(D.FAILED_PRECONDITION,"SDK cache is already specified.");ft("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=r._freezeSettings(),n=new Ii;return cf(e,n,new Kd(n,t.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function g_(r){if(r._initialized&&!r._terminated)throw new L(D.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ke;return r._queue.enqueueAndForgetEvenWhileRestricted((0,O.A)(function*(){try{yield(t=(0,O.A)(function*(i){if(!Gt.D())return Promise.resolve();const s=i+"main";yield Gt.delete(s)}),function n(i){return t.apply(this,arguments)})(Vu(r._databaseId,r._persistenceKey)),e.resolve()}catch(t){e.reject(t)}var t})),e.promise}(e._delegate)}}class Of{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof _n||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){const t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&ft("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){!function sf(r,e,t,n={}){var i;const s=(r=ce(r,fs))._getSettings(),a=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&ft("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),r._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),n.mockUserToken){let u,l;if("string"==typeof n.mockUserToken)u=n.mockUserToken,l=ke.MOCK_USER;else{u=(0,ee.Fy)(n.mockUserToken,null===(i=r._app)||void 0===i?void 0:i.options.projectId);const d=n.mockUserToken.sub||n.mockUserToken.user_id;if(!d)throw new L(D.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new ke(d)}r._authCredentials=new Mn(new qt(u,l))}}(this._delegate,e,t,n)}enableNetwork(){return function __(r){return function Yp(r){return r.asyncQueue.enqueue((0,O.A)(function*(){const e=yield $d(r),t=yield Qd(r);return e.setNetworkEnabled(!0),function(i){const s=G(i);return s.L_.delete(0),ds(s)}(t)}))}(qe(r=ce(r,we)))}(this._delegate)}disableNetwork(){return function y_(r){return function Zp(r){return r.asyncQueue.enqueue((0,O.A)(function*(){const e=yield $d(r),t=yield Qd(r);return e.setNetworkEnabled(!1),(n=(0,O.A)(function*(s){const a=G(s);a.L_.add(0),yield hi(a),a.q_.set("Offline")}),function i(s){return n.apply(this,arguments)})(t);var n}))}(qe(r=ce(r,we)))}(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Zd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return function p_(r){return function(t){const n=new Ke;return t.asyncQueue.enqueueAndForget((0,O.A)(function*(){return function Op(r,e){return Rl.apply(this,arguments)}(yield Ql(t),n)})),n.promise}(qe(r=ce(r,we)))}(this._delegate)}onSnapshotsInSync(e){return function $_(r,e){return function r_(r,e){const t=new ea(e);return r.asyncQueue.enqueueAndForget((0,O.A)(function*(){return i=yield vi(r),s=t,G(i).Y_.add(s),void s.next();var i,s})),()=>{t.za(),r.asyncQueue.enqueueAndForget((0,O.A)(function*(){return i=yield vi(r),s=t,void G(i).Y_.delete(s);var i,s}))}}(qe(r=ce(r,we)),Jl(e)?e:{next:e})}(this._delegate,e)}get app(){if(!this._appCompat)throw new L("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Ri(this,af(this._delegate,e))}catch(t){throw Rt(t,"collection()","Firestore.collection()")}}doc(e){try{return new Qt(this,ia(this._delegate,e))}catch(t){throw Rt(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Pt(this,function l_(r,e){if(r=ce(r,fs),Hl("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new L(D.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new lt(r,null,(n=e,new mt(le.emptyPath(),n)));var n}(this._delegate,e))}catch(t){throw Rt(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return function ry(r,e,t){r=ce(r,we);const n=Object.assign(Object.assign({},ty),t);return function(s){if(s.maxAttempts<1)throw new L(D.INVALID_ARGUMENT,"Max attempts must be at least 1")}(n),function(s,a,u){const l=new Ke;return s.asyncQueue.enqueueAndForget((0,O.A)(function*(){const d=yield function Wd(r){return na(r).then(e=>e.datastore)}(s);new Xp(s.asyncQueue,d,u,a,l).ru()})),l.promise}(qe(r),i=>e(new ny(r,i)),n)}(this._delegate,t=>e(new Mf(this,t)))}batch(){return qe(this._delegate),new Ff(new Vf(this._delegate,e=>wi(this._delegate,e)))}loadBundle(e){return function T_(r,e){const t=qe(r=ce(r,we)),n=new h_;return function i_(r,e,t,n){const i=function(a,u){let l;return l="string"==typeof a?dh().encode(a):a,g=function(g,y){if(g instanceof Uint8Array)return zd(g,y);if(g instanceof ArrayBuffer)return zd(new Uint8Array(g),y);if(g instanceof ReadableStream)return g.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(l),new Wp(g,u);var g}(t,hs(e));r.asyncQueue.enqueueAndForget((0,O.A)(function*(){!function $p(r,e,t){const n=G(r);var i;(i=(0,O.A)(function*(a,u,l){try{const d=yield u.getMetadata();if(yield function(F,q){const U=G(F),H=He(q.createTime);return U.persistence.runTransaction("hasNewerBundle","readonly",Z=>U.Gr.getBundleMetadata(Z,q.id)).then(Z=>!!Z&&Z.createTime.compareTo(H)>=0)}(a.localStore,d))return yield u.close(),l._completeWith({taskState:"Success",documentsLoaded:(F=d).totalDocuments,bytesLoaded:F.totalBytes,totalDocuments:F.totalDocuments,totalBytes:F.totalBytes}),Promise.resolve(new Set);l._updateProgress(Nd(d));const g=new Ap(d,a.localStore,u.serializer);let y=yield u.Ua();for(;y;){const V=yield g.la(y);V&&l._updateProgress(V),y=yield u.Ua()}const E=yield g.complete();return yield Rn(a,E.Ia,void 0),yield function(F,q){const U=G(F);return U.persistence.runTransaction("Save bundle","readwrite",H=>U.Gr.saveBundleMetadata(H,q))}(a.localStore,d),l._completeWith(E.progress),Promise.resolve(E.Pa)}catch(d){return ft("SyncEngine",`Loading bundle failed with ${d}`),l._failWith(d),Promise.resolve(new Set)}var F}),function s(a,u,l){return i.apply(this,arguments)})(n,e,t).then(i=>{n.sharedClientState.notifyBundleLoaded(i)})}(yield Ql(r),i,n)}))}(t,r._databaseId,e,n),n}(this._delegate,e)}namedQuery(e){return function I_(r,e){return function s_(r,e){return r.asyncQueue.enqueue((0,O.A)(function*(){return function(n,i){const s=G(n);return s.persistence.runTransaction("Get named query","readonly",a=>s.Gr.getNamedQuery(a,i))}(yield Ei(r),e)}))}(qe(r=ce(r,we)),e).then(t=>t?new lt(r,null,t.query):null)}(this._delegate,e).then(t=>t?new Pt(this,t):null)}}class _a extends ac{constructor(e){super(),this.firestore=e}convertBytes(e){return new Es(new ln(e))}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return Qt.forKey(t,this.firestore,null)}}class Mf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new _a(e)}get(e){const t=Or(e);return this._delegate.get(t).then(n=>new vs(this._firestore,new Sn(this._firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,t.converter)))}set(e,t,n){const i=Or(e);return n?(cc("Transaction.set",n),this._delegate.set(i,t,n)):this._delegate.set(i,t),this}update(e,t,n,...i){const s=Or(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...i),this}delete(e){const t=Or(e);return this._delegate.delete(t),this}}class Ff{constructor(e){this._delegate=e}set(e,t,n){const i=Or(e);return n?(cc("WriteBatch.set",n),this._delegate.set(i,t,n)):this._delegate.set(i,t),this}update(e,t,n,...i){const s=Or(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...i),this}delete(e){const t=Or(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class kr{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){const n=new Is(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new As(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=kr.INSTANCES;let i=n.get(e);i||(i=new WeakMap,n.set(e,i));let s=i.get(t);return s||(s=new kr(e,new _a(e),t),i.set(t,s)),s}}kr.INSTANCES=new WeakMap;class Qt{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new _a(e)}static forPath(e,t,n){if(e.length%2!=0)throw new L("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new Qt(t,new Me(t._delegate,n,new K(e)))}static forKey(e,t,n){return new Qt(t,new Me(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Ri(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Ri(this.firestore,af(this._delegate,e))}catch(t){throw Rt(t,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=(0,ee.Ku)(e))instanceof Me&&uf(this._delegate,e)}set(e,t){t=cc("DocumentReference.set",t);try{return t?Pf(this._delegate,e,t):Pf(this._delegate,e)}catch(n){throw Rt(n,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Sf(this._delegate,e):Sf(this._delegate,e,t,...n)}catch(i){throw Rt(i,"updateDoc()","DocumentReference.update()")}}delete(){return function z_(r){return wi(ce(r.firestore,we),[new ni(r._key,Be.none())])}(this._delegate)}onSnapshot(...e){const t=Lf(e),n=Uf(e,i=>new vs(this.firestore,new Sn(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return bf(this._delegate,t,n)}get(e){let t;return t="cache"===(null==e?void 0:e.source)?function U_(r){r=ce(r,Me);const e=ce(r.firestore,we),t=qe(e),n=new tr(e);return function e_(r,e){const t=new Ke;return r.asyncQueue.enqueueAndForget((0,O.A)(function*(){return(n=(0,O.A)(function*(s,a,u){try{const l=yield function(g,y){const E=G(g);return E.persistence.runTransaction("read document","readonly",V=>E.localDocuments.getDocument(V,y))}(s,a);l.isFoundDocument()?u.resolve(l):l.isNoDocument()?u.resolve(null):u.reject(new L(D.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(l){const d=gi(l,`Failed to get document '${a} from cache`);u.reject(d)}}),function i(s,a,u){return n.apply(this,arguments)})(yield Ei(r),e,t);var n})),t.promise}(t,r._key).then(i=>new Sn(e,n,r._key,i,new Nr(null!==i&&i.hasLocalMutations,!0),r.converter))}(this._delegate):"server"===(null==e?void 0:e.source)?function B_(r){r=ce(r,Me);const e=ce(r.firestore,we);return Hd(qe(e),r._key,{source:"server"}).then(t=>uc(e,r,t))}(this._delegate):function L_(r){r=ce(r,Me);const e=ce(r.firestore,we);return Hd(qe(e),r._key).then(t=>uc(e,r,t))}(this._delegate),t.then(n=>new vs(this.firestore,new Sn(this.firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,this._delegate.converter)))}withConverter(e){return new Qt(this.firestore,this._delegate.withConverter(e?kr.getInstance(this.firestore,e):null))}}function Rt(r,e,t){return r.message=r.message.replace(e,t),r}function Lf(r){for(const e of r)if("object"==typeof e&&!hc(e))return e;return{}}function Uf(r,e){var t,n;let i;return i=hc(r[0])?r[0]:hc(r[1])?r[1]:"function"==typeof r[0]?{next:r[0],error:r[1],complete:r[2]}:{next:r[1],error:r[2],complete:r[3]},{next:s=>{i.next&&i.next(e(s))},error:null===(t=i.error)||void 0===t?void 0:t.bind(i),complete:null===(n=i.complete)||void 0===n?void 0:n.bind(i)}}class vs{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Qt(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Rf(this._delegate,e._delegate)}}class As extends vs{data(e){const t=this._delegate.data(e);return this._delegate._converter||function Fa(r){r||$()}(void 0!==t),t}}class Pt{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new _a(e)}where(e,t,n){try{return new Pt(this.firestore,Zn(this._delegate,function S_(r,e,t){const n=e,i=ha("where",r);return Ts._create(i,n,t)}(e,t,n)))}catch(i){throw Rt(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new Pt(this.firestore,Zn(this._delegate,function b_(r,e="asc"){const t=e,n=ha("orderBy",r);return oc._create(n,t)}(e,t)))}catch(n){throw Rt(n,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new Pt(this.firestore,Zn(this._delegate,function V_(r){return nf("limit",r),da._create("limit",r,"F")}(e)))}catch(t){throw Rt(t,"limit()","Query.limit()")}}limitToLast(e){try{return new Pt(this.firestore,Zn(this._delegate,function x_(r){return nf("limitToLast",r),da._create("limitToLast",r,"L")}(e)))}catch(t){throw Rt(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new Pt(this.firestore,Zn(this._delegate,function C_(...r){return fa._create("startAt",r,!0)}(...e)))}catch(t){throw Rt(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Pt(this.firestore,Zn(this._delegate,function D_(...r){return fa._create("startAfter",r,!1)}(...e)))}catch(t){throw Rt(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Pt(this.firestore,Zn(this._delegate,function N_(...r){return ma._create("endBefore",r,!1)}(...e)))}catch(t){throw Rt(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Pt(this.firestore,Zn(this._delegate,function k_(...r){return ma._create("endAt",r,!0)}(...e)))}catch(t){throw Rt(t,"endAt()","Query.endAt()")}}isEqual(e){return Xl(this._delegate,e._delegate)}get(e){let t;return t="cache"===(null==e?void 0:e.source)?function G_(r){r=ce(r,lt);const e=ce(r.firestore,we),t=qe(e),n=new tr(e);return function t_(r,e){const t=new Ke;return r.asyncQueue.enqueueAndForget((0,O.A)(function*(){return(n=(0,O.A)(function*(s,a,u){try{const l=yield $o(s,a,!0),d=new Md(a,l.Ts),g=d.ma(l.documents),y=d.applyChanges(g,!1);u.resolve(y.snapshot)}catch(l){const d=gi(l,`Failed to execute query '${a} against cache`);u.reject(d)}}),function i(s,a,u){return n.apply(this,arguments)})(yield Ei(r),e,t);var n})),t.promise}(t,r._query).then(i=>new er(e,n,r,i))}(this._delegate):"server"===(null==e?void 0:e.source)?function K_(r){r=ce(r,lt);const e=ce(r.firestore,we),t=qe(e),n=new tr(e);return Xd(t,r._query,{source:"server"}).then(i=>new er(e,n,r,i))}(this._delegate):function q_(r){r=ce(r,lt);const e=ce(r.firestore,we),t=qe(e),n=new tr(e);return Tf(r._query),Xd(t,r._query).then(i=>new er(e,n,r,i))}(this._delegate),t.then(n=>new dc(this.firestore,new er(this.firestore._delegate,this._userDataWriter,this._delegate,n._snapshot)))}onSnapshot(...e){const t=Lf(e),n=Uf(e,i=>new dc(this.firestore,new er(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return bf(this._delegate,t,n)}withConverter(e){return new Pt(this.firestore,this._delegate.withConverter(e?kr.getInstance(this.firestore,e):null))}}class gy{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new As(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class dc{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Pt(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new As(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new gy(this._firestore,t))}forEach(e,t){this._delegate.forEach(n=>{e.call(t,new As(this._firestore,n))})}isEqual(e){return Rf(this._delegate,e._delegate)}}class Ri extends Pt{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){const e=this._delegate.parent;return e?new Qt(this.firestore,e):null}doc(e){try{return new Qt(this.firestore,void 0===e?ia(this._delegate):ia(this._delegate,e))}catch(t){throw Rt(t,"doc()","CollectionReference.doc()")}}add(e){return function j_(r,e){const t=ce(r.firestore,we),n=ia(r),i=ga(r.converter,e);return wi(t,[ua(Cr(r.firestore),"addDoc",n._key,i,null!==r.converter,{}).toMutation(n._key,Be.exists(!1))]).then(()=>n)}(this._delegate,e).then(t=>new Qt(this.firestore,t))}isEqual(e){return uf(this._delegate,e._delegate)}withConverter(e){return new Ri(this.firestore,this._delegate.withConverter(e?kr.getInstance(this.firestore,e):null))}}function Or(r){return ce(r,Me)}class fc{constructor(...e){this._delegate=new Pn(...e)}static documentId(){return new fc(Pe.keyField().canonicalString())}isEqual(e){return(e=(0,ee.Ku)(e))instanceof Pn&&this._delegate._internalPath.isEqual(e._internalPath)}}class Mr{constructor(e){this._delegate=e}static serverTimestamp(){const e=function sy(){return new Yl("serverTimestamp")}();return e._methodName="FieldValue.serverTimestamp",new Mr(e)}static delete(){const e=function iy(){return new gs("deleteField")}();return e._methodName="FieldValue.delete",new Mr(e)}static arrayUnion(...e){const t=function oy(...r){return new Zl("arrayUnion",r)}(...e);return t._methodName="FieldValue.arrayUnion",new Mr(t)}static arrayRemove(...e){const t=function ay(...r){return new ec("arrayRemove",r)}(...e);return t._methodName="FieldValue.arrayRemove",new Mr(t)}static increment(e){const t=function uy(r){return new tc("increment",r)}(e);return t._methodName="FieldValue.increment",new Mr(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}}const py={Firestore:Of,GeoPoint:sa,Timestamp:Ve,Blob:Es,Transaction:Mf,WriteBatch:Ff,DocumentReference:Qt,DocumentSnapshot:vs,Query:Pt,QueryDocumentSnapshot:As,QuerySnapshot:dc,CollectionReference:Ri,FieldPath:fc,FieldValue:Mr,setLogLevel:function my(r){!function ur(r){Ht.setLogLevel(r)}(r)},CACHE_SIZE_UNLIMITED:-1};function Bf(r,e){return function Ty(r,e=Cn.E){return new Dn.c(t=>{let n;return null!=e?e.schedule(()=>{n=r.onSnapshot({includeMetadataChanges:!0},t)}):n=r.onSnapshot({includeMetadataChanges:!0},t),()=>{null!=n&&n()}})}(r,e)}function mc(r,e){return Bf(r,e).pipe((0,ue.T)(t=>({payload:t,type:"query"})))}!function yy(r){(function _y(r,e){r.INTERNAL.registerComponent(new kn.uA("firestore-compat",t=>{const n=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(n,i)},"PUBLIC").setServiceProps(Object.assign({},py)))})(r,(e,t)=>new Of(e,t,new fy)),r.registerVersion("@firebase/firestore-compat","0.3.36")}(At.A),Y(7935);class qf{constructor(e,t){(0,Ne.A)(this,"ref",void 0),(0,Ne.A)(this,"afs",void 0),this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){const n=this.ref.collection(e),{ref:i,query:s}=jf(n,t);return new zf(i,s,this.afs)}snapshotChanges(){return function Iy(r,e){return Bf(r,e).pipe((0,Nn.Z)(void 0),Ee(),(0,ue.T)(t=>{const[n,i]=t;return i.exists?null!=n&&n.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}(this.ref,this.afs.schedulers.outsideAngular).pipe(We.U0)}valueChanges(e={}){return this.snapshotChanges().pipe((0,ue.T)(({payload:t})=>e.idField?{...t.data(),[e.idField]:t.id}:t.data()))}get(e){return(0,dt.H)(this.ref.get(e)).pipe(We.U0)}}function ya(r,e){return mc(r,e).pipe((0,Nn.Z)(void 0),Ee(),(0,ue.T)(t=>{const[n,i]=t,s=i.payload.docChanges(),a=s.map(u=>({type:u.type,payload:u}));return n&&JSON.stringify(n.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((u,l)=>{const d=s.find(y=>y.doc.ref.isEqual(u.ref)),g=null==n?void 0:n.payload.docs.find(y=>y.ref.isEqual(u.ref));d&&JSON.stringify(d.doc.metadata)===JSON.stringify(u.metadata)||!d&&g&&JSON.stringify(g.metadata)===JSON.stringify(u.metadata)||a.push({type:"modified",payload:{oldIndex:l,newIndex:l,type:"modified",doc:u}})}),a}))}function Gf(r,e,t){return ya(r,t).pipe((0,ge.S)((n,i)=>function Ey(r,e,t){return e.forEach(n=>{t.indexOf(n.type)>-1&&(r=function vy(r,e){switch(e.type){case"added":if(!r[e.newIndex]||!r[e.newIndex].doc.ref.isEqual(e.doc.ref))return gc(r,e.newIndex,0,e);break;case"modified":if(null==r[e.oldIndex]||r[e.oldIndex].doc.ref.isEqual(e.doc.ref)){if(e.oldIndex!==e.newIndex){const t=r.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}return gc(r,e.newIndex,1,e)}break;case"removed":if(r[e.oldIndex]&&r[e.oldIndex].doc.ref.isEqual(e.doc.ref))return gc(r,e.oldIndex,1)}return r}(r,n))}),r}(n,i.map(s=>s.payload),e),[]),(0,ve.F)(),(0,ue.T)(n=>n.map(i=>({type:i.type,payload:i}))))}function gc(r,e,t,...n){const i=r.slice();return i.splice(e,t,...n),i}function Kf(r){return(!r||0===r.length)&&(r=["added","removed","modified"]),r}class zf{constructor(e,t,n){(0,Ne.A)(this,"ref",void 0),(0,Ne.A)(this,"query",void 0),(0,Ne.A)(this,"afs",void 0),this.ref=e,this.query=t,this.afs=n}stateChanges(e){let t=ya(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe((0,ue.T)(n=>n.filter(i=>e.indexOf(i.type)>-1)))),t.pipe((0,Nn.Z)(void 0),Ee(),(0,kt.p)(([n,i])=>i.length>0||!n),(0,ue.T)(([,n])=>n),We.U0)}auditTrail(e){return this.stateChanges(e).pipe((0,ge.S)((t,n)=>[...t,...n],[]))}snapshotChanges(e){const t=Kf(e);return Gf(this.query,t,this.afs.schedulers.outsideAngular).pipe(We.U0)}valueChanges(e={}){return mc(this.query,this.afs.schedulers.outsideAngular).pipe((0,ue.T)(t=>t.payload.docs.map(n=>e.idField?{...n.data(),[e.idField]:n.id}:n.data())),We.U0)}get(e){return(0,dt.H)(this.query.get(e)).pipe(We.U0)}add(e){return this.ref.add(e)}doc(e){return new qf(this.ref.doc(e),this.afs)}}class Ay{constructor(e,t){(0,Ne.A)(this,"query",void 0),(0,Ne.A)(this,"afs",void 0),this.query=e,this.afs=t}stateChanges(e){return e&&0!==e.length?ya(this.query,this.afs.schedulers.outsideAngular).pipe((0,ue.T)(t=>t.filter(n=>e.indexOf(n.type)>-1)),(0,kt.p)(t=>t.length>0),We.U0):ya(this.query,this.afs.schedulers.outsideAngular).pipe(We.U0)}auditTrail(e){return this.stateChanges(e).pipe((0,ge.S)((t,n)=>[...t,...n],[]))}snapshotChanges(e){const t=Kf(e);return Gf(this.query,t,this.afs.schedulers.outsideAngular).pipe(We.U0)}valueChanges(e={}){return mc(this.query,this.afs.schedulers.outsideAngular).pipe((0,ue.T)(n=>n.payload.docs.map(i=>e.idField?{[e.idField]:i.id,...i.data()}:i.data())),We.U0)}get(e){return(0,dt.H)(this.query.get(e)).pipe(We.U0)}}const wy=new _e.nKC("angularfire2.enableFirestorePersistence"),Ry=new _e.nKC("angularfire2.firestore.persistenceSettings"),Py=new _e.nKC("angularfire2.firestore.settings"),Sy=new _e.nKC("angularfire2.firestore.use-emulator");function jf(r,e=t=>t){return{query:e(r),ref:r}}let by=(()=>{var r;class e{constructor(n,i,s,a,u,l,d,g,y,E,V,F,q,U,H,Z,J){(0,Ne.A)(this,"schedulers",void 0),(0,Ne.A)(this,"firestore",void 0),(0,Ne.A)(this,"persistenceEnabled$",void 0),this.schedulers=d;const ne=(0,Nt.iB)(n,l,i),de=y;E&&(0,vt.gF)(ne,l,V,q,U,H,F,Z),[this.firestore,this.persistenceEnabled$]=(0,Nt.BM)(`${ne.name}.firestore`,"AngularFirestore",ne.name,()=>{const se=l.runOutsideAngular(()=>ne.firestore());if(a&&se.settings(a),de&&se.useEmulator(...de),s&&!(0,ht.Vy)(u)){const R=()=>{try{return(0,dt.H)(se.enablePersistence(g||void 0).then(()=>!0,()=>!1))}catch(I){return typeof console<"u"&&console.warn(I),(0,cn.of)(!1)}};return[se,l.runOutsideAngular(R)]}return[se,(0,cn.of)(!1)]},[a,de,s])}collection(n,i){let s;s="string"==typeof n?this.firestore.collection(n):n;const{ref:a,query:u}=jf(s,i),l=this.schedulers.ngZone.run(()=>a);return new zf(l,u,this)}collectionGroup(n,i){const s=i||(u=>u),a=this.firestore.collectionGroup(n);return new Ay(s(a),this)}doc(n){let i;i="string"==typeof n?this.firestore.doc(n):n;const s=this.schedulers.ngZone.run(()=>i);return new qf(s,this)}createId(){return this.firestore.collection("_").doc().id}}return r=e,(0,Ne.A)(e,"\u0275fac",function(n){return new(n||r)(_e.KVO(Nt.rx),_e.KVO(Nt.uP,8),_e.KVO(wy,8),_e.KVO(Py,8),_e.KVO(_e.Agw),_e.KVO(_e.SKi),_e.KVO(We.u0),_e.KVO(Ry,8),_e.KVO(Sy,8),_e.KVO(vt.DS,8),_e.KVO(vt.CP,8),_e.KVO(vt.yy,8),_e.KVO(vt.ZP,8),_e.KVO(vt.$z,8),_e.KVO(vt.AU,8),_e.KVO(vt.UB,8),_e.KVO(We.Jv,8))}),(0,Ne.A)(e,"\u0275prov",_e.jDH({token:r,factory:r.\u0275fac,providedIn:"any"})),e})()},1445:(Ma,ar,Y)=>{Y.d(ar,{ap:()=>ye});var Ne=Y(9842),ht=Y(1825),_e=Y(1985),We=Y(7673),Nt=Y(8455),vt=Y(3236),Cn=Y(9974),Dn=Y(4360),cn=Y(6354),Nn=Y(5558),ie=Y(3953),Ae=Y(9253),Ee=Y(3345),ue=Y(467),ge=Y(7852),ve=Y(1076),kt=Y(1362);const Re="firebasestorage.googleapis.com",At="storageBucket";class fe extends ve.g{constructor(h,_,T=0){super(qr(h),`Firebase Storage: ${_} (${qr(h)})`),this.status_=T,this.customData={serverResponse:null},this._baseMessage=this.message,Object.setPrototypeOf(this,fe.prototype)}get status(){return this.status_}set status(h){this.status_=h}_codeEquals(h){return qr(h)===this.code}get serverResponse(){return this.customData.serverResponse}set serverResponse(h){this.customData.serverResponse=h,this.message=this.customData.serverResponse?`${this._baseMessage}\n${this.customData.serverResponse}`:this._baseMessage}}var ee=function(f){return f.UNKNOWN="unknown",f.OBJECT_NOT_FOUND="object-not-found",f.BUCKET_NOT_FOUND="bucket-not-found",f.PROJECT_NOT_FOUND="project-not-found",f.QUOTA_EXCEEDED="quota-exceeded",f.UNAUTHENTICATED="unauthenticated",f.UNAUTHORIZED="unauthorized",f.UNAUTHORIZED_APP="unauthorized-app",f.RETRY_LIMIT_EXCEEDED="retry-limit-exceeded",f.INVALID_CHECKSUM="invalid-checksum",f.CANCELED="canceled",f.INVALID_EVENT_NAME="invalid-event-name",f.INVALID_URL="invalid-url",f.INVALID_DEFAULT_BUCKET="invalid-default-bucket",f.NO_DEFAULT_BUCKET="no-default-bucket",f.CANNOT_SLICE_BLOB="cannot-slice-blob",f.SERVER_FILE_WRONG_SIZE="server-file-wrong-size",f.NO_DOWNLOAD_URL="no-download-url",f.INVALID_ARGUMENT="invalid-argument",f.INVALID_ARGUMENT_COUNT="invalid-argument-count",f.APP_DELETED="app-deleted",f.INVALID_ROOT_OPERATION="invalid-root-operation",f.INVALID_FORMAT="invalid-format",f.INTERNAL_ERROR="internal-error",f.UNSUPPORTED_ENVIRONMENT="unsupported-environment",f}(ee||{});function qr(f){return"storage/"+f}function Gr(){return new fe(ee.UNKNOWN,"An unknown error occurred, please check the error payload for server response.")}function xi(){return new fe(ee.RETRY_LIMIT_EXCEEDED,"Max retry time for operation exceeded, please try again.")}function On(){return new fe(ee.CANCELED,"User canceled the upload/download.")}function Di(){return new fe(ee.CANNOT_SLICE_BLOB,"Cannot slice blob for upload. Please retry the upload.")}function ke(f){return new fe(ee.INVALID_ARGUMENT,f)}function dn(){return new fe(ee.APP_DELETED,"The Firebase app was deleted.")}function Ht(f){return new fe(ee.INVALID_ROOT_OPERATION,"The operation '"+f+"' cannot be performed on a root reference, create a non-root reference using child, such as .child('file.png').")}function Bt(f,h){return new fe(ee.INVALID_FORMAT,"String does not match format '"+f+"': "+h)}function ur(f){throw new fe(ee.INTERNAL_ERROR,"Internal error: "+f)}class M{constructor(h,_){this.bucket=h,this.path_=_}get path(){return this.path_}get isRoot(){return 0===this.path.length}fullServerUrl(){const h=encodeURIComponent;return"/b/"+h(this.bucket)+"/o/"+h(this.path)}bucketOnlyServerUrl(){return"/b/"+encodeURIComponent(this.bucket)+"/o"}static makeFromBucketSpec(h,_){let T;try{T=M.makeFromUrl(h,_)}catch{return new M(h,"")}if(""===T.path)return T;throw function zr(f){return new fe(ee.INVALID_DEFAULT_BUCKET,"Invalid default bucket '"+f+"'.")}(h)}static makeFromUrl(h,_){let T=null;const w="([A-Za-z0-9.\\-_]+)",Q=new RegExp("^gs://"+w+"(/(.*))?$","i");function te(Je){Je.path_=decodeURIComponent(Je.path)}const Le=_.replace(/[.]/g,"\\."),rt=[{regex:Q,indices:{bucket:1,path:3},postModify:function N(Je){"/"===Je.path.charAt(Je.path.length-1)&&(Je.path_=Je.path_.slice(0,-1))}},{regex:new RegExp(`^https?://${Le}/v[A-Za-z0-9_]+/b/${w}/o(/([^?#]*).*)?$`,"i"),indices:{bucket:1,path:3},postModify:te},{regex:new RegExp(`^https?://${_===Re?"(?:storage.googleapis.com|storage.cloud.google.com)":_}/${w}/([^?#]*)`,"i"),indices:{bucket:1,path:2},postModify:te}];for(let Je=0;Je<rt.length;Je++){const mt=rt[Je],En=mt.regex.exec(h);if(En){let $n=En[mt.indices.path];$n||($n=""),T=new M(En[mt.indices.bucket],$n),mt.postModify(T);break}}if(null==T)throw function js(f){return new fe(ee.INVALID_URL,"Invalid URL '"+f+"'.")}(h);return T}}class Ge{constructor(h){this.promise_=Promise.reject(h)}getPromise(){return this.promise_}cancel(h=!1){}}function G(f){return"string"==typeof f||f instanceof String}function D(f){return L()&&f instanceof Blob}function L(){return typeof Blob<"u"}function Ke(f,h,_,T){if(T<h)throw ke(`Invalid value for '${f}'. Expected ${h} or greater.`);if(T>_)throw ke(`Invalid value for '${f}'. Expected ${_} or less.`)}function qt(f,h,_){let T=h;return null==_&&(T=`https://${h}`),`${_}://${T}/v0${f}`}function Hs(f){const h=encodeURIComponent;let _="?";for(const T in f)f.hasOwnProperty(T)&&(_=_+(h(T)+"=")+h(f[T])+"&");return _=_.slice(0,-1),_}var Mn=function(f){return f[f.NO_ERROR=0]="NO_ERROR",f[f.NETWORK_ERROR=1]="NETWORK_ERROR",f[f.ABORT=2]="ABORT",f}(Mn||{});function Xs(f,h){const _=f>=500&&f<600,w=-1!==[408,429].indexOf(f),N=-1!==h.indexOf(f);return _||w||N}class La{constructor(h,_,T,w,N,B,Q,W,te,oe,Le,$e=!0){this.url_=h,this.method_=_,this.headers_=T,this.body_=w,this.successCodes_=N,this.additionalRetryCodes_=B,this.callback_=Q,this.errorCallback_=W,this.timeout_=te,this.progressCallback_=oe,this.connectionFactory_=Le,this.retry=$e,this.pendingConnection_=null,this.backoffId_=null,this.canceled_=!1,this.appDelete_=!1,this.promise_=new Promise((Ue,Se)=>{this.resolve_=Ue,this.reject_=Se,this.start_()})}start_(){const _=(T,w)=>{const N=this.resolve_,B=this.reject_,Q=w.connection;if(w.wasSuccessCode)try{const W=this.callback_(Q,Q.getResponse());!function $(f){return void 0!==f}(W)?N():N(W)}catch(W){B(W)}else if(null!==Q){const W=Gr();W.serverResponse=Q.getErrorText(),B(this.errorCallback_?this.errorCallback_(Q,W):W)}else B(w.canceled?this.appDelete_?dn():On():xi())};this.canceled_?_(0,new jr(!1,null,!0)):this.backoffId_=function ft(f,h,_){let T=1,w=null,N=null,B=!1,Q=0;function W(){return 2===Q}let te=!1;function oe(...De){te||(te=!0,h.apply(null,De))}function Le(De){w=setTimeout(()=>{w=null,f(Ue,W())},De)}function $e(){N&&clearTimeout(N)}function Ue(De,...xt){if(te)return void $e();if(De)return $e(),void oe.call(null,De,...xt);if(W()||B)return $e(),void oe.call(null,De,...xt);let rt;T<64&&(T*=2),1===Q?(Q=2,rt=0):rt=1e3*(T+Math.random()),Le(rt)}let Se=!1;function ze(De){Se||(Se=!0,$e(),!te&&(null!==w?(De||(Q=2),clearTimeout(w),Le(0)):De||(Q=1)))}return Le(0),N=setTimeout(()=>{B=!0,ze(!0)},_),ze}((T,w)=>{if(w)return void T(!1,new jr(!1,null,!0));const N=this.connectionFactory_();this.pendingConnection_=N;const B=Q=>{null!==this.progressCallback_&&this.progressCallback_(Q.loaded,Q.lengthComputable?Q.total:-1)};null!==this.progressCallback_&&N.addUploadProgressListener(B),N.send(this.url_,this.method_,this.body_,this.headers_).then(()=>{null!==this.progressCallback_&&N.removeUploadProgressListener(B),this.pendingConnection_=null;const Q=N.getErrorCode()===Mn.NO_ERROR,W=N.getStatus();if(!Q||Xs(W,this.additionalRetryCodes_)&&this.retry){const oe=N.getErrorCode()===Mn.ABORT;return void T(!1,new jr(!1,null,oe))}const te=-1!==this.successCodes_.indexOf(W);T(!0,new jr(te,N))})},_,this.timeout_)}getPromise(){return this.promise_}cancel(h){this.canceled_=!0,this.appDelete_=h||!1,null!==this.backoffId_&&function Ni(f){f(!1)}(this.backoffId_),null!==this.pendingConnection_&&this.pendingConnection_.abort()}}class jr{constructor(h,_,T){this.wasSuccessCode=h,this.connection=_,this.canceled=!!T}}function Fn(...f){const h=function re(){return typeof BlobBuilder<"u"?BlobBuilder:typeof WebKitBlobBuilder<"u"?WebKitBlobBuilder:void 0}();if(void 0!==h){const _=new h;for(let T=0;T<f.length;T++)_.append(f[T]);return _.getBlob()}if(L())return new Blob(f);throw new fe(ee.UNSUPPORTED_ENVIRONMENT,"This browser doesn't seem to support creating Blobs")}const j={RAW:"raw",BASE64:"base64",BASE64URL:"base64url",DATA_URL:"data_url"};class fn{constructor(h,_){this.data=h,this.contentType=_||null}}function le(f,h){switch(f){case j.RAW:return new fn(eo(h));case j.BASE64:case j.BASE64URL:return new fn(K(f,h));case j.DATA_URL:return new fn(function ki(f){const h=new mn(f);return h.base64?K(j.BASE64,h.rest):function Pe(f){let h;try{h=decodeURIComponent(f)}catch{throw Bt(j.DATA_URL,"Malformed data URL.")}return eo(h)}(h.rest)}(h),function gn(f){return new mn(f).contentType}(h))}throw Gr()}function eo(f){const h=[];for(let _=0;_<f.length;_++){let T=f.charCodeAt(_);T<=127?h.push(T):T<=2047?h.push(192|T>>6,128|63&T):55296==(64512&T)?_<f.length-1&&56320==(64512&f.charCodeAt(_+1))?(T=65536|(1023&T)<<10|1023&f.charCodeAt(++_),h.push(240|T>>18,128|T>>12&63,128|T>>6&63,128|63&T)):h.push(239,191,189):56320==(64512&T)?h.push(239,191,189):h.push(224|T>>12,128|T>>6&63,128|63&T)}return new Uint8Array(h)}function K(f,h){switch(f){case j.BASE64:{const w=-1!==h.indexOf("-"),N=-1!==h.indexOf("_");if(w||N)throw Bt(f,"Invalid character '"+(w?"-":"_")+"' found: is it base64url encoded?");break}case j.BASE64URL:{const w=-1!==h.indexOf("+"),N=-1!==h.indexOf("/");if(w||N)throw Bt(f,"Invalid character '"+(w?"+":"/")+"' found: is it base64 encoded?");h=h.replace(/-/g,"+").replace(/_/g,"/");break}}let _;try{_=function Ve(f){if(typeof atob>"u")throw function Ws(f){return new fe(ee.UNSUPPORTED_ENVIRONMENT,`${f} is missing. Make sure to install the required polyfills. See https://firebase.google.com/docs/web/environments-js-sdk#polyfills for more information.`)}("base-64");return atob(f)}(h)}catch(w){throw w.message.includes("polyfill")?w:Bt(f,"Invalid character found")}const T=new Uint8Array(_.length);for(let w=0;w<_.length;w++)T[w]=_.charCodeAt(w);return T}class mn{constructor(h){this.base64=!1,this.contentType=null;const _=h.match(/^data:([^,]+)?,/);if(null===_)throw Bt(j.DATA_URL,"Must be formatted 'data:[<mediatype>][;base64],<data>");const T=_[1]||null;null!=T&&(this.base64=function qa(f,h){return f.length>=h.length&&f.substring(f.length-h.length)===h}(T,";base64"),this.contentType=this.base64?T.substring(0,T.length-7):T),this.rest=h.substring(h.indexOf(",")+1)}}class it{constructor(h,_){let T=0,w="";D(h)?(this.data_=h,T=h.size,w=h.type):h instanceof ArrayBuffer?(_?this.data_=new Uint8Array(h):(this.data_=new Uint8Array(h.byteLength),this.data_.set(new Uint8Array(h))),T=this.data_.length):h instanceof Uint8Array&&(_?this.data_=h:(this.data_=new Uint8Array(h.length),this.data_.set(h)),T=h.length),this.size_=T,this.type_=w}size(){return this.size_}type(){return this.type_}slice(h,_){if(D(this.data_)){const w=function Zs(f,h,_){return f.webkitSlice?f.webkitSlice(h,_):f.mozSlice?f.mozSlice(h,_):f.slice?f.slice(h,_):null}(this.data_,h,_);return null===w?null:new it(w)}{const T=new Uint8Array(this.data_.buffer,h,_-h);return new it(T,!0)}}static getBlob(...h){if(L()){const _=h.map(T=>T instanceof it?T.data_:T);return new it(Fn.apply(null,_))}{const _=h.map(B=>G(B)?le(j.RAW,B).data:B.data_);let T=0;_.forEach(B=>{T+=B.byteLength});const w=new Uint8Array(T);let N=0;return _.forEach(B=>{for(let Q=0;Q<B.length;Q++)w[N++]=B[Q]}),new it(w,!0)}}uploadData(){return this.data_}}function Oi(f){let h;try{h=JSON.parse(f)}catch{return null}return function Fa(f){return"object"==typeof f&&!Array.isArray(f)}(h)?h:null}function Mi(f){const h=f.lastIndexOf("/",f.length-2);return-1===h?f:f.slice(h+1)}function wt(f,h){return h}class Ze{constructor(h,_,T,w){this.server=h,this.local=_||h,this.writable=!!T,this.xform=w||wt}}let lr=null;function Vt(){if(lr)return lr;const f=[];f.push(new Ze("bucket")),f.push(new Ze("generation")),f.push(new Ze("metageneration")),f.push(new Ze("name","fullPath",!0));const _=new Ze("name");_.xform=function h(N,B){return function no(f){return!G(f)||f.length<2?f:Mi(f)}(B)},f.push(_);const w=new Ze("size");return w.xform=function T(N,B){return void 0!==B?Number(B):B},f.push(w),f.push(new Ze("timeCreated")),f.push(new Ze("updated")),f.push(new Ze("md5Hash",null,!0)),f.push(new Ze("cacheControl",null,!0)),f.push(new Ze("contentDisposition",null,!0)),f.push(new Ze("contentEncoding",null,!0)),f.push(new Ze("contentLanguage",null,!0)),f.push(new Ze("contentType",null,!0)),f.push(new Ze("metadata","customMetadata",!0)),lr=f,lr}function cr(f,h,_){const T=Oi(h);return null===T?null:function b(f,h,_){const T={type:"file"},w=_.length;for(let N=0;N<w;N++){const B=_[N];T[B.local]=B.xform(T,h[B.server])}return function Fi(f,h){Object.defineProperty(f,"ref",{get:function _(){const N=new M(f.bucket,f.fullPath);return h._makeStorageReference(N)}})}(T,f),T}(f,T,_)}function $r(f,h){const _={},T=h.length;for(let w=0;w<T;w++){const N=h[w];N.writable&&(_[N.server]=f[N.local])}return JSON.stringify(_)}const ro="prefixes",Un="items";class st{constructor(h,_,T,w){this.url=h,this.method=_,this.handler=T,this.timeout=w,this.urlParams={},this.headers={},this.body=null,this.errorHandler=null,this.progressCallback=null,this.successCodes=[200],this.additionalRetryCodes=[]}}function Ot(f){if(!f)throw Gr()}function Bn(f,h){return function _(T,w){const N=cr(f,w,h);return Ot(null!==N),N}}function Xe(f){return function h(_,T){let w;return w=401===_.getStatus()?_.getErrorText().includes("Firebase App Check token is invalid")?function Wt(){return new fe(ee.UNAUTHORIZED_APP,"This app does not have permission to access Firebase Storage on this project.")}():function Kr(){return new fe(ee.UNAUTHENTICATED,"User is not authenticated, please authenticate using Firebase Authentication and try again.")}():402===_.getStatus()?function Ks(f){return new fe(ee.QUOTA_EXCEEDED,"Quota for bucket '"+f+"' exceeded, please view quota on https://firebase.google.com/pricing/.")}(f.bucket):403===_.getStatus()?function zs(f){return new fe(ee.UNAUTHORIZED,"User does not have permission to access '"+f+"'.")}(f.path):T,w.status=_.getStatus(),w.serverResponse=T.serverResponse,w}}function Xt(f){const h=Xe(f);return function _(T,w){let N=h(T,w);return 404===T.getStatus()&&(N=function hn(f){return new fe(ee.OBJECT_NOT_FOUND,"Object '"+f+"' does not exist.")}(f.path)),N.serverResponse=w.serverResponse,N}}function qn(f,h,_){const w=qt(h.fullServerUrl(),f.host,f._protocol),B=f.maxOperationRetryTime,Q=new st(w,"GET",Bn(f,_),B);return Q.errorHandler=Xt(h),Q}function io(f,h,_,T,w){const N={};N.prefix=h.isRoot?"":h.path+"/",_&&_.length>0&&(N.delimiter=_),T&&(N.pageToken=T),w&&(N.maxResults=w);const Q=qt(h.bucketOnlyServerUrl(),f.host,f._protocol),te=f.maxOperationRetryTime,oe=new st(Q,"GET",function Ka(f,h){return function _(T,w){const N=function Ga(f,h,_){const T=Oi(_);return null===T?null:function Yt(f,h,_){const T={prefixes:[],items:[],nextPageToken:_.nextPageToken};if(_[ro])for(const w of _[ro]){const N=w.replace(/\/$/,""),B=f._makeStorageReference(new M(h,N));T.prefixes.push(B)}if(_[Un])for(const w of _[Un]){const N=f._makeStorageReference(new M(h,w.name));T.items.push(N)}return T}(f,h,T)}(f,h,w);return Ot(null!==N),N}}(f,h.bucket),te);return oe.urlParams=N,oe.errorHandler=Xe(h),oe}function hr(f,h,_){const T=Object.assign({},_);return T.fullPath=f.path,T.size=h.size(),T.contentType||(T.contentType=function oo(f,h){return f&&f.contentType||h&&h.type()||"application/octet-stream"}(null,h)),T}class Qr{constructor(h,_,T,w){this.current=h,this.total=_,this.finalized=!!T,this.metadata=w||null}}function Ui(f,h){let _=null;try{_=f.getResponseHeader("X-Goog-Upload-Status")}catch{Ot(!1)}return Ot(!!_&&-1!==(h||["active"]).indexOf(_)),_}const Ha={STATE_CHANGED:"state_changed"},at={RUNNING:"running",PAUSED:"paused",SUCCESS:"success",CANCELED:"canceled",ERROR:"error"};function Bi(f){switch(f){case"running":case"pausing":case"canceling":return at.RUNNING;case"paused":return at.PAUSED;case"success":return at.SUCCESS;case"canceled":return at.CANCELED;default:return at.ERROR}}class Xa{constructor(h,_,T){if(function X(f){return"function"==typeof f}(h)||null!=_||null!=T)this.next=h,this.error=null!=_?_:void 0,this.complete=null!=T?T:void 0;else{const N=h;this.next=N.next,this.error=N.error,this.complete=N.complete}}}function Gn(f){return(...h)=>{Promise.resolve().then(()=>f(...h))}}let uo=null;class Ja{constructor(){this.sent_=!1,this.xhr_=new XMLHttpRequest,this.initXhr(),this.errorCode_=Mn.NO_ERROR,this.sendPromise_=new Promise(h=>{this.xhr_.addEventListener("abort",()=>{this.errorCode_=Mn.ABORT,h()}),this.xhr_.addEventListener("error",()=>{this.errorCode_=Mn.NETWORK_ERROR,h()}),this.xhr_.addEventListener("load",()=>{h()})})}send(h,_,T,w){if(this.sent_)throw ur("cannot .send() more than once");if(this.sent_=!0,this.xhr_.open(_,h,!0),void 0!==w)for(const N in w)w.hasOwnProperty(N)&&this.xhr_.setRequestHeader(N,w[N].toString());return void 0!==T?this.xhr_.send(T):this.xhr_.send(),this.sendPromise_}getErrorCode(){if(!this.sent_)throw ur("cannot .getErrorCode() before sending");return this.errorCode_}getStatus(){if(!this.sent_)throw ur("cannot .getStatus() before sending");try{return this.xhr_.status}catch{return-1}}getResponse(){if(!this.sent_)throw ur("cannot .getResponse() before sending");return this.xhr_.response}getErrorText(){if(!this.sent_)throw ur("cannot .getErrorText() before sending");return this.xhr_.statusText}abort(){this.xhr_.abort()}getResponseHeader(h){return this.xhr_.getResponseHeader(h)}addUploadProgressListener(h){null!=this.xhr_.upload&&this.xhr_.upload.addEventListener("progress",h)}removeUploadProgressListener(h){null!=this.xhr_.upload&&this.xhr_.upload.removeEventListener("progress",h)}}class Ya extends Ja{initXhr(){this.xhr_.responseType="text"}}function Mt(){return uo?uo():new Ya}class Wr{constructor(h,_,T=null){this._transferred=0,this._needToFetchStatus=!1,this._needToFetchMetadata=!1,this._observers=[],this._error=void 0,this._uploadUrl=void 0,this._request=void 0,this._chunkMultiplier=1,this._resolve=void 0,this._reject=void 0,this._ref=h,this._blob=_,this._metadata=T,this._mappings=Vt(),this._resumable=this._shouldDoResumable(this._blob),this._state="running",this._errorHandler=w=>{if(this._request=void 0,this._chunkMultiplier=1,w._codeEquals(ee.CANCELED))this._needToFetchStatus=!0,this.completeTransitions_();else{const N=this.isExponentialBackoffExpired();if(Xs(w.status,[])){if(!N)return this.sleepTime=Math.max(2*this.sleepTime,1e3),this._needToFetchStatus=!0,void this.completeTransitions_();w=xi()}this._error=w,this._transition("error")}},this._metadataErrorHandler=w=>{this._request=void 0,w._codeEquals(ee.CANCELED)?this.completeTransitions_():(this._error=w,this._transition("error"))},this.sleepTime=0,this.maxSleepTime=this._ref.storage.maxUploadRetryTime,this._promise=new Promise((w,N)=>{this._resolve=w,this._reject=N,this._start()}),this._promise.then(null,()=>{})}isExponentialBackoffExpired(){return this.sleepTime>this.maxSleepTime}_makeProgressCallback(){const h=this._transferred;return _=>this._updateProgress(h+_)}_shouldDoResumable(h){return h.size()>262144}_start(){"running"===this._state&&void 0===this._request&&(this._resumable?void 0===this._uploadUrl?this._createResumable():this._needToFetchStatus?this._fetchStatus():this._needToFetchMetadata?this._fetchMetadata():this.pendingTimeout=setTimeout(()=>{this.pendingTimeout=void 0,this._continueUpload()},this.sleepTime):this._oneShotUpload())}_resolveToken(h){Promise.all([this._ref.storage._getAuthToken(),this._ref.storage._getAppCheckToken()]).then(([_,T])=>{switch(this._state){case"running":h(_,T);break;case"canceling":this._transition("canceled");break;case"pausing":this._transition("paused")}})}_createResumable(){this._resolveToken((h,_)=>{const T=function $a(f,h,_,T,w){const N=h.bucketOnlyServerUrl(),B=hr(h,T,w),Q={name:B.fullPath},W=qt(N,f.host,f._protocol),oe={"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":`${T.size()}`,"X-Goog-Upload-Header-Content-Type":B.contentType,"Content-Type":"application/json; charset=utf-8"},Le=$r(B,_),Se=new st(W,"POST",function Ue(ze){let De;Ui(ze);try{De=ze.getResponseHeader("X-Goog-Upload-URL")}catch{Ot(!1)}return Ot(G(De)),De},f.maxUploadRetryTime);return Se.urlParams=Q,Se.headers=oe,Se.body=Le,Se.errorHandler=Xe(h),Se}(this._ref.storage,this._ref._location,this._mappings,this._blob,this._metadata),w=this._ref.storage._makeRequest(T,Mt,h,_);this._request=w,w.getPromise().then(N=>{this._request=void 0,this._uploadUrl=N,this._needToFetchStatus=!1,this.completeTransitions_()},this._errorHandler)})}_fetchStatus(){const h=this._uploadUrl;this._resolveToken((_,T)=>{const w=function Qa(f,h,_,T){const W=new st(_,"POST",function N(te){const oe=Ui(te,["active","final"]);let Le=null;try{Le=te.getResponseHeader("X-Goog-Upload-Size-Received")}catch{Ot(!1)}Le||Ot(!1);const $e=Number(Le);return Ot(!isNaN($e)),new Qr($e,T.size(),"final"===oe)},f.maxUploadRetryTime);return W.headers={"X-Goog-Upload-Command":"query"},W.errorHandler=Xe(h),W}(this._ref.storage,this._ref._location,h,this._blob),N=this._ref.storage._makeRequest(w,Mt,_,T);this._request=N,N.getPromise().then(B=>{this._request=void 0,this._updateProgress(B.current),this._needToFetchStatus=!1,B.finalized&&(this._needToFetchMetadata=!0),this.completeTransitions_()},this._errorHandler)})}_continueUpload(){const h=262144*this._chunkMultiplier,_=new Qr(this._transferred,this._blob.size()),T=this._uploadUrl;this._resolveToken((w,N)=>{let B;try{B=function Wa(f,h,_,T,w,N,B,Q){const W=new Qr(0,0);if(B?(W.current=B.current,W.total=B.total):(W.current=0,W.total=T.size()),T.size()!==W.total)throw function $s(){return new fe(ee.SERVER_FILE_WRONG_SIZE,"Server recorded incorrect upload file size, please retry the upload.")}();const te=W.total-W.current;let oe=te;w>0&&(oe=Math.min(oe,w));const Le=W.current;let Ue="";Ue=0===oe?"finalize":te===oe?"upload, finalize":"upload";const Se={"X-Goog-Upload-Command":Ue,"X-Goog-Upload-Offset":`${W.current}`},ze=T.slice(Le,Le+oe);if(null===ze)throw Di();const rt=new st(_,"POST",function De(Je,mt){const En=Ui(Je,["active","final"]),sn=W.current+oe,$n=T.size();let Ir;return Ir="final"===En?Bn(h,N)(Je,mt):null,new Qr(sn,$n,"final"===En,Ir)},h.maxUploadRetryTime);return rt.headers=Se,rt.body=ze.uploadData(),rt.progressCallback=Q||null,rt.errorHandler=Xe(f),rt}(this._ref._location,this._ref.storage,T,this._blob,h,this._mappings,_,this._makeProgressCallback())}catch(W){return this._error=W,void this._transition("error")}const Q=this._ref.storage._makeRequest(B,Mt,w,N,!1);this._request=Q,Q.getPromise().then(W=>{this._increaseMultiplier(),this._request=void 0,this._updateProgress(W.current),W.finalized?(this._metadata=W.metadata,this._transition("success")):this.completeTransitions_()},this._errorHandler)})}_increaseMultiplier(){262144*this._chunkMultiplier*2<33554432&&(this._chunkMultiplier*=2)}_fetchMetadata(){this._resolveToken((h,_)=>{const T=qn(this._ref.storage,this._ref._location,this._mappings),w=this._ref.storage._makeRequest(T,Mt,h,_);this._request=w,w.getPromise().then(N=>{this._request=void 0,this._metadata=N,this._transition("success")},this._metadataErrorHandler)})}_oneShotUpload(){this._resolveToken((h,_)=>{const T=function Li(f,h,_,T,w){const N=h.bucketOnlyServerUrl(),B={"X-Goog-Upload-Protocol":"multipart"},W=function Q(){let rt="";for(let Je=0;Je<2;Je++)rt+=Math.random().toString().slice(2);return rt}();B["Content-Type"]="multipart/related; boundary="+W;const te=hr(h,T,w),oe=$r(te,_),Ue=it.getBlob("--"+W+"\r\nContent-Type: application/json; charset=utf-8\r\n\r\n"+oe+"\r\n--"+W+"\r\nContent-Type: "+te.contentType+"\r\n\r\n",T,"\r\n--"+W+"--");if(null===Ue)throw Di();const Se={name:te.fullPath},ze=qt(N,f.host,f._protocol),xt=f.maxUploadRetryTime,Ct=new st(ze,"POST",Bn(f,_),xt);return Ct.urlParams=Se,Ct.headers=B,Ct.body=Ue.uploadData(),Ct.errorHandler=Xe(h),Ct}(this._ref.storage,this._ref._location,this._mappings,this._blob,this._metadata),w=this._ref.storage._makeRequest(T,Mt,h,_);this._request=w,w.getPromise().then(N=>{this._request=void 0,this._metadata=N,this._updateProgress(this._blob.size()),this._transition("success")},this._errorHandler)})}_updateProgress(h){const _=this._transferred;this._transferred=h,this._transferred!==_&&this._notifyObservers()}_transition(h){if(this._state!==h)switch(h){case"canceling":case"pausing":this._state=h,void 0!==this._request?this._request.cancel():this.pendingTimeout&&(clearTimeout(this.pendingTimeout),this.pendingTimeout=void 0,this.completeTransitions_());break;case"running":const _="paused"===this._state;this._state=h,_&&(this._notifyObservers(),this._start());break;case"paused":case"error":case"success":this._state=h,this._notifyObservers();break;case"canceled":this._error=On(),this._state=h,this._notifyObservers()}}completeTransitions_(){switch(this._state){case"pausing":this._transition("paused");break;case"canceling":this._transition("canceled");break;case"running":this._start()}}get snapshot(){const h=Bi(this._state);return{bytesTransferred:this._transferred,totalBytes:this._blob.size(),state:h,metadata:this._metadata,task:this,ref:this._ref}}on(h,_,T,w){const N=new Xa(_||void 0,T||void 0,w||void 0);return this._addObserver(N),()=>{this._removeObserver(N)}}then(h,_){return this._promise.then(h,_)}catch(h){return this.then(null,h)}_addObserver(h){this._observers.push(h),this._notifyObserver(h)}_removeObserver(h){const _=this._observers.indexOf(h);-1!==_&&this._observers.splice(_,1)}_notifyObservers(){this._finishPromise(),this._observers.slice().forEach(_=>{this._notifyObserver(_)})}_finishPromise(){if(void 0!==this._resolve){let h=!0;switch(Bi(this._state)){case at.SUCCESS:Gn(this._resolve.bind(null,this.snapshot))();break;case at.CANCELED:case at.ERROR:Gn(this._reject.bind(null,this._error))();break;default:h=!1}h&&(this._resolve=void 0,this._reject=void 0)}}_notifyObserver(h){switch(Bi(this._state)){case at.RUNNING:case at.PAUSED:h.next&&Gn(h.next.bind(h,this.snapshot))();break;case at.SUCCESS:h.complete&&Gn(h.complete.bind(h))();break;default:h.error&&Gn(h.error.bind(h,this._error))()}}resume(){const h="paused"===this._state||"pausing"===this._state;return h&&this._transition("running"),h}pause(){const h="running"===this._state;return h&&this._transition("pausing"),h}cancel(){const h="running"===this._state||"pausing"===this._state;return h&&this._transition("canceling"),h}}class pn{constructor(h,_){this._service=h,this._location=_ instanceof M?_:M.makeFromUrl(_,h.host)}toString(){return"gs://"+this._location.bucket+"/"+this._location.path}_newRef(h,_){return new pn(h,_)}get root(){const h=new M(this._location.bucket,"");return this._newRef(this._service,h)}get bucket(){return this._location.bucket}get fullPath(){return this._location.path}get name(){return Mi(this._location.path)}get storage(){return this._service}get parent(){const h=function Ln(f){if(0===f.length)return null;const h=f.lastIndexOf("/");return-1===h?"":f.slice(0,h)}(this._location.path);if(null===h)return null;const _=new M(this._location.bucket,h);return new pn(this._service,_)}_throwIfRoot(h){if(""===this._location.path)throw Ht(h)}}function Gi(f,h,_){return Te.apply(this,arguments)}function Te(){return(Te=(0,ue.A)(function*(f,h,_){const w=yield dr(f,{pageToken:_});h.prefixes.push(...w.prefixes),h.items.push(...w.items),null!=w.nextPageToken&&(yield Gi(f,h,w.nextPageToken))})).apply(this,arguments)}function dr(f,h){null!=h&&"number"==typeof h.maxResults&&Ke("options.maxResults",1,1e3,h.maxResults);const _=h||{},T=io(f.storage,f._location,"/",_.pageToken,_.maxResults);return f.storage.makeRequestWithTokens(T,Mt)}function go(f){f._throwIfRoot("getDownloadURL");const h=function ja(f,h,_){const w=qt(h.fullServerUrl(),f.host,f._protocol),B=f.maxOperationRetryTime,Q=new st(w,"GET",function za(f,h){return function _(T,w){const N=cr(f,w,h);return Ot(null!==N),function Gt(f,h,_,T){const w=Oi(h);if(null===w||!G(w.downloadTokens))return null;const N=w.downloadTokens;if(0===N.length)return null;const B=encodeURIComponent;return N.split(",").map(te=>{const Le=f.fullPath;return qt("/b/"+B(f.bucket)+"/o/"+B(Le),_,T)+Hs({alt:"media",token:te})})[0]}(N,w,f.host,f._protocol)}}(f,_),B);return Q.errorHandler=Xt(h),Q}(f.storage,f._location,Vt());return f.storage.makeRequestWithTokens(h,Mt).then(_=>{if(null===_)throw function Qs(){return new fe(ee.NO_DOWNLOAD_URL,"The given file does not have any download URLs.")}();return _})}function ut(f,h){const _=function to(f,h){const _=h.split("/").filter(T=>T.length>0).join("/");return 0===f.length?_:f+"/"+_}(f._location.path,h),T=new M(f._location.bucket,_);return new pn(f.storage,T)}function Oe(f,h){if(f instanceof Ft){const _=f;if(null==_._bucket)throw function Ci(){return new fe(ee.NO_DEFAULT_BUCKET,"No default bucket found. Did you set the '"+At+"' property when initializing the app?")}();const T=new pn(_,_._bucket);return null!=h?Oe(T,h):T}return void 0!==h?ut(f,h):f}function nu(f,h){if(h&&function po(f){return/^[A-Za-z]+:\/\//.test(f)}(h)){if(f instanceof Ft)return function tu(f,h){return new pn(f,h)}(f,h);throw ke("To use ref(service, url), the first argument must be a Storage instance.")}return Oe(f,h)}function zt(f,h){const _=null==h?void 0:h[At];return null==_?null:M.makeFromBucketSpec(_,f)}class Ft{constructor(h,_,T,w,N){this.app=h,this._authProvider=_,this._appCheckProvider=T,this._url=w,this._firebaseVersion=N,this._bucket=null,this._host=Re,this._protocol="https",this._appId=null,this._deleted=!1,this._maxOperationRetryTime=12e4,this._maxUploadRetryTime=6e5,this._requests=new Set,this._bucket=null!=w?M.makeFromBucketSpec(w,this._host):zt(this._host,this.app.options)}get host(){return this._host}set host(h){this._host=h,this._bucket=null!=this._url?M.makeFromBucketSpec(this._url,h):zt(h,this.app.options)}get maxUploadRetryTime(){return this._maxUploadRetryTime}set maxUploadRetryTime(h){Ke("time",0,Number.POSITIVE_INFINITY,h),this._maxUploadRetryTime=h}get maxOperationRetryTime(){return this._maxOperationRetryTime}set maxOperationRetryTime(h){Ke("time",0,Number.POSITIVE_INFINITY,h),this._maxOperationRetryTime=h}_getAuthToken(){var h=this;return(0,ue.A)(function*(){if(h._overrideAuthToken)return h._overrideAuthToken;const _=h._authProvider.getImmediate({optional:!0});if(_){const T=yield _.getToken();if(null!==T)return T.accessToken}return null})()}_getAppCheckToken(){var h=this;return(0,ue.A)(function*(){const _=h._appCheckProvider.getImmediate({optional:!0});return _?(yield _.getToken()).token:null})()}_delete(){return this._deleted||(this._deleted=!0,this._requests.forEach(h=>h.cancel()),this._requests.clear()),Promise.resolve()}_makeStorageReference(h){return new pn(this,h)}_makeRequest(h,_,T,w,N=!0){if(this._deleted)return new Ge(dn());{const B=function Ys(f,h,_,T,w,N,B=!0){const Q=Hs(f.urlParams),W=f.url+Q,te=Object.assign({},f.headers);return function qc(f,h){h&&(f["X-Firebase-GMPID"]=h)}(te,h),function Js(f,h){null!==h&&h.length>0&&(f.Authorization="Firebase "+h)}(te,_),function Ua(f,h){f["X-Firebase-Storage-Version"]="webjs/"+(null!=h?h:"AppManager")}(te,N),function Ba(f,h){null!==h&&(f["X-Firebase-AppCheck"]=h)}(te,T),new La(W,f.method,te,f.body,f.successCodes,f.additionalRetryCodes,f.handler,f.errorHandler,f.timeout,f.progressCallback,w,B)}(h,this._appId,T,w,_,this._firebaseVersion,N);return this._requests.add(B),B.getPromise().then(()=>this._requests.delete(B),()=>this._requests.delete(B)),B}}makeRequestWithTokens(h,_){var T=this;return(0,ue.A)(function*(){const[w,N]=yield Promise.all([T._getAuthToken(),T._getAppCheckToken()]);return T._makeRequest(h,_,w,N).getPromise()})()}}const fr="@firebase/storage";function Tn(f,h){return nu(f=(0,ve.Ku)(f),h)}function Io(f,{instanceIdentifier:h}){const _=f.getProvider("app").getImmediate(),T=f.getProvider("auth-internal"),w=f.getProvider("app-check-internal");return new Ft(_,T,w,h,ge.SDK_VERSION)}!function Eo(){(0,ge._registerComponent)(new kt.uA("storage",Io,"PUBLIC").setMultipleInstances(!0)),(0,ge.registerVersion)(fr,"0.13.1",""),(0,ge.registerVersion)(fr,"0.13.1","esm2017")}();class In{constructor(h,_,T){this._delegate=h,this.task=_,this.ref=T}get bytesTransferred(){return this._delegate.bytesTransferred}get metadata(){return this._delegate.metadata}get state(){return this._delegate.state}get totalBytes(){return this._delegate.totalBytes}}class pr{constructor(h,_){this._delegate=h,this._ref=_,this.cancel=this._delegate.cancel.bind(this._delegate),this.catch=this._delegate.catch.bind(this._delegate),this.pause=this._delegate.pause.bind(this._delegate),this.resume=this._delegate.resume.bind(this._delegate)}get snapshot(){return new In(this._delegate.snapshot,this,this._ref)}then(h,_){return this._delegate.then(T=>{if(h)return h(new In(T,this,this._ref))},_)}on(h,_,T,w){let N;return _&&(N="function"==typeof _?B=>_(new In(B,this,this._ref)):{next:_.next?B=>_.next(new In(B,this,this._ref)):void 0,complete:_.complete||void 0,error:_.error||void 0}),this._delegate.on(h,N,T||void 0,w||void 0)}}class jn{constructor(h,_){this._delegate=h,this._service=_}get prefixes(){return this._delegate.prefixes.map(h=>new $t(h,this._service))}get items(){return this._delegate.items.map(h=>new $t(h,this._service))}get nextPageToken(){return this._delegate.nextPageToken||null}}class $t{constructor(h,_){this._delegate=h,this.storage=_}get name(){return this._delegate.name}get bucket(){return this._delegate.bucket}get fullPath(){return this._delegate.fullPath}toString(){return this._delegate.toString()}child(h){const _=function Ki(f,h){return ut(f,h)}(this._delegate,h);return new $t(_,this.storage)}get root(){return new $t(this._delegate.root,this.storage)}get parent(){const h=this._delegate.parent;return null==h?null:new $t(h,this.storage)}put(h,_){return this._throwIfRoot("put"),new pr(function Hr(f,h,_){return function fo(f,h,_){return f._throwIfRoot("uploadBytesResumable"),new Wr(f,new it(h),_)}(f=(0,ve.Ku)(f),h,_)}(this._delegate,h,_),this)}putString(h,_=j.RAW,T){this._throwIfRoot("putString");const w=le(_,h),N=Object.assign({},T);return null==N.contentType&&null!=w.contentType&&(N.contentType=w.contentType),new pr(new Wr(this._delegate,new it(w.data,!0),N),this)}listAll(){return function tn(f){return function mo(f){const h={prefixes:[],items:[]};return Gi(f,h).then(()=>h)}(f=(0,ve.Ku)(f))}(this._delegate).then(h=>new jn(h,this.storage))}list(h){return function gr(f,h){return dr(f=(0,ve.Ku)(f),h)}(this._delegate,h||void 0).then(_=>new jn(_,this.storage))}getMetadata(){return function en(f){return function tt(f){f._throwIfRoot("getMetadata");const h=qn(f.storage,f._location,Vt());return f.storage.makeRequestWithTokens(h,Mt)}(f=(0,ve.Ku)(f))}(this._delegate)}updateMetadata(h){return function jt(f,h){return function Ie(f,h){f._throwIfRoot("updateMetadata");const _=function so(f,h,_,T){const N=qt(h.fullServerUrl(),f.host,f._protocol),Q=$r(_,T),te=f.maxOperationRetryTime,oe=new st(N,"PATCH",Bn(f,T),te);return oe.headers={"Content-Type":"application/json; charset=utf-8"},oe.body=Q,oe.errorHandler=Xt(h),oe}(f.storage,f._location,h,Vt());return f.storage.makeRequestWithTokens(_,Mt)}(f=(0,ve.Ku)(f),h)}(this._delegate,h)}getDownloadURL(){return function _o(f){return go(f=(0,ve.Ku)(f))}(this._delegate)}delete(){return this._throwIfRoot("delete"),function yo(f){return function Kn(f){f._throwIfRoot("deleteObject");const h=function Kt(f,h){const T=qt(h.fullServerUrl(),f.host,f._protocol),Q=new st(T,"DELETE",function B(W,te){},f.maxOperationRetryTime);return Q.successCodes=[200,204],Q.errorHandler=Xt(h),Q}(f.storage,f._location);return f.storage.makeRequestWithTokens(h,Mt)}(f=(0,ve.Ku)(f))}(this._delegate)}_throwIfRoot(h){if(""===this._delegate._location.path)throw Ht(h)}}class ji{constructor(h,_){this.app=h,this._delegate=_}get maxOperationRetryTime(){return this._delegate.maxOperationRetryTime}get maxUploadRetryTime(){return this._delegate.maxUploadRetryTime}ref(h){if(vo(h))throw ke("ref() expected a child path but got a URL, use refFromURL instead.");return new $t(Tn(this._delegate,h),this)}refFromURL(h){if(!vo(h))throw ke("refFromURL() expected a full URL but got a child path, use ref() instead.");try{M.makeFromUrl(h,this._delegate.host)}catch{throw ke("refFromUrl() expected a valid full URL but got an invalid one.")}return new $t(Tn(this._delegate,h),this)}setMaxUploadRetryTime(h){this._delegate.maxUploadRetryTime=h}setMaxOperationRetryTime(h){this._delegate.maxOperationRetryTime=h}useEmulator(h,_,T={}){!function nn(f,h,_,T={}){!function xe(f,h,_,T={}){f.host=`${h}:${_}`,f._protocol="http";const{mockUserToken:w}=T;w&&(f._overrideAuthToken="string"==typeof w?w:(0,ve.Fy)(w,f.app.options.projectId))}(f,h,_,T)}(this._delegate,h,_,T)}}function vo(f){return/^[A-Za-z]+:\/\//.test(f)}function nt(f,{instanceIdentifier:h}){const _=f.getProvider("app-compat").getImmediate(),T=f.getProvider("storage").getImmediate({identifier:h});return new ji(_,T)}function $i(f){const h=function rn(f){return new _e.c(h=>{const _=B=>h.next(B);_(f.snapshot);const N=f.on("state_changed",_);return f.then(B=>{_(B),h.complete()},B=>{_(f.snapshot),(B=>{h.error(B)})(B)}),function(){N()}}).pipe(function dt(f,h=vt.E){return(0,Cn.N)((_,T)=>{let w=null,N=null,B=null;const Q=()=>{if(w){w.unsubscribe(),w=null;const te=N;N=null,T.next(te)}};function W(){const te=B+f,oe=h.now();if(oe<te)return w=this.schedule(void 0,te-oe),void T.add(w);Q()}_.subscribe((0,Dn._)(T,te=>{N=te,B=h.now(),w||(w=h.schedule(W,f),T.add(w))},()=>{Q(),T.complete()},void 0,()=>{N=w=null}))})}(0))}(f);return{task:f,then:f.then.bind(f),catch:f.catch.bind(f),pause:f.pause.bind(f),cancel:f.cancel.bind(f),resume:f.resume.bind(f),snapshotChanges:()=>h,percentageChanges:()=>h.pipe((0,cn.T)(_=>_.bytesTransferred/_.totalBytes*100))}}function _r(f){return{getDownloadURL:()=>(0,We.of)(void 0).pipe(ht.Oe,(0,Nn.n)(()=>f.getDownloadURL()),ht.U0),getMetadata:()=>(0,We.of)(void 0).pipe(ht.Oe,(0,Nn.n)(()=>f.getMetadata()),ht.U0),delete:()=>(0,Nt.H)(f.delete()),child:h=>_r(f.child(h)),updateMetadata:h=>(0,Nt.H)(f.updateMetadata(h)),put:(h,_)=>$i(f.put(h,_)),putString:(h,_,T)=>$i(f.putString(h,_,T)),list:h=>(0,Nt.H)(f.list(h)),listAll:()=>(0,Nt.H)(f.listAll())}}!function Ro(f){const h={TaskState:at,TaskEvent:Ha,StringFormat:j,Storage:ji,Reference:$t};f.INTERNAL.registerComponent(new kt.uA("storage-compat",nt,"PUBLIC").setServiceProps(h).setMultipleInstances(!0)),f.registerVersion("@firebase/storage-compat","0.3.11")}(Ee.A),Y(7935);const yr=new ie.nKC("angularfire2.storageBucket"),iu=new ie.nKC("angularfire2.storage.maxUploadRetryTime"),Po=new ie.nKC("angularfire2.storage.maxOperationRetryTime"),he=new ie.nKC("angularfire2.storage.use-emulator");let ye=(()=>{var f;class h{constructor(T,w,N,B,Q,W,te,oe,Le,$e){(0,Ne.A)(this,"storage",void 0);const Ue=(0,Ae.iB)(T,Q,w);this.storage=(0,Ae.BM)(`${Ue.name}.storage.${N}`,"AngularFireStorage",Ue.name,()=>{const Se=Q.runOutsideAngular(()=>Ue.storage(N||void 0)),ze=Le;return ze&&Se.useEmulator(...ze),te&&Se.setMaxUploadRetryTime(te),oe&&Se.setMaxOperationRetryTime(oe),Se},[te,oe])}ref(T){return _r(this.storage.ref(T))}refFromURL(T){return _r(this.storage.refFromURL(T))}upload(T,w,N){return _r(this.storage.ref(T)).put(w,N)}}return f=h,(0,Ne.A)(h,"\u0275fac",function(T){return new(T||f)(ie.KVO(Ae.rx),ie.KVO(Ae.uP,8),ie.KVO(yr,8),ie.KVO(ie.Agw),ie.KVO(ie.SKi),ie.KVO(ht.u0),ie.KVO(iu,8),ie.KVO(Po,8),ie.KVO(he,8),ie.KVO(ht.Jv,8))}),(0,Ne.A)(h,"\u0275prov",ie.jDH({token:f,factory:f.\u0275fac,providedIn:"any"})),h})()}}]);